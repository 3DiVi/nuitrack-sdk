<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>Nuitrack: Creating a 3D Point Cloud</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen_html_style.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="nuitrack.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Nuitrack
   &#160;<span id="projectnumber">1.4.1</span>
   </div>
   <div id="projectbrief">3D Skeleton Tracking Middleware</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('UnityPointCloud_page.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Properties</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Events</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(11)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Creating a 3D Point Cloud </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#point_cloud_environment">Setting Up the Environment</a></li>
<li class="level1"><a href="#depth_color_visualization">Depth and Color Visualization</a></li>
<li class="level1"><a href="#point_cloud_creation">Creating a Point Cloud</a></li>
</ul>
</div>
<div class="textblock"><p>In this tutorial, you'll learn how to create a point cloud in the Unity editor. To do this, you'll need a sensor (ideally, with an RGB camera) and <b>Nuitrack SDK</b>, as well as a mobile device (optional). The point cloud may be used in many fields, such as 3D modeling, 3D gaming, VR apps, etc. The point cloud is created using the color and depth data received from the sensor.</p>
<p>To create this project, you'll need just a couple of things: </p>
<ul>
<li>
Nuitrack Runtime and Nuitrack SDK </li>
<li>
Any supported sensor (see the complete list at <a href="https://nuitrack.com/">Nuitrack website</a>) </li>
<li>
Unity 2017.4 or higher </li>
</ul>
<p>You can find the finished project in <b>Nuitrack SDK</b>: <b>Unity 3D → NuitrackSDK.unitypackage → Tutorials → Point Cloud</b></p>
<div class="image">
<img src="Upoints_7.gif" alt="Upoints_7.gif"/>
</div>
 <h1><a class="anchor" id="point_cloud_environment"></a>
Setting Up the Environment</h1>
<ol>
<li>
Create a new Scene in Unity: <b>File → New Scene</b> </li>
<li>
In the scene, create 2 squares: <b>GameObject → 3D Object → Quad</b> (x2). We will use them as planes to display the color and depth received from the sensor. For convenience, let's name them <b>QuadDepth</b> (for depth) and <b>QuadColor</b> (for color). </li>
<li>
Then, create 2 materials for depth and color respectively: create the <b>Materials</b> folder in the <b>Assets</b> folder, then, in the <b>Project</b> tab: <b>RC → Create → Material</b>. For convenience, let's name the materials <b>ColorMaterial</b> and <b>DepthMaterial</b>. </li>
<li>
<p class="startli">Download <a href="http://download.3divi.com/Nuitrack/platforms/">Nuitrack SDK</a>. Import the <b>Nuitrack</b> and <b>Plugins</b> folders from the <b>Nuitrack.unitypackage</b> to the project. Drag-and-drop the <b>NuitrackScripts</b> prefab from the <b>Nuitrack/Prefabs</b> folder to the scene. In Unity, select the <b>Inspector</b> tab → <b>Nuitrack Manager</b> and tick two modules: <b>Color Module On</b> and <b>Depth Module On</b>. As you can see, these Nuitrack modules provide access to the sensor depth and color data. Other Nuitrack modules are not required for this project.</p>
<div class="image">
<img src="Upoints_1.png" alt="Upoints_1.png"/>
<div class="caption">
Tick the required modules in the Nuitrack Manager.</div></div>
 <p class="endli"></p>
</li>
<li>
Create an empty object and name it <b>Visualization</b>. We'll use this object to visualize depth and color. </li>
<li>
Untick this object. In the <b>NuitrackManager</b>, select ' + ' in the <b>Init Event (NuitrackInitState)</b>. Drag-and-drop the <b>Visualization</b> object to the created field. Select <b>GameObject/SetActive</b> from the drop-down list and tick. This ensures that the visualization starts only after Nuitrack initialization. Now, when our scene is set up, we are ready to move on to some more interesting things, such as actual work with depth and color. </li>
</ol>
<div class="image">
<img src="Upoints_2.png" alt="Upoints_2.png"/>
<div class="caption">
Ticked Visualization Object</div></div>
 <h1><a class="anchor" id="depth_color_visualization"></a>
Depth and Color Visualization</h1>
<ol>
<li>
<p class="startli">Create a new script and name it <b>PointCloud.cs</b>. Drag-and-drop it to the <b>Visualization</b> object. In Unity, let's add some features of our object in the <b>Inspector</b> tab (in the <b>Point Cloud (Script)</b> section). We need to: </p>
<ul>
<li>
specify the two materials that we've just created, </li>
<li>
specify the resolution of the window, in which the point cloud will be displayed, </li>
<li>
set the default color that will be used for coloring the point cloud if the sensor doesn't have an RGB camera. </li>
</ul>
<div class="image">
<img src="Upoints_3.png" alt="Upoints_3.png"/>
<div class="caption">
Characteristics of the Point Cloud object</div></div>
 <p class="endli"></p>
</li>
<li>
<p class="startli">In the <em>PointCloud : MonoBehaviour</em> class, create the fields for displaying depth and color. Then, create the variables that will store the depth and color values:</p>
<div class="fragment"><div class="line"><span class="keyword">public</span> <span class="keyword">class </span>PointCloud : MonoBehaviour</div>
<div class="line">{</div>
<div class="line">    [SerializeField] Material depthMat, colorMat;</div>
<div class="line"> </div>
<div class="line">    nuitrack.DepthFrame depthFrame = null;</div>
<div class="line">    nuitrack.ColorFrame colorFrame = null;</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">Create a field for resolution (which is determined by height; the width is determined automatically). Also, define the pixel size (<em>frameStep</em>):</p>
<div class="fragment"><div class="line">...</div>
<div class="line">[SerializeField] <span class="keywordtype">int</span> hRes;</div>
<div class="line"><span class="keywordtype">int</span> frameStep;</div>
<div class="line">...</div>
</div><!-- fragment --><dl class="section note"><dt>Note</dt><dd>Recommended image resolution: 128х96. You can set a higher resolution if you want. However, in this case Unity may run slower if your computer is not so powerful.</dd></dl>
</li>
<li>
<p class="startli">Set the default color (that will be used for coloring the cubes if the sensor doesn't have an RGB camera).</p>
<div class="fragment"><div class="line">...</div>
<div class="line">[SerializeField] Color defaultColor;</div>
<div class="line">...</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">Set the texture for two created planes. Then, create an array with depths and an array with colors to store the data received from the sensor.</p>
<div class="fragment"><div class="line">... </div>
<div class="line">Texture2D depthTexture, rgbTexture;</div>
<div class="line">Color[] depthColors; <span class="comment">// Array with depths</span></div>
<div class="line">Color[] rgbColors; <span class="comment">// Array with colors</span></div>
<div class="line">...</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">Create a variable that defines initialization (after initialization, the value is changed to <em>true</em>):</p>
<div class="fragment"><div class="line">...          </div>
<div class="line"><span class="keywordtype">bool</span> initialized = <span class="keyword">false</span>;</div>
<div class="line">...</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">Initialize visualization:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> Start()</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (!initialized) Initialize();</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">In the <em>void Initialize()</em> method, use the <em><a class="el" href="structnuitrack_1_1OutputMode.html" title="Stores the sensor data properties. ">nuitrack.OutputMode</a> mode = NuitrackManager.DepthSensor.GetOutputMode()</em> method to get the struct with resolution, FPS and FOV of the sensor. Check that <em>frameStep</em> &gt; 0. The greater the <em>frameStep</em> value, the better the image quality but slower performance. Then, create mesh (cube) instances:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> Initialize()</div>
<div class="line">{</div>
<div class="line">    initialized = <span class="keyword">true</span>;</div>
<div class="line"> </div>
<div class="line">    nuitrack.OutputMode mode = NuitrackManager.DepthSensor.GetOutputMode(); <span class="comment">// Return the struct with resolution, FPS and FOV of the sensor</span></div>
<div class="line">    frameStep = mode.XRes / hRes;</div>
<div class="line">    <span class="keywordflow">if</span> (frameStep &lt;= 0) frameStep = 1; <span class="comment">// frameStep must be &gt; 0</span></div>
<div class="line">    hRes = mode.XRes / frameStep;</div>
<div class="line">    <span class="comment">// Define height and width, create mesh (cube) instances</span></div>
<div class="line">    InitMeshes(</div>
<div class="line">    ((mode.XRes / frameStep) ), <span class="comment">// Width</span></div>
<div class="line">    ((mode.YRes / frameStep) ),  <span class="comment">// Height</span></div>
<div class="line">    mode.HFOV);</div>
<div class="line">}</div>
</div><!-- fragment --><p>You may wonder why do we have to set the <em>if (frameStep &lt;= 0) frameStep = 1</em> condition. The point is that when <em>frameStep</em> is a fractional number less than one, the value is rounded to zero (since <em>frameStep</em> is integer). In this case, Unity or a mobile device crashes because there are expressions in the script with division by <em>frameStep</em> - so, an attempt of division by zero may may happen. You may get a fractional number less than zero in case your sensor resolution is less than the resolution set in Unity (for example, the sensor resolution is 80x60 and the resolution in Unity is 128x96).</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">Using the <em>void InitMeshes</em> method, create textures, apply them to the materials and set the size of the arrays:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> InitMeshes(<span class="keywordtype">int</span> cols, <span class="keywordtype">int</span> rows, <span class="keywordtype">float</span> hfov)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Set the size of the arrays</span></div>
<div class="line">    depthColors = <span class="keyword">new</span> Color[cols * rows];</div>
<div class="line">    rgbColors = <span class="keyword">new</span> Color[cols * rows];</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Create a depth texture</span></div>
<div class="line">    depthTexture = <span class="keyword">new</span> Texture2D(cols, rows, TextureFormat.RFloat, <span class="keyword">false</span>);</div>
<div class="line">    depthTexture.filterMode = FilterMode.Point;</div>
<div class="line">    depthTexture.wrapMode = TextureWrapMode.Clamp;</div>
<div class="line">    depthTexture.Apply();</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Create an RGB texture</span></div>
<div class="line">    rgbTexture = <span class="keyword">new</span> Texture2D(cols, rows, TextureFormat.ARGB32, <span class="keyword">false</span>);</div>
<div class="line">    rgbTexture.filterMode = FilterMode.Point;</div>
<div class="line">    rgbTexture.wrapMode = TextureWrapMode.Clamp;</div>
<div class="line">    rgbTexture.Apply();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">//Applying textures to the materials</span></div>
<div class="line">    depthMat.mainTexture = depthTexture;</div>
<div class="line">    colorMat.mainTexture = rgbTexture;</div>
<div class="line">}</div>
</div><!-- fragment --><dl class="section note"><dt>Note</dt><dd>We recommend you to use the following sensors for better quality of your point cloud: <a href="https://tvico.io/">TVico</a>, Asus Xtion Pro, Orbbec Persee, Intel RealSense D415/D435.</dd></dl>
</li>
<li>
<p class="startli">In the <em>void Update()</em> method, check for new frames:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> Update()</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">bool</span> haveNewFrame = <span class="keyword">false</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> ((NuitrackManager.DepthFrame != null))</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">if</span> (depthFrame != null)</div>
<div class="line">        {</div>
<div class="line">            haveNewFrame = (depthFrame != NuitrackManager.DepthFrame);</div>
<div class="line">        }</div>
<div class="line">        depthFrame = NuitrackManager.DepthFrame;</div>
<div class="line">        colorFrame = NuitrackManager.ColorFrame;</div>
<div class="line">        <span class="keywordflow">if</span> (haveNewFrame) ProcessFrame(depthFrame, colorFrame);</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><dl class="section note"><dt>Note</dt><dd>You can also request new depth and color frames by subscribing to events <b>NuitrackManager.onColorUpdate</b> (to receive color frames) and <b>NuitrackManager.onDepthUpdate</b> (to receive depth frames).</dd></dl>
</li>
<li>
<p class="startli">If new frames are received, process them:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> ProcessFrame(nuitrack.DepthFrame depthFrame, nuitrack.ColorFrame colorFrame)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> pointIndex = 0;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; depthFrame.Rows; i += frameStep)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j &lt; depthFrame.Cols; j += frameStep)</div>
<div class="line">        {</div>
<div class="line">            <span class="comment">// Take the frame depths and include it in the depthColors array</span></div>
<div class="line">            depthColors[pointIndex].r = depthFrame[i, j] / 16384f;</div>
<div class="line"> </div>
<div class="line">            <span class="comment">// Take the frame RGB colors and include it in the rgbColors array</span></div>
<div class="line">            <span class="comment">// If the camera colors are not received, the default color is applied</span></div>
<div class="line">            Color rgbCol = defaultColor;</div>
<div class="line">            <span class="keywordflow">if</span> (colorFrame != null)</div>
<div class="line">            rgbCol = <span class="keyword">new</span> Color32(colorFrame[i, j].Red, colorFrame[i, j].Green, colorFrame[i, j].Blue, 255);</div>
<div class="line">            rgbColors[pointIndex] = rgbCol;</div>
<div class="line"></div>
<div class="line">            ++pointIndex;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p>The <em>depthColors[pointIndex].r = depthFrame[i, j] / 16384f</em> string is responsible for rendering of the depth map. The <em>r</em> parameter can have a value in the range of 0 to 1, in turn, the depth can have a value in the range of 0 to 65536. The lower the coefficient, the brighter the depth map is.</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">Color the pixels in the depth and color textures:</p>
<div class="fragment"><div class="line">... </div>
<div class="line">depthTexture.SetPixels(depthColors);</div>
<div class="line">rgbTexture.SetPixels(rgbColors);</div>
<div class="line">...</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">Apply the pixels in the depth and color textures to the <b>Visualization</b> object:</p>
<div class="fragment"><div class="line">... </div>
<div class="line">depthTexture.Apply();</div>
<div class="line">rgbTexture.Apply();</div>
<div class="line">...</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
As a result, you will see two windows: color pixel image on the left and depth map on the right. We'll use them to create our point cloud. </li>
</ol>
<div class="image">
<img src="Upoints_4.gif" alt="Upoints_4.gif"/>
<div class="caption">
Color and depth planes in Unity</div></div>
 <h1><a class="anchor" id="point_cloud_creation"></a>
Creating a Point Cloud</h1>
<p>Now we have all the necessary data to create a point cloud. </p>
<ol>
<li>
In the <b>Hierarchy</b> tab, create a prefab <b>Point: Create → 3DObject → Cube</b>. It will be displayed as a cube. Our point cloud will be formed from these cubes. </li>
<li>
Create a material for the prefab: <b>Project → Create → Material → PointMat</b>. Drag-and-drop the <b>PointMat</b> material to the <b>Point</b> prefab. </li>
<li>
The point cloud will be made of a huge number of cubes that will be in contact and collide with each other. If Unity calculated the collision of all these objects, it would significantly reduce the project performance. To avoid this, let's delete the <b>Box Collider</b> component by clicking on the Gear and selecting <b>Remove Component</b>. </li>
<li>
Drag-and-drop the <b>Point</b> folder to the project folder and remove it from the scene. </li>
<li>
<p class="startli">Okay, time to move back to our script. In the <em>public class PointCloud : MonoBehaviour</em>, create a field for our created <b>Point</b> prefab:</p>
<div class="fragment"><div class="line">...        </div>
<div class="line">[SerializeField] GameObject pointMesh;</div>
<div class="line">...</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">Drag-and-drop the <b>Point</b> prefab from this folder to the <b>Point Mesh</b> field in the <b>Point Cloud</b> component.</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">In the script, create an array with the <b>Points</b> prefabs (cubes):</p>
<div class="fragment"><div class="line">...          </div>
<div class="line">GameObject[] points;</div>
<div class="line">...</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">In the <em>void InitMeshes()</em> method, set the size of the array with the <b>Points</b> prefabs (multiply the number of rows by the number of columns with points):</p>
<div class="fragment"><div class="line">... </div>
<div class="line">points = <span class="keyword">new</span> GameObject[cols * rows];</div>
<div class="line">...</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">In the <em>void InitMeshes</em> method, create instances of the <b>Points</b> (cubes) and include them to the <em>Points</em> array. Set the <b>Visualization</b> as a parent object and the <b>Points</b> prefabs as its children.</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> pointId = 0;</div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; rgbTexture.height; i++)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j &lt; rgbTexture.width; j++)</div>
<div class="line">    {</div>
<div class="line">        points[pointId++] = Instantiate(pointMesh, transform);</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">In the <em>void ProcessFrame</em> method, change the position of the <b>Point</b> (cube) along the Z (depth) axis. In some cases, the sensor can't identify the depth of the point. As a result, the Z coordinate has the value of 0. Let's hide the points with Z=0 for correct display of the image. After that, we change the position and size of the <b>Point</b> (cube).</p>
<div class="fragment"><div class="line">points[pointIndex].GetComponent&lt;Renderer&gt;().material.color = rgbCol;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Change the position of the Point (cube) along the Z axis</span></div>
<div class="line">Vector3 newPos = NuitrackManager.DepthSensor.ConvertProjToRealCoords(j, i, depthFrame[i, j]).ToVector3();</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Hide the Prefabs with the depth = 0</span></div>
<div class="line"><span class="keywordflow">if</span> (depthFrame[i, j] == 0)</div>
<div class="line">points[pointIndex].SetActive(<span class="keyword">false</span>);</div>
<div class="line"><span class="keywordflow">else</span></div>
<div class="line">{</div>
<div class="line">    points[pointIndex].SetActive(<span class="keyword">true</span>);</div>
<div class="line">    points[pointIndex].transform.position = newPos; <span class="comment">// Change the Point position                     </span></div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">If we want out point cloud look realistic when changing the distance in Unity, we need to scale the mesh size, so that the sized of the cubes changes according to the distance. In the <em>public class PointCloud : MonoBehaviour</em>, add the following strings:</p>
<div class="fragment"><div class="line">... </div>
<div class="line">[SerializeField] <span class="keywordtype">float</span> meshScaling = 1f;</div>
<div class="line"><span class="keywordtype">float</span> depthToScale;</div>
<div class="line">...</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">In the <em>void ProcessFrame()</em>, calculate the size of the cubes according to the depth by adding the following strings to the <em>if (depthFrame[i, j] == 0)... else...</em> condition:</p>
<div class="fragment"><div class="line"><span class="keywordflow">else</span>             </div>
<div class="line">... </div>
<div class="line"><span class="keywordtype">float</span> distancePoints = Vector3.Distance(newPos, NuitrackManager.DepthSensor.ConvertProjToRealCoords(j + 1, i, depthFrame[i, j]).ToVector3()); <span class="comment">//Distance between the Points</span></div>
<div class="line">depthToScale = distancePoints * depthFrame.Cols / hRes; <span class="comment">//Calculate the size of the cubes depending on the depth</span></div>
<div class="line">...</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">In the <em>void ProcessFrame()</em> method, change the cube size:</p>
<div class="fragment"><div class="line">...</div>
<div class="line">points[pointIndex].transform.localScale = Vector3.one * meshScaling * depthToScale;</div>
<div class="line">...</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">So, after your project is built, you should see a color point cloud like the animation below. Keep in mind, that the image may me slightly different, depending on the sensor used: colours may be brighter or paler, the deptha map may be more or less detailed. However, in any case, the created point cloud will be accorate enough to be used in your projects.</p>
<div class="image">
<img src="Upoints_5.gif" alt="Upoints_5.gif"/>
<div class="caption">
Created point cloud</div></div>
 <p class="endli"></p>
</li>
<li>
<p class="startli">All right, now that we created the point cloud, it seems kind of flat. To see the actual volume of our point cloud and position of objects in the room, we need to apply the <a href="http://wiki.unity3d.com/index.php?title=MouseOrbitImproved#Code_C.23">MouseOrbitImproved</a> script. Drag-and-drop the script to the camera in Unity. Create an empty object and name it, for example, rotation point. Move the object to x:0 y:0 z:600 (the camera will rotate around this object). In the script settings, specify the object around which the camera (<b>rotation point</b>) will rotate. The settings must be as shown in the picture below.</p>
<div class="image">
<img src="Upoints_6.png" alt="Upoints_6.png"/>
<div class="caption">
Characteristics of the MouseOrbitImproved Script</div></div>
 <p class="endli"></p>
</li>
<li>
When the script is applied, you can see the volume of the objects displayed as a point cloud. Well done! </li>
</ol>
<div class="image">
<img src="Upoints_7.gif" alt="Upoints_7.gif"/>
<div class="caption">
3D Point Cloud after the MouseOrbitImproved script is applied</div></div>
 <p><b>Useful links:</b> </p>
<ul>
<li>
<a href="https://docs.unity3d.com/ScriptReference/Texture2D.html">Learn more about Texture2D</a> </li>
<li>
Learn more about Vector3 <a class="el" href="classnuitrack_1_1DepthSensor.html#a0691fb0ad91cd243840547469283c218" title="Convert real world coordinates to projective coordinates from x, y, z. ">nuitrack.DepthSensor.ConvertRealToProjCoords</a> </li>
<li>
<a href="https://docs.unity3d.com/ScriptReference/Color32.html">Learn more about Color32</a> </li>
</ul>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="UnityTutorials_page.html">Unity Tutorials</a></li>
    <li class="footer">Generated on Thu Aug 22 2019 12:41:45 for Nuitrack by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.6 </li>
  </ul>
</div>
</body>
</html>
