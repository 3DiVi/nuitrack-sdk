<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>Nuitrack: Face Tracking with Nuitrack</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen_html_style.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="nuitrack.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Nuitrack
   &#160;<span id="projectnumber">1.4.1</span>
   </div>
   <div id="projectbrief">3D Skeleton Tracking Middleware</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('UnityFaceTracking_page.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Properties</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Events</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(11)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Face Tracking with Nuitrack </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#ft_setting">Setting Up the Scene</a></li>
<li class="level1"><a href="#ft_creating_faces">Creating the Faces</a></li>
<li class="level1"><a href="#ft_application">Applying the Received Data about Faces</a></li>
</ul>
</div>
<div class="textblock"><p>In this useful tutorial you'll learn how to track and get information about faces with <b>Nuitrack</b>. This feature is available in Nuitrack since version 0.23.3 (upgrade your Nuitrack if you haven't done this yet!). In this project, an RGB image from the sensor is displayed in the background and emojis are shown instead of faces. The way an emoji looks (its gender, age type, emotion) is determined by the parameters received from Nuitrack. Also you can set the desired number of tracked skeletons in this project (up to 6), because more people is more fun! 2D skeleton is displayed on the user's body.<br/>
 <br/>
 To create this wonderful project, only a couple of things are required: </p>
<ul>
<li>
Nuitrack; </li>
<li>
Any supported sensor (see the full list <a href="https://nuitrack.com/">at our website</a>). </li>
<li>
Unity (2017.4 or higher) </li>
</ul>
<p>You can find the finished project in <b>Nuitrack SDK: Unity 3D → NuitrackSDK.unitypackage → Tutorials → FaceTracker</b>.</p>
<div class="image">
<img src="Uface_1.gif" alt="Uface_1.gif"/>
</div>
 <dl class="section note"><dt>Note</dt><dd>Nuitrack displays the info about a face <b>only after the user's skeleton is detected</b>. So, if only your face is visible, Nuitrack won't display the information. If you're only interested in face tracking (without any info about skeletons), you can take a look at <a href="https://facesdk.3divi.com/">3DiVi Face SDK</a>, which is a software for face tracking, detection, and matching. Unlike Nuitrack SDK, <b>3DiVi Face SDK</b> focuses on processing the data about faces and provides more advanced features in this field.</dd></dl>
<h1><a class="anchor" id="ft_setting"></a>
Setting Up the Scene</h1>
<ol>
<li>
Create a new Unity project. </li>
<li>
Import <b>NuitrackSDK.unitypackage</b> from <b>Nuitrack SDK/Unity3D</b> to the project (except for the folder <b>Tutorials/FaceTracker/FinalAssets</b>, because this folder contains the scripts and other files that we're going to create in this tutorial): <b>Assets → Import Package → Custom Package...</b> </li>
<li>
<p class="startli">Drag-and-drop the <b>NuitrackScripts</b> prefab for skeleton tracking to the scene. In the <b>NuitrackManager</b> section, tick the required modules: <b>Color Module On</b> (to output an RGB image from a sensor), <b>Skeleton Module On</b> (for skeleton tracking).</p>
<div class="image">
<img src="Uface_2.png" alt="Uface_2.png"/>
</div>
 <p class="endli"></p>
</li>
<li>
<p class="startli">Drag-and-drop the <b>Color Frame Canvas</b> prefab to the scene. Please note that in this tutorial we use ready-made prefabs and scripts to output the RGB image from the sensor and display tracked skeletons. If you want to learn how to do this in details, take a look at our <a href="http://download.3divi.com/Nuitrack/doc/UnityRGBandSkeletons_page.html">Displaying Skeletons on an RGB Image</a> tutorial.</p>
<dl class="section note"><dt>Note</dt><dd><b>Color Frame Canvas</b> displays the RGB image from a sensor on the standard interface component <b>Image</b>. The <em>DrawColorFrame</em> script creates a Texture2d in the format of RGB24 using the <em>ColorFrame</em> data. Each time a <em>ColorFrame</em> is received, the texture is updated.</dd></dl>
</li>
<li>
<p class="startli">Drag-and-drop the <b>Skeletons Canvas</b> prefab to the scene. In the <b>Canvas</b> section, set <b>Sort Order = 1</b>, so that skeletons are always displayed over <b>Color Frame Canvas</b>. <b>Sort Order</b> determines the rendering order: <b>Sort Order</b> in <b>Color Frame Canvas</b> is set to the default value of 0, that's why it is used as a background.</p>
<div class="image">
<img src="Uface_3.png" alt="Uface_3.png"/>
</div>
 <dl class="section note"><dt>Note</dt><dd>If your skeleton looks shifted, you have to turn on <b>depth-to-color registration</b> using the <em>nuitrack.config</em> file: find the section <em>“DepthProvider”</em> and set <em>“Depth2ColorRegistration”</em> to <em>true</em>.</dd>
<dd>
In this project, we display a 2D skeleton on the user's body because it's a simpler and more versatile implementation. To display a 3D skeleton, you have to take into account the aspect, position, and FOV of your sensor in the Unity editor.</dd></dl>
</li>
<li>
<p class="startli">Run the project. You should see an RGB image from the sensor on the scene and tracked skeletons displayed on users' bodies. Time to move on to the most interesting part of this tutorial - face tracking!</p>
<div class="image">
<img src="Uface_4.gif" alt="Uface_4.gif"/>
</div>
 <p class="endli"></p>
</li>
</ol>
<h1><a class="anchor" id="ft_creating_faces"></a>
Creating the Faces</h1>
<ol>
<li>
<p class="startli">Create a new script and name it <em>FaceInfo</em>. This script will contain the parameters and values from the JSON response received from Nuitrack (see a sample JSON response <a href="http://download.3divi.com/Nuitrack/doc/Instance_based_API.html">in our documentation</a>).</p>
<dl class="section note"><dt>Note</dt><dd>By default, face tracking in Nuitrack is turned off. To turn on this function, open the <em>nuitrack.config</em> file and set <em>“Faces.ToUse”</em> and <em>“DepthProvider.Depth2ColorRegistration”</em> to <em>true</em>.</dd></dl>
<div class="fragment"><div class="line"><span class="keyword">using</span> UnityEngine;</div>
<div class="line"> </div>
<div class="line">[System.Serializable]</div>
<div class="line"><span class="keyword">public</span> <span class="keyword">class </span>FaceInfo </div>
<div class="line">{</div>
<div class="line">    <span class="keyword">public</span> <span class="keywordtype">string</span> Timestamp;</div>
<div class="line">    <span class="keyword">public</span> Instances[] Instances;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">[System.Serializable]</div>
<div class="line"><span class="keyword">public</span> <span class="keyword">class </span>Instances</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">public</span> <span class="keywordtype">int</span> id;</div>
<div class="line">    <span class="keyword">public</span> <span class="keywordtype">string</span> <span class="keyword">@class</span>;</div>
<div class="line">    <span class="keyword">public</span> Face face;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">[System.Serializable]</div>
<div class="line"><span class="keyword">public</span> <span class="keyword">class </span>Face</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">public</span> Rectangle rectangle;</div>
<div class="line">    <span class="keyword">public</span> Vector2[] landmark;</div>
<div class="line">    <span class="keyword">public</span> Vector2 left_eye;</div>
<div class="line">    <span class="keyword">public</span> Vector2 right_eye;</div>
<div class="line">    <span class="keyword">public</span> Angles angles;</div>
<div class="line">    <span class="keyword">public</span> Emotions emotions;</div>
<div class="line">    <span class="keyword">public</span> Age age;</div>
<div class="line">    <span class="keyword">public</span> <span class="keywordtype">string</span> gender;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">[System.Serializable]</div>
<div class="line"><span class="keyword">public</span> <span class="keyword">class </span>Rectangle</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">public</span> <span class="keywordtype">float</span> left;</div>
<div class="line">    <span class="keyword">public</span> <span class="keywordtype">float</span> top;</div>
<div class="line">    <span class="keyword">public</span> <span class="keywordtype">float</span> width;</div>
<div class="line">    <span class="keyword">public</span> <span class="keywordtype">float</span> height;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">[System.Serializable]</div>
<div class="line"><span class="keyword">public</span> <span class="keyword">class </span>Angles</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">public</span> <span class="keywordtype">float</span> yaw;</div>
<div class="line">    <span class="keyword">public</span> <span class="keywordtype">float</span> pitch;</div>
<div class="line">    <span class="keyword">public</span> <span class="keywordtype">float</span> roll;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">[System.Serializable]</div>
<div class="line"><span class="keyword">public</span> <span class="keyword">class </span>Emotions</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">public</span> <span class="keywordtype">float</span> neutral;</div>
<div class="line">    <span class="keyword">public</span> <span class="keywordtype">float</span> angry;</div>
<div class="line">    <span class="keyword">public</span> <span class="keywordtype">float</span> surprise;</div>
<div class="line">    <span class="keyword">public</span> <span class="keywordtype">float</span> happy;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">[System.Serializable]</div>
<div class="line"><span class="keyword">public</span> <span class="keyword">class </span>Age</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">public</span> <span class="keywordtype">string</span> type;</div>
<div class="line">    <span class="keyword">public</span> <span class="keywordtype">float</span> years;</div>
<div class="line">}</div>
</div><!-- fragment --><dl class="section note"><dt>Note</dt><dd>A keyword cannot be used as an identifier (name of variable, class, interface etc). However, they can be used with the prefix '@'. For example, <em>class</em> is a reserved keyword so it cannot be used as an identifier, but '@'class can be used.</dd></dl>
</li>
<li>
<p class="startli">Create a new script and name it <em>FaceManager</em>. Create enumerators for genders, age types, and emotions and list all possible values.</p>
<div class="fragment"><div class="line"><span class="keyword">using</span> System.Collections.Generic;</div>
<div class="line"><span class="keyword">using</span> UnityEngine;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">public</span> <span class="keyword">enum</span> Gender</div>
<div class="line">{</div>
<div class="line">    any,</div>
<div class="line">    male,</div>
<div class="line">    female</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">public</span> <span class="keyword">enum</span> AgeType</div>
<div class="line">{</div>
<div class="line">    any,</div>
<div class="line">    kid,</div>
<div class="line">    young,</div>
<div class="line">    adult,</div>
<div class="line">    senior</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">public</span> <span class="keyword">enum</span> Emotions</div>
<div class="line">{</div>
<div class="line">    any,</div>
<div class="line">    happy,</div>
<div class="line">    surprise,</div>
<div class="line">    neutral,</div>
<div class="line">    angry</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">Add the <em>canvas</em> field for the <b>Canvas</b> displaying the emojis, <em>faceController</em> field for an emoji prefab, <em>skeletonController</em> field, list of <em>FaceControllers</em>, and an array with the data about faces.</p>
<div class="fragment"><div class="line">...</div>
<div class="line">public <span class="keyword">class </span>FaceManager : MonoBehaviour </div>
<div class="line">{</div>
<div class="line">    [SerializeField] Canvas canvas;</div>
<div class="line">    [SerializeField] GameObject faceController;</div>
<div class="line">    [SerializeField] SkeletonController skeletonController;</div>
<div class="line">    List&lt;FaceController&gt; faceControllers = <span class="keyword">new</span> List&lt;FaceController&gt;();</div>
<div class="line">    Instances[] faces;</div>
<div class="line"> </div>
<div class="line">    FaceInfo faceInfo;    </div>
<div class="line">}</div>
</div><!-- fragment --><dl class="section note"><dt>Note</dt><dd>Here are sample emojis for 2 genders, 4 age types, and 4 emotions (just to let you know how emojis of different ages and genders look like in this project): <ul>
<li>
happy little girl </li>
<li>
surprised young man </li>
<li>
neutral adult woman </li>
<li>
angry old man </li>
</ul>
</dd></dl>
<div class="image">
<img src="Uface_5.png" alt="Uface_5.png"/>
</div>
 <p class="endli"></p>
</li>
<li>
<p class="startli">In <em>Start</em>, add faces to the scene and include them in the list of <em>FaceControllers</em>.</p>
<div class="fragment"><div class="line"><span class="keyword">public</span> <span class="keyword">class </span>FaceManager : MonoBehaviour </div>
<div class="line">{</div>
<div class="line">...</div>
<div class="line">     <span class="keywordtype">void</span> Start()</div>
<div class="line">     {</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; skeletonController.skeletonCount; i++)</div>
<div class="line">        {</div>
<div class="line">                 faceControllers.Add(Instantiate(faceController, canvas.transform).GetComponent&lt;FaceController&gt;());</div>
<div class="line">        }</div>
<div class="line">     }</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">In <em>Update</em>, get a JSON response and include the data from JSON to the <em>faceInfo</em> class, which stores the received face info. Add the faces from <em>faceInfo</em> (<em>faceInfo.Instances</em>) to the <em>faces</em> array. Loop over the <em>FaceControllers</em>: if the face info is available, the emoji is displayed, otherwise, it's hidden. Create the <em>id</em> variable and <em>currentFace</em> variable that stores the info about a current face. Pass the face info to <em>FaceController</em> and display the face. Get the <em>id</em> parameter from the face info and pass it to the <em>id</em> variable. Each of the detected users has his/her own id. User id and skeleton id in Nuitrack are always the same. Create a user's skeleton. If skeleton data from Nuitrack is received, we try to get a skeleton with the same id. If a skeleton is found, create the <em>joint</em> variable and call it <em>head</em>, get the <em>joint head</em> from the skeleton and place it in the coordinates received from the skeleton. An emoji will be displayed in place of the joint head.</p>
<div class="fragment"><div class="line"><span class="keyword">public</span> <span class="keyword">class </span>FaceManager : MonoBehaviour {</div>
<div class="line">...</div>
<div class="line">void Update () </div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Pass the data from JSON to faceInfo</span></div>
<div class="line">    <span class="keywordtype">string</span> json = nuitrack.Nuitrack.GetInstancesJson();</div>
<div class="line">    <span class="comment">// Replace quotation marks with square brackets to prevent a conversion error </span></div>
<div class="line">    <span class="comment">// in case an array is empty (no info about faces received)</span></div>
<div class="line">    faceInfo = JsonUtility.FromJson&lt;FaceInfo&gt;(json.Replace(<span class="stringliteral">&quot;\&quot;\&quot;&quot;</span>, <span class="stringliteral">&quot;[]&quot;</span>));</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Get all faces (faceInfo.Instances) from FaceInfo</span></div>
<div class="line">    faces = faceInfo.Instances;</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; faceControllers.Count; i++)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">if</span>(faces != null &amp;&amp; i &lt; faces.Length - 1)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordtype">int</span> <span class="keywordtype">id</span> = 0;</div>
<div class="line">            Face currentFace = faces[i].face;</div>
<div class="line"> </div>
<div class="line">            <span class="comment">// Pass face to FaceController</span></div>
<div class="line">            faceControllers[i].SetFace(currentFace);</div>
<div class="line">            faceControllers[i].gameObject.SetActive(<span class="keyword">true</span>);</div>
<div class="line"> </div>
<div class="line">            <span class="comment">// Face ids and skeleton ids are the same</span></div>
<div class="line">            <span class="keywordtype">id</span> = faces[i].id;</div>
<div class="line"> </div>
<div class="line">            nuitrack.Skeleton skeleton = null;</div>
<div class="line">            <span class="keywordflow">if</span> (NuitrackManager.SkeletonData != null)</div>
<div class="line">                skeleton = NuitrackManager.SkeletonData.GetSkeletonByID(<span class="keywordtype">id</span>);</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">if</span>(skeleton != null)</div>
<div class="line">            {</div>
<div class="line">                nuitrack.Joint head = skeleton.GetJoint(nuitrack.JointType.Head);</div>
<div class="line">                faceControllers[i].transform.position = <span class="keyword">new</span> Vector2(head.Proj.X * Screen.width, Screen.height - head.Proj.Y * Screen.height);</div>
<div class="line">                <span class="comment">//stretch the face to fit the rectangle</span></div>
<div class="line">                <span class="keywordflow">if</span>(currentFace.rectangle != null) faceControllers[i].transform.localScale = <span class="keyword">new</span> Vector2(currentFace.rectangle.width * Screen.width, currentFace.rectangle.height * Screen.height);</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">        {</div>
<div class="line">            faceControllers[i].gameObject.SetActive(<span class="keyword">false</span>);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><dl class="section note"><dt>Note</dt><dd>Learn more about <a href="https://docs.unity3d.com/ScriptReference/JsonUtility.html">JsonUtility</a> (utility functions for working with JSON data).</dd></dl>
</li>
<li>
<p class="startli">Create a new script and name it <em>FaceController</em>. Create public fields for gender, emotions, and age, and a text field for age. Age types and emotions are stored in the dictionaries <em>Dictionary&lt;string, AgeType&gt; age</em> and <em>Dictionary&lt;EmotionType, float&gt; emotionDict</em>. You can get "age type" by age name (string), and get "emotion value" (float) by "emotion type".</p>
<div class="fragment"><div class="line">﻿using UnityEngine;</div>
<div class="line"><span class="keyword">using</span> System.Collections.Generic;</div>
<div class="line"><span class="keyword">using</span> System.Linq;</div>
<div class="line"></div>
<div class="line"><span class="keyword">public</span> <span class="keyword">class </span>FaceController : MonoBehaviour </div>
<div class="line">{</div>
<div class="line">    <span class="keyword">public</span> Gender genderType;</div>
<div class="line">    <span class="keyword">public</span> EmotionType emotions;</div>
<div class="line">    <span class="keyword">public</span> AgeType ageType;</div>
<div class="line"></div>
<div class="line">    Dictionary&lt;string, AgeType&gt; age = <span class="keyword">new</span> Dictionary&lt;string, AgeType&gt;()</div>
<div class="line">    {</div>
<div class="line">        { <span class="stringliteral">&quot;kid&quot;</span>, AgeType.kid },</div>
<div class="line">        { <span class="stringliteral">&quot;young&quot;</span>, AgeType.young }</div>
<div class="line">        { <span class="stringliteral">&quot;adult&quot;</span>, AgeType.adult },</div>
<div class="line">        { <span class="stringliteral">&quot;senior&quot;</span>, AgeType.senior },</div>
<div class="line">    };</div>
<div class="line"></div>
<div class="line">    Dictionary&lt;EmotionType, float&gt; emotionDict = <span class="keyword">new</span> Dictionary&lt;EmotionType, float&gt;()</div>
<div class="line">    {</div>
<div class="line">        { EmotionType.happy, 0 },</div>
<div class="line">        { EmotionType.surprise, 0 },</div>
<div class="line">        { EmotionType.neutral, 0 },</div>
<div class="line">        { EmotionType.angry, 0 },</div>
<div class="line">    };</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">The <em>SetFace</em> method takes the <em>Face</em> class from the <em>FaceInfo</em> script that stores all the info about the face. In this method, all characteristics of a particular face are assigned. Assign gender (either male or female). Get the age type by its name. Emotion is defined as follows: the values stored in the dictionare are looped over, and an emotion with the highest value is selected.</p>
<div class="fragment"><div class="line"><span class="keyword">public</span> <span class="keyword">class </span>FaceController : MonoBehaviour </div>
<div class="line">{</div>
<div class="line">...</div>
<div class="line">    <span class="keyword">public</span> <span class="keywordtype">void</span> SetFace(Face newFace)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">//Gender</span></div>
<div class="line">        <span class="keywordflow">if</span> (newFace.gender == <span class="stringliteral">&quot;female&quot;</span>)</div>
<div class="line">            genderType = Gender.female;</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">            genderType = Gender.male;</div>
<div class="line"></div>
<div class="line">        <span class="comment">//Age</span></div>
<div class="line">        <span class="keywordflow">if</span>(newFace.age != null)</div>
<div class="line">            age.TryGetValue(newFace.age.type, out ageType);</div>
<div class="line"></div>
<div class="line">        <span class="comment">//Emotion</span></div>
<div class="line">        <span class="keywordflow">if</span> (newFace.emotions != null)</div>
<div class="line">        {</div>
<div class="line">            emotionDict[EmotionType.happy] = newFace.emotions.happy;</div>
<div class="line">            emotionDict[EmotionType.surprise] = newFace.emotions.surprise;</div>
<div class="line">            emotionDict[EmotionType.neutral] = newFace.emotions.neutral;</div>
<div class="line">            emotionDict[EmotionType.angry] = newFace.emotions.angry;</div>
<div class="line"></div>
<div class="line">            KeyValuePair&lt;EmotionType, float&gt; prevailingEmotion = emotionDict.First();</div>
<div class="line">            <span class="keywordflow">foreach</span> (KeyValuePair&lt;EmotionType, float&gt; emotion <span class="keywordflow">in</span> emotionDict)</div>
<div class="line">            <span class="keywordflow">if</span> (emotion.Value &gt; prevailingEmotion.Value) prevailingEmotion = emotion;</div>
<div class="line"></div>
<div class="line">            emotions = prevailingEmotion.Key;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">In Unity, create an <b>Empty Object</b> and name it <b>FaceManager</b>. Drag-and-drop the <em>FaceManager</em> script to this object. Create a new Canvas, name it Face Canvas, and set the Sort Order to 2. Drag-and-drop <b>Face Canvas</b> to the <b>Canvas</b> field of this object. Drag-and-drop <b>Head</b> (<b>FaceTracker/Prefabs</b>) to the <b>Face Controller</b> field and <b>Skeletons Canvas</b> (from the Scene) to the <b>Skeleton Controller</b> field of this object.</p>
<div class="image">
<img src="Uface_6.png" alt="Uface_6.png"/>
</div>
 <p class="endli"></p>
</li>
<li>
Drag-and-drop the <b>Head</b> prefab to the scene. Drag-and-drop the <em>FaceController</em> script to this prefab and click <b>Apply</b>. Delete the head from the scene. </li>
<li>
Run the project. You should see emojis instead of users' faces but they look exactly the same at the moment (a young happy man is a default emoji) because the received face parameters are not applied to the emojis yet. At this point, emojis move according to users' movements. </li>
</ol>
<div class="image">
<img src="Uface_7.gif" alt="Uface_7.gif"/>
</div>
 <h1><a class="anchor" id="ft_application"></a>
Applying the Received Data about Faces</h1>
<ol>
<li>
<p class="startli">Create a new script and name it <em>FaceSwitcher</em>. It will switch the face parameters in Unity according to the info from JSON. Add the necessary fields (<em>gender, ageType, emotions</em>) and two objects: <em>enabledObject</em>, which is enabled, if all conditions are <em>true</em>, and <em>disabled</em>, if at least one is <em>false</em>, and <em>disabledObject</em>, which operates vice versa. Add the <em>FaceController</em> field and the boolean variable <em>display</em> to display/hide a face.</p>
<div class="fragment"><div class="line"><span class="keyword">using</span> UnityEngine;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">public</span> <span class="keyword">class </span>FaceSwitcher : MonoBehaviour </div>
<div class="line">{</div>
<div class="line">    [SerializeField] Gender gender;</div>
<div class="line">    [SerializeField] AgeType ageType;</div>
<div class="line">    [SerializeField] Emotions emotions;</div>
<div class="line">    [SerializeField] GameObject enabledObject;</div>
<div class="line">    [SerializeField] GameObject disabledObject;</div>
<div class="line"> </div>
<div class="line">    FaceController faceController;</div>
<div class="line">    <span class="keywordtype">bool</span> display = <span class="keyword">false</span>;</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">In <em>Start</em>, find the <em>FaceController</em> component in a parent object and pass it to the <em>faceController</em> variable.</p>
<div class="fragment"><div class="line"><span class="keyword">public</span> <span class="keyword">class </span>FaceSwitcher : MonoBehaviour </div>
<div class="line">{</div>
<div class="line">...</div>
<div class="line">     <span class="keywordtype">void</span> Start () </div>
<div class="line">     {</div>
<div class="line">        faceController = GetComponentInParent&lt;FaceController&gt;();</div>
<div class="line">     }</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">In the <em>SwitchObjects</em> method, enable/disable the corresponding object to display/hide the parameters if they're <em>true/false</em>.</p>
<div class="fragment"><div class="line"><span class="keyword">public</span> <span class="keyword">class </span>FaceSwitcher : MonoBehaviour </div>
<div class="line">{</div>
<div class="line">...</div>
<div class="line">     <span class="keywordtype">void</span> SwitchObjects()</div>
<div class="line">     {</div>
<div class="line">        <span class="keywordflow">if</span> (enabledObject != null)</div>
<div class="line">            enabledObject.SetActive(display);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (disabledObject != null)</div>
<div class="line">            disabledObject.SetActive(!display);</div>
<div class="line">     }</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">In <em>Update</em>, the value of <em>display</em> is changed according to the specified conditions. If all conditions are true (gender, age type, and emotion correspond to the ones specified in Unity), then the <em>enabledObject</em> is displayed. If at least one condition is false, the <em>display</em> becomes <em>false</em> and <em>enabledObject</em> is not displayed.</p>
<div class="fragment"><div class="line"><span class="keyword">public</span> <span class="keyword">class </span>FaceSwitcher : MonoBehaviour </div>
<div class="line">{</div>
<div class="line">...</div>
<div class="line">     <span class="keywordtype">void</span> Update()</div>
<div class="line">     {</div>
<div class="line">        display = (gender == Gender.any ||gender == faceController.genderType) &amp;&amp;</div>
<div class="line">                  (ageType == AgeType.any || ageType == faceController.ageType) &amp;&amp;</div>
<div class="line">                  (emotions == EmotionType.any ||emotions==faceController.emotions);</div>
<div class="line"> </div>
<div class="line">        SwitchObjects();</div>
<div class="line">     }</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">Drag-and-drop the <b>Head</b> prefab to the scene again. Select <b>Head → Face</b>, add the <b>FaceSwitcher</b> component, and select <b>Gender: Male, Age Type: Any, Emotions: Any</b> (they'll be assigned hierarchically). Assign the <b>enabledObject: Male, disabledObject: Female</b>.</p>
<div class="image">
<img src="Uface_8.png" alt="Uface_8.png"/>
</div>
 <p class="endli"></p>
</li>
<li>
<p class="startli">Assign emotions and age types in the relevant fields as shown on the screenshots (you have to add the <b>FaceSwitcher</b> component several times).</p>
<div class="image">
<img src="Uface_9.png" alt="Uface_9.png"/>
</div>
 <p class="endli"></p>
</li>
<li>
Run the project. You should see the tracked skeletons and faces of several users with emojis instead of faces. Different emojis are displayed depending on gender, age type and emotion of a user. </li>
</ol>
<div class="image">
<img src="Uface_1.gif" alt="Uface_1.gif"/>
</div>
 <p>Congratulations, you've just learnt how to use face tracking in your project with Nuitrack! You can use the information in gaming or other fields. By the way, check out other parameters in the <a href="http://download.3divi.com/Nuitrack/doc/Instance_based_API.html">JSON response from Nuitrack</a>, there are far more interesting things besides the ones covered in this tutorial. Have fun! </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="UnityTutorials_page.html">Unity Tutorials</a></li>
    <li class="footer">Generated on Thu Aug 22 2019 12:41:46 for Nuitrack by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.6 </li>
  </ul>
</div>
</body>
</html>
