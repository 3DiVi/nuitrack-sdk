<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>Nuitrack: Creating Animated Emoji with Nuitrack</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen_html_style.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="nuitrack.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Nuitrack
   &#160;<span id="projectnumber">1.4.1</span>
   </div>
   <div id="projectbrief">3D Skeleton Tracking Middleware</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('UnityAnimatedEmoji_page.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Properties</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Events</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(11)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Creating Animated Emoji with Nuitrack </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>In this tutorial you'll learn to create animated emoji using the face info from Nuitrack and blendshapes. You'll be able to track several skeletons (from 1 to 6) and see the fox animated emoji instead of the user's face. Fox face mimics user's facial expressions. When a user turns his/her head, the fox head is also rotated. You can notice that fox fur is slightly moving when the fox turns its face - an incredible thing to watch. The fox face is zoomed in and out, i.e. the closer the user is, the bigger the fox head is, and vice versa.</p>
<p>To create this project, you'll need just a couple of things: </p>
<ul>
<li>
<a href="https://nuitrack.com/#rec54893368">Nuitrack Runtime and Nuitrack SDK</a> </li>
<li>
Unity (2017.4 or higher) </li>
<li>
Any compatible sensor (see the complete list at <a href="https://nuitrack.com/#rec24776680">Nuitrack website</a>) </li>
</ul>
<p>You can find the finished project in <b>Nuitrack SDK: Unity 3D → NuitrackSDK.unitypackage → Tutorials → Animated Emoji </b></p>
<div class="image">
<img src="Uanimoji_1.gif" alt="Uanimoji_1.gif"/>
</div>
 <h1><a class="anchor" id="animoji_settings"></a>
Setting Up the Scene</h1>
<ol>
<li>
Download and import <b>NuitrackSDK.unitypackage</b> from <b>Nuitrack SDK</b> to your project (except for the folder <b>NuitrackSDK/Tutorials/Animated Emoji/Final Assets</b> because it includes ready-made scripts). </li>
<li>
<p class="startli">Drag-and-drop the <b>NuitrackScripts</b> prefab to the scene. Tick the required Nuitrack modules: <b>Color Module On</b> (to output an RGB image from a sensor), <b>Skeleton Tracker Module On</b> (for skeleton tracking).</p>
<div class="image">
<img src="Uanimoji_2.png" alt="Uanimoji_2.png"/>
</div>
 <p class="endli"></p>
</li>
<li>
<p class="startli">Create a new <b>Canvas: Create → UI → Canvas</b>, name it <b>Face Canvas</b>. Set its Sort Order to 2. This canvas is used to display the fox face (over the canvases for outputting RGB and displaying skeletons).</p>
<div class="image">
<img src="Uanimoji_3.png" alt="Uanimoji_3.png"/>
</div>
 <dl class="section note"><dt>Note</dt><dd>In this project, we display the fox face in 2D as the image in this format will be displayed correctly for all supported sensors. If we wanted to create the fox face in 3D, we would need to know which sensor is used and what is its resolution. Nuitrack doesn't provide this information at the moment.</dd></dl>
</li>
<li>
<p class="startli">Create a child object to the <b>Canvas: Create → UI → Raw Image</b>, name it <b>Fox Face</b>. Go to the settings of this object and set <b>Width = 1, Height = 1</b> in the <b>RectTransform</b> section. Set the appropriate <b>Scale</b>, for example: <b>X: 100, Y: 100, Z: 1</b>. This is the image size in pixels, which will soon become the fox face. It's important to keep the 1:1 aspect ratio, otherwise the fox face will be stretched vertically or horizontally. The image size shouldn't be too small, otherwise you won't even see the fox face when you run the project at this stage.</p>
<div class="image">
<img src="Uanimoji_4.png" alt="Uanimoji_4.png"/>
</div>
 <p class="endli"></p>
</li>
<li>
Drag-and-drop the <b>Fox Face Model</b> prefab to the scene (it's located in <b>NuitrackSDK/Tutorials/Animated Emoji/Prefabs</b>). </li>
<li>
Create a new texture in the folder <b>Animated Emoji (Create → Render Texture)</b>, name it <b>Face</b>. This is the texture for rendering the image from the sensor. </li>
<li>
<p class="startli">Go to the settings of the <b>Fox Face</b> object and drag-and-drop the <b>Face</b> texture to the <b>Texture</b> field.</p>
<div class="image">
<img src="Uanimoji_5.png" alt="Uanimoji_5.png"/>
</div>
 <p class="endli"></p>
</li>
<li>
<p class="startli">Go to the settings of the <b>Camera</b> object (which can be found under the ready-made <b>Fox Face Model</b> prefab) and drag-and-drop the <b>Face</b> texture to the <b>Target Texture</b> field.</p>
<div class="image">
<img src="Uanimoji_6.png" alt="Uanimoji_6.png"/>
</div>
 <p class="endli"></p>
</li>
</ol>
<p>Great job! Now we have a 2D fox face that we can further use to mimic our facial expressions.</p>
<div class="image">
<img src="Uanimoji_7.jpg" alt="Uanimoji_7.jpg"/>
</div>
 <h1><a class="anchor" id="animoji_switch"></a>
Switch the User Face with the Fox Face</h1>
<ol>
<li>
Save <b>Fox Face</b> as a prefab. Then, delete the <b>Fox Face</b> and <b>Fox Face Model</b> prefabs from the scene. </li>
<li>
<p class="startli">Create a new script <em>FaceAnimController</em> to manage the fox faces. Add the <em>UnityEngine.UI</em> namespace. Add the necessary fields (their names speak for themselves). The <em>slerpRotation</em> is used to smooth the head rotation (otherwise, the head would jitter when turned). The <em>faceRaw</em> field is used to display the fox face.</p>
<div class="fragment"><div class="line"><span class="keyword">using</span> UnityEngine;</div>
<div class="line"><span class="keyword">using</span> UnityEngine.UI;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">public</span> <span class="keyword">class </span>FaceAnimController : MonoBehaviour</div>
<div class="line">{</div>
<div class="line">    [SerializeField] Transform headModel;</div>
<div class="line">    [SerializeField] Transform headRoot;</div>
<div class="line"> </div>
<div class="line">    [SerializeField] RawImage rawImage;</div>
<div class="line">    [SerializeField] Camera faceCamera;</div>
<div class="line"> </div>
<div class="line">    [SerializeField] SkinnedMeshRenderer faceMeshRenderer;</div>
<div class="line">    [SerializeField] RenderTexture renderTextureSample;</div>
<div class="line">    [SerializeField] <span class="keywordtype">float</span> smoothHeadRotation = 5;</div>
<div class="line"></div>
<div class="line">    RenderTexture renderTexture;</div>
<div class="line"> </div>
<div class="line">    RawImage faceRaw;</div>
<div class="line">}</div>
</div><!-- fragment --><dl class="section note"><dt>Note</dt><dd>Learn more about <a href="https://docs.unity3d.com/Manual/class-RenderTexture.html">Render Texture</a>.</dd></dl>
</li>
<li>
<p class="startli">In the <em>Init</em> method, pass the <em>Canvas</em> to make <em>rawImage</em> the child object and create <em>renderTexture</em> based on the <em>RenderTexture</em>, which we've created in the first section. Pass <em>renderTexture</em> to <em>Camera</em> and to the texture in the <em>rawImage</em> object. Set their position (far away from each other) and stretch the image (our fox face) in screen height. Don't forget to keep the aspect ratio. Spawn the <em>rawImage</em> object.</p>
<div class="fragment"><div class="line"><span class="keyword">public</span> <span class="keyword">class </span>FaceAnimController : MonoBehaviour</div>
<div class="line">{</div>
<div class="line">...</div>
<div class="line">    <span class="keyword">public</span> <span class="keywordtype">void</span> Init(Canvas canvas)</div>
<div class="line">    {</div>
<div class="line">        faceRaw = Instantiate(rawImage, canvas.transform).GetComponent&lt;RawImage&gt;(); <span class="comment">// Spawn RawImage</span></div>
<div class="line">        faceRaw.transform.localScale = Vector2.one * Screen.height;</div>
<div class="line"> </div>
<div class="line">        renderTexture = <span class="keyword">new</span> RenderTexture(renderTextureSample);</div>
<div class="line">        faceCamera.targetTexture = renderTexture;</div>
<div class="line">        faceRaw.texture = renderTexture;</div>
<div class="line">        faceRaw.gameObject.SetActive(<span class="keyword">false</span>);</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">Create the public method <em>UpdateFace</em> and specify the required parameters: the info about a user's face from JSON and head joint. Get the position of the head joint in projective coordinates received from Nuitrack and set the head to these coordinates (multiply X and Y by the width and height of the screen). Change the <em>headRoot</em> position along the Z axis using the info from Nuitrack. This would stand for the face zoom, which depends on the distance between a user and a sensor (the closer the user to the sensor is, the bigger the fox face is).</p>
<div class="fragment"><div class="line"><span class="keyword">public</span> <span class="keyword">class </span>FaceAnimController : MonoBehaviour</div>
<div class="line">{</div>
<div class="line">...</div>
<div class="line">    <span class="keyword">public</span> <span class="keywordtype">void</span> UpdateFace(Instances instance, nuitrack.Joint headJoint)</div>
<div class="line">    {</div>
<div class="line">        Vector3 headProjPosition = headJoint.Proj.ToVector3();</div>
<div class="line">        faceRaw.transform.position = <span class="keyword">new</span> Vector2(headProjPosition.x * Screen.width, Screen.height - headProjPosition.y * Screen.height);</div>
<div class="line"> </div>
<div class="line">        headRoot.localPosition = <span class="keyword">new</span> Vector3(0, 0, -headJoint.Real.Z * 0.001f);</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><dl class="section note"><dt>Note</dt><dd>Keep in mind that 1 Unity unit is about 1 m, so we need to adjust the obtained data. To do that, multiply the received values by 0.001 (convert m to mm).</dd></dl>
</li>
<li>
<p class="startli">Create the <em>OnEnable</em> and <em>OnDisable</em> methods: when a face is enabled, rawImage is also enabled to render this face, and vice versa.</p>
<div class="fragment"><div class="line"><span class="keyword">public</span> <span class="keyword">class </span>FaceAnimController : MonoBehaviour</div>
<div class="line">{</div>
<div class="line">...</div>
<div class="line">    <span class="keywordtype">void</span> OnDisable()</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">if</span>(faceRaw != null)</div>
<div class="line">            faceRaw.gameObject.SetActive(<span class="keyword">false</span>);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">void</span> OnEnable()</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">if</span> (faceRaw != null)</div>
<div class="line">            faceRaw.gameObject.SetActive(<span class="keyword">true</span>);</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">Drag-and-drop the <b>Fox Face Model</b> prefab to the scene. Then, drag-and-drop the <em>FaceAnimController</em> to this prefab. Fill in the fields as shown in the image below. After that, click <b>Apply</b> and delete <b>Fox Face Model</b> from the scene.</p>
<div class="image">
<img src="Uanimoji_8.png" alt="Uanimoji_8.png"/>
</div>
 <p class="endli"></p>
</li>
<li>
<p class="startli">Create a new script <em>FaceAnimManager</em>. In this script, we'll describe the display of the fox face instead of the user's face. Add the <em>nuitrack</em> namespace. Add the <em>canvas</em> field for <b>Canvas</b> and the <em>facePrefab</em> field for the fox face. Set <em>faceCount</em> from 0 to 6 (faces are "linked" to skeletons, and the maximum number of tracked skeletons is 6). Add <em>faceInfo</em> (parsed JSON from Nuitrack, from which we get all the info about faces) and list of <em>faceAnimControllers</em> (list of faces).</p>
<div class="fragment"><div class="line"><span class="keyword">using</span> UnityEngine;</div>
<div class="line"><span class="keyword">using</span> System.Collections.Generic;</div>
<div class="line"><span class="keyword">using</span> nuitrack;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">public</span> <span class="keyword">class </span>FaceAnimManager : MonoBehaviour</div>
<div class="line">{</div>
<div class="line">    [SerializeField] Canvas canvas;</div>
<div class="line"></div>
<div class="line">    [SerializeField] FaceAnimController facePrefab;</div>
<div class="line"></div>
<div class="line">    [Range(0, 6)]</div>
<div class="line">    [SerializeField] <span class="keywordtype">int</span> faceCount = 6; <span class="comment">// Max number of skeletons tracked by Nuitrack</span></div>
<div class="line"></div>
<div class="line">    FaceInfo faceInfo;</div>
<div class="line">    List&lt;FaceAnimController&gt; faceAnimControllers = <span class="keyword">new</span> List&lt;FaceAnimController&gt;();</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">In <em>Start</em>, spawn as many faces as you set in <em>faceCount</em>. Add the fox face to the scene, get <em>faceAnimController</em> from it, and call the <em>Init</em> method. Place fox faces far away from each other so that the <b>Camera</b> won't catch several fox faces at the same time, otherwise, there'll be several fox faces displayed instead of one user's face - this may look funny but it's incorrect. Add <em>faceAnimController</em> to the list of <em>faceAnimControllers</em>. Specify the necessary number of tracked skeletons (keep in mind that faces are linked to skeletons). Subscribe to <em>OnSkeletonUpdateEvent</em>.</p>
<div class="fragment"><div class="line"><span class="keyword">public</span> <span class="keyword">class </span>FaceAnimManager : MonoBehaviour</div>
<div class="line">{</div>
<div class="line">...</div>
<div class="line">    <span class="keywordtype">void</span> Start()</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; faceCount; i++)</div>
<div class="line">        {</div>
<div class="line">            GameObject newFace = Instantiate(facePrefab.gameObject, <span class="keyword">new</span> UnityEngine.Vector3(i*headsDistance,0,0), Quaternion.identity);</div>
<div class="line">            newFace.SetActive(<span class="keyword">false</span>);</div>
<div class="line">            FaceAnimController faceAnimController = newFace.GetComponent&lt;FaceAnimController&gt;();</div>
<div class="line">            faceAnimController.Init(canvas);</div>
<div class="line">            faceAnimControllers.Add(faceAnimController);</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        NuitrackManager.SkeletonTracker.SetNumActiveUsers(faceCount);</div>
<div class="line">        NuitrackManager.SkeletonTracker.OnSkeletonUpdateEvent += OnSkeletonUpdate;</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">Create the <em>OnSkeletonUpdateEvent</em> method: create the <em>string json</em> variable and pass the info from JSON to it. Pass the parsed info from JSON to <em>faceInfo</em>: replace quotation marks with square brackets to prevent a conversion error in case an array is empty (no info about faces received). If there is no info about faces, the rest of the method is not executed.</p>
<div class="fragment"><div class="line"><span class="keyword">public</span> <span class="keyword">class </span>FaceAnimManager : MonoBehaviour</div>
<div class="line">{</div>
<div class="line">...</div>
<div class="line">    <span class="keywordtype">void</span> OnSkeletonUpdate(SkeletonData skeletonData)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordtype">string</span> json = Nuitrack.GetInstancesJson();</div>
<div class="line">        faceInfo = JsonUtility.FromJson&lt;FaceInfo&gt;(json.Replace(<span class="stringliteral">&quot;\&quot;\&quot;&quot;</span>, <span class="stringliteral">&quot;[]&quot;</span>));</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (faceInfo.Instances.Length == 0)</div>
<div class="line">            <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">If a face is received, loop over <em>faceAnimControllers</em>. Activate as many faces as many skeletons were found, the rest of the faces are deactivated. By default, 6 faces are activated at startup. Create the <em>skeleton</em> variable to store the skeleton corresponding to the face (face ID and skeleton ID are the same). If a skeleton is found, get <em>headJoint</em> from it and activate the head joint if its confidence is greater than 0.5. Call the <em>UpdateFace</em> method of <em>faceAnimController</em>, pass <em>Instance</em> (all the face parameters) from JSON and <em>headJoint</em>. If a skeleton isn't found, the face is deactivated.</p>
<div class="fragment"><div class="line"><span class="keyword">public</span> <span class="keyword">class </span>FaceAnimManager : MonoBehaviour</div>
<div class="line">{</div>
<div class="line">...</div>
<div class="line">    <span class="keywordtype">void</span> OnSkeletonUpdate(SkeletonData skeletonData)</div>
<div class="line">    ...</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; faceAnimControllers.Count; i++)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">if</span> (i &lt; skeletonData.Skeletons.Length)</div>
<div class="line">            {</div>
<div class="line">                Skeleton skeleton = skeletonData.GetSkeletonByID(faceInfo.Instances[i].id);</div>
<div class="line">                <span class="keywordflow">if</span>(skeleton != null)</div>
<div class="line">                {</div>
<div class="line">                    nuitrack.Joint headJoint = skeleton.GetJoint(<a class="code" href="group__SkeletonTracker__group.html#gabc259a32c94594974dd3325b7c72d28a">JointType</a>.Head);</div>
<div class="line"> </div>
<div class="line">                    faceAnimControllers[i].gameObject.SetActive(headJoint.Confidence &gt; 0.5f);</div>
<div class="line">                    faceAnimControllers[i].UpdateFace(faceInfo.Instances[i], headJoint);</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span></div>
<div class="line">            {</div>
<div class="line">                faceAnimControllers[i].gameObject.SetActive(<span class="keyword">false</span>);</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
Drag-and-drop the <em>FaceAnimManager</em> script to <b>Face Canvas</b>. </li>
<li>
<p class="startli">Drag-and-drop <b>Face Canvas</b> to the <b>Canvas</b> field. Drag-and-drop the <b>Fox Face Model</b> prefab to the <b>Face Prefab</b> field.</p>
<div class="image">
<img src="Uanimoji_9.png" alt="Uanimoji_9.png"/>
</div>
 <p class="endli"></p>
</li>
<li>
Drag-and-drop the <b>Color Frame Canvas</b> prefab from <b>NuitrackSDK.unitypackage</b> to the scene. </li>
<li>
Run the project. You should see the fox faces instead of the users' faces. This looks quite nice, however, they're all the same at this stage! Let's move on and add emotions to our foxes, which will give them some personality. </li>
</ol>
<div class="image">
<img src="Uanimoji_10.gif" alt="Uanimoji_10.gif"/>
</div>
 <h1><a class="anchor" id="animoji_emotions"></a>
Make the Fox Emotional!</h1>
<ol>
<li>
First of all, turn on <b>depth-to-color registration</b> because a depth map doesn't accurately match an RGB image and we have to align them. To turn on depth-to-color registration, you have to open <em>nuitrack.config</em> and set <em>DepthProvider.Depth2ColorRegistration</em> to <em>true</em>. </li>
<li>
By default, face tracking in Nuitrack is turned off. To turn on this function, open the <em>nuitrack.config</em> file and set <em>Faces.ToUse</em> to <em>true</em>. </li>
<li>
<p class="startli">Add the IDs of blendshapes to <em>FaceAnimController</em>. You can see the full list of blendshapes in the <b>Fox_RigFace</b> object settings. With the help of these blendshapes, you can animate different parts of the fox face. In this project, the fox can open its mouth, blink, smile, and raise eyebrows. When the fox face is turned, its ears and fur on the cheeks are slightly moving. As you can see, we use only 7 blendshapes in this project, though there are much more of them in the list of blendshapes on <b>Fox_RigFace</b>. The point is that we can receive the limited number of anthropometric points at the moment (see <a href="http://download.3divi.com/Nuitrack/doc/Instance_based_API.html">Nuitrack Instance-based API [Beta]</a> for details), therefore, there is not enough information for other blendshapes (such as cheeks). Add the fields <em>baseRotation</em> (initial rotation of <em>headRoot</em>), <em>blendshapeWeights</em> (from 0 to 100%), and <em>newRotation</em> (current head rotation).</p>
<div class="fragment"><div class="line"><span class="keyword">public</span> <span class="keyword">class </span>FaceAnimController : MonoBehaviour</div>
<div class="line">{</div>
<div class="line">...</div>
<div class="line">    <span class="comment">//Face Animation</span></div>
<div class="line">    [Header(<span class="stringliteral">&quot;BlendShapesIds&quot;</span>)]</div>
<div class="line">    [SerializeField] <span class="keywordtype">int</span> jawOpen = 6;</div>
<div class="line">    [SerializeField] <span class="keywordtype">int</span> eyeBlinkLeft = 0;</div>
<div class="line">    [SerializeField] <span class="keywordtype">int</span> eyeBlinkRight = 2;</div>
<div class="line">    [SerializeField] <span class="keywordtype">int</span> mouthLeft = 10;</div>
<div class="line">    [SerializeField] <span class="keywordtype">int</span> mouthRight = 11;</div>
<div class="line">    [SerializeField] <span class="keywordtype">int</span> browUpLeft = 17;</div>
<div class="line">    [SerializeField] <span class="keywordtype">int</span> browUpRight = 18;</div>
<div class="line"></div>
<div class="line">    Quaternion baseRotation; </div>
<div class="line">    BlendshapeWeights blendshapeWeights = <span class="keyword">new</span> BlendshapeWeights();</div>
<div class="line">    Quaternion newRotation;</div>
<div class="line">...</div>
<div class="line">}</div>
</div><!-- fragment --><dl class="section note"><dt>Note</dt><dd>Animation of fox ears and fur is described in the <em>LerpRotation</em> script.</dd></dl>
</li>
<li>
<p class="startli">In the <em>Init</em> method, save <em>baseRotation</em> (initial head rotation, which we use to calculate the current head rotation).</p>
<div class="fragment"><div class="line"><span class="keyword">public</span> <span class="keyword">class </span>FaceAnimController : MonoBehaviour</div>
<div class="line">{</div>
<div class="line">...</div>
<div class="line">    <span class="keyword">public</span> <span class="keywordtype">void</span> Init(Canvas canvas)</div>
<div class="line">    {</div>
<div class="line">        baseRotation = headRoot.rotation; </div>
<div class="line">    }</div>
<div class="line">...</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">In <em>UpdateFace</em>, add the local variable <em>face</em> and save the face from JSON. Pass <em>baseRotation</em> to the <em>newRotation</em> variable.</p>
<div class="fragment"><div class="line"><span class="keyword">public</span> <span class="keyword">class </span>FaceAnimController : MonoBehaviour</div>
<div class="line">{</div>
<div class="line">...</div>
<div class="line">    <span class="keyword">public</span> <span class="keywordtype">void</span> UpdateFace(Instances instance, nuitrack.Joint headJoint)</div>
<div class="line">    {</div>
<div class="line">    ...</div>
<div class="line">        Face face = instance.face;</div>
<div class="line"> </div>
<div class="line">        newRotation = baseRotation;</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">If anthropometric points were detected on a user's face (for this, it should be clearly visible and not overlapped by other objects), set the weights of blendshapes. They're all set in the same way with the help of the <em>SetBlendShapeWeight</em> method: pass the index and weight of a blendshape (from 0 to 100) to this method - the weight is taken from the <em>blendshapeWeights</em> class, then call the relevant method, for example, <em>GetJawOpen</em> to open the fox mouth, pass the <em>face</em> to this method, and so on. As a result, we get a weight value for each blendshape. Calculate the head rotation: pass the product of <em>baseRotation</em> (initial rotation) and head rotation from JSON to the <em>newRotation</em> variable.</p>
<div class="fragment"><div class="line"><span class="keyword">public</span> <span class="keyword">class </span>FaceAnimController : MonoBehaviour</div>
<div class="line">{</div>
<div class="line">...</div>
<div class="line">    <span class="keyword">public</span> <span class="keywordtype">void</span> UpdateFace(Instances instance, nuitrack.Joint headJoint)</div>
<div class="line">    {</div>
<div class="line">    ...</div>
<div class="line">        <span class="keywordflow">if</span> (instance.face.landmark == null)</div>
<div class="line">            <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Mouth</span></div>
<div class="line">        faceMeshRenderer.SetBlendShapeWeight(jawOpen, blendshapeWeights.GetJawOpen(face));</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Eyes</span></div>
<div class="line">        faceMeshRenderer.SetBlendShapeWeight(eyeBlinkLeft, blendshapeWeights.GetEyeBlinkLeft(face));</div>
<div class="line">        faceMeshRenderer.SetBlendShapeWeight(eyeBlinkRight, blendshapeWeights.GetEyeBlinkRight(face));</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Smile</span></div>
<div class="line">        faceMeshRenderer.SetBlendShapeWeight(mouthLeft, blendshapeWeights.GetSmile(face));</div>
<div class="line">        faceMeshRenderer.SetBlendShapeWeight(mouthRight, blendshapeWeights.GetSmile(face));</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Eyebrows</span></div>
<div class="line">        faceMeshRenderer.SetBlendShapeWeight(browUpLeft, blendshapeWeights.GetBrowUpLeft(face));</div>
<div class="line">        faceMeshRenderer.SetBlendShapeWeight(browUpRight, blendshapeWeights.GetBrowUpRight(face));</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Head rotation</span></div>
<div class="line">        newRotation = baseRotation * Quaternion.Euler(face.angles.yaw, -face.angles.pitch, face.angles.roll);</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">In <em>Update</em>, smoothly rotate the head.</p>
<div class="fragment"><div class="line"><span class="keyword">public</span> <span class="keyword">class </span>FaceAnimController : MonoBehaviour</div>
<div class="line">{</div>
<div class="line">...</div>
<div class="line">    <span class="keywordtype">void</span> Update()</div>
<div class="line">    {</div>
<div class="line">        headRoot.rotation = Quaternion.Slerp(headRoot.rotation, newRotation, slerpRotation * Time.deltaTime);</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><dl class="section note"><dt>Note</dt><dd>Learn more about <a href="https://docs.unity3d.com/ScriptReference/Quaternion.Slerp.html">Quaternion.Slerp</a>.</dd></dl>
</li>
<li>
Run the project. Now our fox face looks quite lively - we can turn the head, see the emotions and moving ears and fur. You can use this sample to develop more sophisticated projects with face tracking, skeleton tracking, and animated emojis using Nuitrack. Have fun! </li>
</ol>
<div class="image">
<img src="Uanimoji_1.gif" alt="Uanimoji_1.gif"/>
</div>
  </div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="UnityTutorials_page.html">Unity Tutorials</a></li>
    <li class="footer">Generated on Thu Aug 22 2019 12:41:46 for Nuitrack by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.6 </li>
  </ul>
</div>
</body>
</html>
