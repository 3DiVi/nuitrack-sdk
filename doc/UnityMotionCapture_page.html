<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>Nuitrack: Recording Animation using Nuitrack and Motion Capture</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen_html_style.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="nuitrack.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Nuitrack
   &#160;<span id="projectnumber">1.4.1</span>
   </div>
   <div id="projectbrief">3D Skeleton Tracking Middleware</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('UnityMotionCapture_page.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Properties</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Events</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(11)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Recording Animation using Nuitrack and Motion Capture </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#mc_settings">Setting Up the Scene</a></li>
<li class="level1"><a href="#mc_interface">Creating an Interface for Animation Recorders</a></li>
<li class="level1"><a href="#mc_genericrecorder">Generic Recorder</a></li>
<li class="level1"><a href="#mc_GameObjectRecorder">GameObject Recorder</a></li>
<li class="level1"><a href="#mc_humanoid">Humanoid Recorder</a></li>
</ul>
</div>
<div class="textblock"><p>In this tutorial you'll learn how to quickly and easily record the animation of your avatar in Unity with Nuitrack. You won't need any additional tools except a depth sensor (from the <a href="https://nuitrack.com/">list of supported sensors</a>) to track your skeleton and record the animation. We'll describe three different types of recording animation. You can use any one you like, depending on your needs.</p>
<p><b>Generic animation</b> is used to animate any models. In general, this animation is easier to use compared to the Humanoid animation but it is tied to the hierarchy of Game Objects. This means that animation will be displayed incorrectly if you change the name or position of any animated Game Object.</p>
<p><b>Animation using <a href="https://docs.unity3d.com/2018.3/Documentation/ScriptReference/Animations.GameObjectRecorder.html">GameObjectRecorder</a></b> can be called a simplified version of Generic animation. It is also used to animate models of any form. This is a convenient animation type, however, it is not optimized yet. As a result, you will face a long list of unnecessary keys due to the fact that all Game Objects are recorded (even those avatar's parts that didn't move at all).</p>
<p><b>Humanoid animation</b> is used (as you can guess) to animate humanoid models. It is more versatile than Generic animation because you can record the animation for a particular model and apply it to any other humanoid model. Also you can set the range of motion for specific muscles.</p>
<div class="image">
<img src="Umc_9.gif" alt="Umc_9.gif"/>
<div class="caption">
Animation recorded with GameObjectRecorder </div></div>
 <p>To create this project, you'll need just a couple of things: </p>
<ul>
<li>
Nuitrack Runtime and Nuitrack SDK </li>
<li>
Any supported sensor (see the complete list at <a href="https://nuitrack.com/">Nuitrack website</a>) </li>
<li>
Unity 2017.4 or higher </li>
</ul>
<p>You can find the finished project in <b>Nuitrack SDK: Unity 3D → NuitrackSDK.unitypackage → Tutorials → Motion Capture</b></p>
<p>Choose the suitable animation type and let's get started!</p>
<h1><a class="anchor" id="mc_settings"></a>
Setting Up the Scene</h1>
<ol>
<li>
<p class="startli">Create a new project. Import <a href="https://assetstore.unity.com/packages/templates/packs/nuitrack-skeleton-tracking-127675"><b>Nuitrack Skeleton Tracking</b> Unity Package</a> to your project. Drag-and-drop the <b>Ethan</b> model from the downloaded package (or any other humanoid model) to the scene. The model should be in a T-Pose so that its joints are matched correctly. To do that, select your model's hands (for example, <b>EthanLeftArm</b> and <b>EthanRightArm</b> for our model) and set Rotation parameters as in the screenshot below:</p>
<div class="image">
<img src="Umc_1.png" alt="Umc_1.png"/>
<div class="caption">
Settings of the "EthanLeftArm" Object </div></div>
 <div class="image">
<img src="Umc_2.png" alt="Umc_2.png"/>
<div class="caption">
Settings of the "EthanRightArm" Object </div></div>
 <p class="endli"></p>
</li>
<li>
<p class="startli">If you use your own model, you have to drag-and-drop the <em>RiggedAvatar</em> script from <b>Nuitrack Skeleton Tracking</b> Unity Package to the model (this script is already attached to <b>Ethan</b>). Then, select the joints you'd like to animate. All in all, Nuitrack tracks up to 20 joints, see the list <a href="http://download.3divi.com/Nuitrack/doc/group__SkeletonTracker__group__csharp.html#ga659db18c8af0cb3d660930d7116709ae">here</a>. Remove the <b>Animator</b> component (if any) from the model so that it doesn't block changes in the <em>RiggedAvatar</em> script. Here is an example of selected joints:</p>
<div class="image">
<img src="Umc_3.png" alt="Umc_3.png"/>
</div>
 <p class="endli"></p>
</li>
<li>
Place the model so that it is completely in the field of view of the camera. </li>
<li>
To indicate the beginning and ending of recording the animation, we'll need a red indicator. Create a <b>Canvas</b> and an <b>Image</b> on it (make it look like a red recording indicator). Place the indicator in the top left corner. </li>
<li>
<p class="startli">Drag-and-drop the <b>NuitrackScripts</b> prefab from <b>Nuitrack SDK</b> to the scene. In settings, tick the modules required for skeleton tracking of our avatar: <b>Depth Module, SkeletonTracker Module, UserTracker Module</b>.</p>
<div class="image">
<img src="Umc_4.png" alt="Umc_4.png"/>
</div>
 <p class="endli"></p>
</li>
<li>
At this point, you can run the project and check whether the avatar is moving in accordance with the user's movements or not. </li>
</ol>
<h1><a class="anchor" id="mc_interface"></a>
Creating an Interface for Animation Recorders</h1>
<ol>
<li>
<p class="startli">Since we'll use several implementations of the animation recorder, we have to set up a relevant interface for them. Create a new script named <em>IRecordable</em>. In this script, we'll describe the interface with the same name. In the script, create the <em>TakeSnapShot</em> method (to take pictures of Game Objects state) and <em>GetClip</em> (to get the clip with a recorded animation).</p>
<div class="fragment"><div class="line"><span class="keyword">using</span> UnityEngine;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">public</span> <span class="keyword">interface </span>IRecordable</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">void</span> TakeSnapshot(<span class="keywordtype">float</span> deltaTime);</div>
<div class="line"> </div>
<div class="line">    AnimationClip GetClip { <span class="keyword">get</span>; }</div>
<div class="line">}</div>
</div><!-- fragment --><dl class="section note"><dt>Note</dt><dd>In this project, we use an interface to simplify the interaction with the recorder. By using interfaces, you can include behavior from several sources into one class. You can also create your own recorder and easily add it to this project thanks to the <em>IRecordable</em> interface.</dd></dl>
</li>
<li>
<p class="startli">Create a new script named <em>GenericRecorder</em> and describe how the Generic recorder works. To begin with, let's check the operation of the recorder (without recoding the animation). Inherit the <em>GenericRecorder</em> class from the <em>IRecordable</em> interface and declare the <em>time</em> variable.</p>
<div class="fragment"><div class="line"><span class="keyword">public</span> <span class="keyword">class </span>GenericRecorder : IRecordable</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">float</span> time = 0.0f;</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">Create the <em>TakeSnapshot</em> method to take pictures of each frame of the animation.</p>
<div class="fragment"><div class="line"><span class="keyword">public</span> <span class="keywordtype">void</span> TakeSnapshot(<span class="keywordtype">float</span> deltaTime)</div>
<div class="line">{</div>
<div class="line">    time += deltaTime;</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">Create the <a href="https://docs.unity3d.com/ScriptReference/AnimationClip.html">AnimationClip</a> method to get the recorded animation clip.</p>
<div class="fragment"><div class="line"><span class="keyword">public</span> AnimationClip GetClip</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">get</span></div>
<div class="line">    {</div>
<div class="line">        AnimationClip clip = <span class="keyword">new</span> AnimationClip();</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">return</span> clip;</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">Create a new script named <em>UnityAnimationRecorder</em>, in which we'll describe the algorithm of interaction with the recorder (recording and receiving the clip). Add the <em>UnityEditor</em> namespace. List the types of animations we're going to use (Generic, GenericExperimental, Humanoid). Add the necessary fields: <em>recordMode</em> to store the recorder type, <em>savePath</em> for saving path of the recorded animation and <em>fileName</em> to store the file name, <em>poseCalibration</em> to manage the T-Pose calibration and <em>recordIcon</em> for a recording indicator. Create the <em>isRecording</em> boolean variable to check the recording state and add a reference to the <em>IRecordable</em> interface.</p>
<div class="fragment"><div class="line"><span class="keyword">using</span> UnityEngine;</div>
<div class="line"><span class="keyword">using</span> UnityEditor;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">public</span> <span class="keyword">class </span>UnityAnimationRecorder : MonoBehaviour</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">enum</span> RecordMode { Generic, GenericExperimental, Humanoid };</div>
<div class="line"> </div>
<div class="line">    [Header(<span class="stringliteral">&quot;General&quot;</span>)]</div>
<div class="line">    [SerializeField] RecordMode recordMode = RecordMode.Generic;</div>
<div class="line"> </div>
<div class="line">    [Header(<span class="stringliteral">&quot;Save&quot;</span>)]</div>
<div class="line">    [SerializeField] <span class="keywordtype">string</span> savePath = <span class="stringliteral">&quot;Assets/NuitrackSDK/Tutorials/Motion Capture/Animations&quot;</span>;</div>
<div class="line">    [SerializeField] <span class="keywordtype">string</span> fileName = <span class="stringliteral">&quot;Example&quot;</span>;</div>
<div class="line"> </div>
<div class="line">    [Header(<span class="stringliteral">&quot;Control&quot;</span>)]</div>
<div class="line">    [SerializeField] TPoseCalibration poseCalibration;</div>
<div class="line">    [SerializeField] GameObject recordIcon;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">bool</span> isRecording = <span class="keyword">false</span>;</div>
<div class="line">    IRecordable recordable = null;</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">You'll be able to start and stop the recording of an animation clip using the T-Pose. In the <em>Start</em> method, subscribe to the T-Pose calibration completion event. Initialize the recorder.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> Start()</div>
<div class="line">{</div>
<div class="line">    poseCalibration.onSuccess += PoseCalibration_onSuccess;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">switch</span> (recordMode)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">case</span> RecordMode.Generic:</div>
<div class="line">            recordable = <span class="keyword">new</span> GenericRecorder();</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">In the <em>onDestroy</em> method, unsubscribe from the T-Pose calibration completion event.</p>
<div class="fragment"><div class="line"><span class="keyword">private</span> <span class="keywordtype">void</span> OnDestroy()</div>
<div class="line">{</div>
<div class="line">        poseCalibration.onSuccess -= PoseCalibration_onSuccess;</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">In the <em>PoseCalibration_onSuccess</em> method, process the beginning and ending of recording the animation. Activate the recording indicator.</p>
<div class="fragment"><div class="line"><span class="keyword">private</span> <span class="keywordtype">void</span> PoseCalibration_onSuccess(Quaternion rotation)</div>
<div class="line">{</div>
<div class="line">        <span class="keywordflow">if</span> (!isRecording)</div>
<div class="line">        {</div>
<div class="line">            Debug.Log(<span class="stringliteral">&quot;Start recording&quot;</span>);</div>
<div class="line">            isRecording = <span class="keyword">true</span>;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">        {</div>
<div class="line">            Debug.Log(<span class="stringliteral">&quot;Stop recording&quot;</span>);</div>
<div class="line">            isRecording = <span class="keyword">false</span>;</div>
<div class="line">            SaveToFile(recordable.GetClip);</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        recordIcon.SetActive(isRecording);</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">In the <em>Update</em> method, access the recorder using the interface and take a snapshot of each frame.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> Update()</div>
<div class="line">{</div>
<div class="line">        <span class="keywordflow">if</span> (isRecording)</div>
<div class="line">            recordable.TakeSnapshot(Time.deltaTime);</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">In the <em>SaveToFile</em> method, save the file with the recorded animation (specify the file path and name).</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> SaveToFile(AnimationClip clip)</div>
<div class="line">{</div>
<div class="line">        <span class="keywordtype">string</span> path = savePath + <span class="stringliteral">&quot;/&quot;</span> + fileName + <span class="stringliteral">&quot;.anim&quot;</span>;</div>
<div class="line">        clip.name = fileName;</div>
<div class="line"> </div>
<div class="line">        AssetDatabase.CreateAsset(clip, path);</div>
<div class="line">        Debug.Log(<span class="stringliteral">&quot;Save to: &quot;</span> + path);</div>
<div class="line">}</div>
</div><!-- fragment --><dl class="section note"><dt>Note</dt><dd>The <a href="https://docs.unity3d.com/ScriptReference/AssetDatabase.html">AssetDatabase</a> class is accessible only from the Editor.</dd></dl>
</li>
<li>
<p class="startli">In Unity, create an empty object and name it <b>Recorder</b>. Drag-and-drop the <em>UnityAnimationRecorder</em> script to this object. Add references to <b>Pose Calibration</b> (from <b>NuitrackScripts</b>) and <b>Record Icon (Image)</b>.</p>
<div class="image">
<img src="Umc_5.png" alt="Umc_5.png"/>
</div>
 <p class="endli"></p>
</li>
<li>
<p class="startli">Run the project and check the animation recording. At this point, we check only how the recording (transferring and receiving the data) works, so, the created file will be empty for now.</p>
<div class="image">
<img src="Umc_6.gif" alt="Umc_6.gif"/>
</div>
  </li>
</ol>
<h1><a class="anchor" id="mc_genericrecorder"></a>
Generic Recorder</h1>
<ol>
<li>
<p class="startli">Go back to the <em>GenericRecorder</em> script and whip the Generic animation into shape so that the recorded animation is actually saved in the created file. Create the <em>CurveContainer</em> class and set the property of the recorded object (for example, its position or rotation along one axis) and Curve (how the property changes over time). The <em>lastValue</em> variable is the value from the previous frame that is used to optimize the animation (keys for the objects, which don't move, won't be saved). Create a curve and name of the recorded property in the <em>CurveContainer</em> constructor.</p>
<div class="fragment"><div class="line"><span class="keyword">class </span>CurveContainer</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">public</span> <span class="keywordtype">string</span> Property { <span class="keyword">get</span>; <span class="keyword">private</span> set; }</div>
<div class="line">    <span class="keyword">public</span> AnimationCurve Curve { <span class="keyword">get</span>; <span class="keyword">private</span> set; }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">float</span>? lastValue = null;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">public</span> CurveContainer(<span class="keywordtype">string</span> _propertyName)</div>
<div class="line">    {</div>
<div class="line">            Curve = <span class="keyword">new</span> AnimationCurve();</div>
<div class="line">            Property = _propertyName;</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">In the same class, create the <em>addValue</em> method to compare the current value with the previous one (animation is recorded if it is the first frame or there was a change). <a href="https://docs.unity3d.com/ScriptReference/Keyframe.html">Keyframe</a> is the key that gets time and value and passes them to the curve. After that, <em>lastValue</em> is updated.</p>
<div class="fragment"><div class="line"><span class="keyword">class </span>CurveContainer</div>
<div class="line">{</div>
<div class="line">...</div>
<div class="line">    <span class="keyword">public</span> <span class="keywordtype">void</span> AddValue(<span class="keywordtype">float</span> time, <span class="keywordtype">float</span> value)</div>
<div class="line">    {</div>
<div class="line">            <span class="comment">// If the current value is first or not equal to the previous one</span></div>
<div class="line">            <span class="keywordflow">if</span> (lastValue == null || !Mathf.Approximately((<span class="keywordtype">float</span>)lastValue, value))</div>
<div class="line">            {</div>
<div class="line">                Keyframe key = <span class="keyword">new</span> Keyframe(time, value);</div>
<div class="line">                Curve.AddKey(key);</div>
<div class="line">                lastValue = value;</div>
<div class="line">            }</div>
<div class="line">    }</div>
<div class="line">…</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">Create the <em>ObjectAnimation</em> class to store the object (animated joint) and its curves (changes in its position and rotation). Create the joint transform, list of curves, and path to the current transform from the root transform (which is <b>Ethan</b>). In the <em>ObjectAnimation</em> constructor, save the transform and its position in the hierarchy, fill the collection of curves (when initializing the object, pass the names of properties as a parameter).</p>
<div class="fragment"><div class="line"><span class="keyword">class </span>ObjectAnimation</div>
<div class="line">{</div>
<div class="line">    Transform transform;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">public</span> List&lt;CurveContainer&gt; Curves { <span class="keyword">get</span>; <span class="keyword">private</span> set; }</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">public</span> <span class="keywordtype">string</span> Path { <span class="keyword">get</span>; <span class="keyword">private</span> set; }</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">public</span> ObjectAnimation(<span class="keywordtype">string</span> hierarchyPath, Transform recordableTransform)</div>
<div class="line">    {</div>
<div class="line">             Path = hierarchyPath;</div>
<div class="line">             transform = recordableTransform;</div>
<div class="line"> </div>
<div class="line">             Curves = <span class="keyword">new</span> List&lt;CurveContainer&gt;</div>
<div class="line">             {</div>
<div class="line">                <span class="keyword">new</span> CurveContainer(<span class="stringliteral">&quot;localPosition.x&quot;</span>),</div>
<div class="line">                <span class="keyword">new</span> CurveContainer(<span class="stringliteral">&quot;localPosition.y&quot;</span>),</div>
<div class="line">                <span class="keyword">new</span> CurveContainer(<span class="stringliteral">&quot;localPosition.z&quot;</span>),</div>
<div class="line"> </div>
<div class="line">                <span class="keyword">new</span> CurveContainer(<span class="stringliteral">&quot;localRotation.x&quot;</span>),</div>
<div class="line">                <span class="keyword">new</span> CurveContainer(<span class="stringliteral">&quot;localRotation.y&quot;</span>),</div>
<div class="line">                <span class="keyword">new</span> CurveContainer(<span class="stringliteral">&quot;localRotation.z&quot;</span>),</div>
<div class="line">                <span class="keyword">new</span> CurveContainer(<span class="stringliteral">&quot;localRotation.w&quot;</span>)</div>
<div class="line">             };</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">In the <em>TakeSnapShot</em> method, take a snapshot of the frame (pass the time and value to <em>CurveContainer</em>).</p>
<div class="fragment"><div class="line"><span class="keyword">class </span>ObjectAnimation</div>
<div class="line">{</div>
<div class="line">...</div>
<div class="line">    <span class="keyword">public</span> <span class="keywordtype">void</span> TakeSnapshot(<span class="keywordtype">float</span> time)</div>
<div class="line">    {</div>
<div class="line">            Curves[0].AddValue(time, transform.localPosition.x);</div>
<div class="line">            Curves[1].AddValue(time, transform.localPosition.y);</div>
<div class="line">            Curves[2].AddValue(time, transform.localPosition.z);</div>
<div class="line"> </div>
<div class="line">            Curves[3].AddValue(time, transform.localRotation.x);</div>
<div class="line">            Curves[4].AddValue(time, transform.localRotation.y);</div>
<div class="line">            Curves[5].AddValue(time, transform.localRotation.z);</div>
<div class="line">            Curves[6].AddValue(time, transform.localRotation.w);</div>
<div class="line">    }</div>
<div class="line">...</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">Create a list with the objects to be animated.</p>
<div class="fragment"><div class="line"><span class="keyword">public</span> <span class="keyword">class </span>GenericRecorder : IRecordable</div>
<div class="line">{</div>
<div class="line">...</div>
<div class="line">        List&lt;ObjectAnimation&gt; objectAnimations = <span class="keyword">new</span> List&lt;ObjectAnimation&gt;();</div>
<div class="line">...</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">Create the <em>GenericRecorder</em> constructor, which accepts the transforms of the object and root object. Fill in the list of objects, for which changes will be recorded.</p>
<div class="fragment"><div class="line"><span class="keyword">public</span> GenericRecorder(Transform[] recordableTransform, Transform rootTransform)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">foreach</span> (Transform transform <span class="keywordflow">in</span> recordableTransform)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordtype">string</span> path = AnimationUtility.CalculateTransformPath(transform, rootTransform);</div>
<div class="line">        objectAnimations.Add(<span class="keyword">new</span> ObjectAnimation(path, transform));</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">Edit the <em>TakeSnapShot</em> method: loop over the collection of objects and take a snapshot.</p>
<div class="fragment"><div class="line"><span class="keyword">public</span> <span class="keywordtype">void</span> TakeSnapshot(<span class="keywordtype">float</span> deltaTime)</div>
<div class="line">{</div>
<div class="line">...</div>
<div class="line">    <span class="keywordflow">foreach</span> (ObjectAnimation animation <span class="keywordflow">in</span> objectAnimations)</div>
<div class="line">        animation.TakeSnapshot(time);</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">Get the animation clip in the <em>GetClip</em> method: create an empty <em>AnimationClip</em>, loop over the collection of objects and curves of object properties. If a curve contains only 1 key, it's not recorded (as there were no changes). Save the curves and return the clip.</p>
<div class="fragment"><div class="line"><span class="keyword">public</span> AnimationClip GetClip</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">get</span></div>
<div class="line">    {</div>
<div class="line">        AnimationClip clip = <span class="keyword">new</span> AnimationClip();</div>
<div class="line">        <span class="keywordflow">foreach</span> (ObjectAnimation animation <span class="keywordflow">in</span> objectAnimations)</div>
<div class="line">        {</div>
<div class="line">             <span class="keywordflow">foreach</span> (CurveContainer container <span class="keywordflow">in</span> animation.Curves)</div>
<div class="line">             {</div>
<div class="line">                 <span class="keywordflow">if</span> (container.Curve.keys.Length &gt; 1)</div>
<div class="line">                     clip.SetCurve(animation.Path, typeof(Transform), container.Property, container.Curve);</div>
<div class="line">             }</div>
<div class="line">         }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">return</span> clip;</div>
<div class="line">      }</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">Pass these parameters to the <em>Start</em> method.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> Start()</div>
<div class="line">{</div>
<div class="line">…</div>
<div class="line">    <span class="keywordflow">switch</span> (recordMode)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">case</span> RecordMode.Generic:</div>
<div class="line">            recordable = <span class="keyword">new</span> GenericRecorder(transforms, root);</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">In Unity, set our model as a root object: <b>Recorder → Root → Ethan</b>. Set the joints:</p>
<div class="image">
<img src="Umc_7.png" alt="Umc_7.png"/>
</div>
 <p class="endli"></p>
</li>
<li>
<p class="startli">To check the project, copy the <b>Ethan</b> model to the scene. Now, it should have the <b>Animator</b> component. Drag-and-drop the recorded animation clip to the model. Make sure that there is no <b>Avatar</b> in the <b>Animation</b> component, otherwise the animation won't start. After that, run the project and check the recorded Generic animation.</p>
<div class="image">
<img src="Umc_8.gif" alt="Umc_8.gif"/>
</div>
 <p class="endli"></p>
</li>
</ol>
<h1><a class="anchor" id="mc_GameObjectRecorder"></a>
GameObject Recorder</h1>
<ol>
<li>
<p class="startli">Create the <em>ExperimentalRecorder</em> script, which acts as a shell for <em>GameObjectRecorder</em>. Add the <em>UnityEditor.Experimental.Animations</em> namespace. Inherit it from the <em>IRecordable</em> interface. Declare the <em>m_Recorder</em> object.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#if UNITY_EDITOR</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="keyword">using</span> UnityEngine;</div>
<div class="line"><span class="preprocessor">#if UNITY_2017_4 || UNITY_2018_2</span></div>
<div class="line"><span class="preprocessor"></span><span class="keyword">using</span> UnityEditor.Experimental.Animations;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="keyword">public</span> <span class="keyword">class </span>ExperimentalRecorder : IRecordable</div>
<div class="line">{</div>
<div class="line"><span class="preprocessor">#if UNITY_2017_4 || UNITY_2018_2</span></div>
<div class="line"><span class="preprocessor"></span>    GameObjectRecorder m_Recorder;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>}</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#endif</span></div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">Create a constructor to accept the root object. Initialize the object in different ways depending on the Unity version used and pass the root object. After that, all objects below the root one are processed hierarchically.</p>
<div class="fragment"><div class="line"><span class="keyword">public</span> ExperimentalRecorder(GameObject rootObject)</div>
<div class="line">{</div>
<div class="line"><span class="preprocessor">#if UNITY_2017_4</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">    m_Recorder = <span class="keyword">new</span> GameObjectRecorder();</div>
<div class="line">    m_Recorder.root = rootObject;</div>
<div class="line">    m_Recorder.BindComponent&lt;Transform&gt;(rootObject, <span class="keyword">true</span>);</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#elif UNITY_2018_2</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">    m_Recorder = <span class="keyword">new</span> GameObjectRecorder(rootObject);</div>
<div class="line">    m_Recorder.BindComponentsOfType&lt;Transform&gt;(rootObject, <span class="keyword">true</span>);</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>    PrintErrorVersion();</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">}</div>
</div><!-- fragment --><dl class="section note"><dt>Note</dt><dd>At the moment, this type of animation recording is available only in two versions of Unity. To distinguish between the code parts that run depending on the Unity version, we use the preprocessor directives <em>if, elif, else, endif</em>.</dd></dl>
</li>
<li>
<p class="startli">Create the <em>TakeSnapShot</em> method to take a snapshot of each frame.</p>
<div class="fragment"><div class="line"><span class="keyword">public</span> <span class="keywordtype">void</span> TakeSnapshot(<span class="keywordtype">float</span> deltaTime)</div>
<div class="line">{</div>
<div class="line"><span class="preprocessor">#if UNITY_2017_4 || UNITY_2018_2</span></div>
<div class="line"><span class="preprocessor"></span>    m_Recorder.TakeSnapshot(deltaTime);</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>    PrintErrorVersion();</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">In the <em>GetClip</em> method, create an empty clip and save the recorded animation. Empty <em>m_Recorder</em> when the recording is over. Return the clip. In case an incorrect Unity version is used, an error is displayed (see the <em>PrintErrorVersion</em> method).</p>
<div class="fragment"><div class="line"><span class="keyword">public</span> AnimationClip GetClip</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">get</span></div>
<div class="line">    {</div>
<div class="line"><span class="preprocessor">#if UNITY_2017_4 || UNITY_2018_2</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">        AnimationClip clip = <span class="keyword">new</span> AnimationClip();</div>
<div class="line">        m_Recorder.SaveToClip(clip);</div>
<div class="line">        m_Recorder.ResetRecording();</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">return</span> clip;</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>        PrintErrorVersion();</div>
<div class="line">        <span class="keywordflow">return</span> null;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> PrintErrorVersion()</div>
<div class="line">{</div>
<div class="line">    Debug.Log(<span class="stringliteral">&quot;Check your Unity version&quot;</span>);</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">Go back to the <em>UnityAnimationRecorder</em> script and add the recorder initialization using <em>GameObjectRecorder</em> to the <em>Start</em> method.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> Start()</div>
<div class="line">{</div>
<div class="line">…</div>
<div class="line">        <span class="keywordflow">case</span> RecordMode.GenericExperimental:</div>
<div class="line">            recordable = <span class="keyword">new</span> ExperimentalRecorder(root.gameObject);</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">Run the project and check the animation recording using <em>GameObjectRecorder</em>.</p>
<div class="image">
<img src="Umc_9.gif" alt="Umc_9.gif"/>
</div>
 <p>To play the recorded animation clip, drag-and-drop it to the model and untick the "Avatar" component in the "Animator" section.</p>
<div class="image">
<img src="Umc_10.gif" alt="Umc_10.gif"/>
</div>
 <p class="endli"></p>
</li>
</ol>
<h1><a class="anchor" id="mc_humanoid"></a>
Humanoid Recorder</h1>
<ol>
<li>
<p class="startli">In Unity, set up the model (in the <b>Models</b> folder). Select the desired animation type in avatar settings: <b>Rig → Animation → Type → Humanoid</b>.</p>
<div class="image">
<img src="Umc_11.png" alt="Umc_11.png"/>
</div>
 <p class="endli"></p>
</li>
<li>
<p class="startli">In Unity, a skeleton has a minimum set of joints. If the assigned joints of the model do not match the joints from this set, the corresponding body part will be highlighted in red. Click <b>Configure...</b> and check that all joints of our model are assigned correctly. After that, click <b>Done</b>.</p>
<div class="image">
<img src="Umc_12.png" alt="Umc_12.png"/>
</div>
 <dl class="section note"><dt>Note</dt><dd>Now the model is animated not due to the change in the rotation and position of Game Objects but due to the change in the degree of muscle compression (from -1 to 1 in the specified range of motion).</dd></dl>
<div class="image">
<img src="Umc_13.gif" alt="Umc_13.gif"/>
</div>
 <p class="endli"></p>
</li>
<li>
Remove the used model (without <b>Animator</b>) from the scene. Drag-and-drop the new model (with <b>Animator</b>) to the scene. The model should be in the T-Pose. </li>
<li>
<p class="startli">Create the <em>AnimatorAvatar</em> script to animate the model. Add fields for the animator and list of joints. Create the <em>SimpleJoint</em> class to store the <em>nuitrackJoint</em> joint type (which is received from Nuitrack), <em>Offset</em> (to compensate the skeleton offset relative to the sensor) and joint transform.</p>
<div class="fragment"><div class="line"><span class="keyword">using</span> UnityEngine;</div>
<div class="line"><span class="keyword">using</span> System.Linq;</div>
<div class="line"><span class="keyword">using</span> System.Collections.Generic;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">public</span> <span class="keyword">class </span>AnimatorAvatar : MonoBehaviour</div>
<div class="line">{</div>
<div class="line">    [SerializeField] Animator animator;</div>
<div class="line">    [SerializeField] List&lt;SimpleJoint&gt; joints = <span class="keyword">new</span> List&lt;SimpleJoint&gt;();</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">[System.Serializable]</div>
<div class="line"><span class="keyword">class </span>SimpleJoint</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">public</span> nuitrack.JointType nuitrackJoint;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">public</span> Quaternion Offset { <span class="keyword">get</span>; set; }</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">public</span> Transform Bone { <span class="keyword">get</span>; set; }</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">In the <em>Start</em> method, loop over the joints. We have to match the Nuitrack joints and Unity joints. In case any Unity joint isn't assigned, an error message indicating this joint will be displayed in the console. If all joints are assigned correctly, get the model's joint transform, save it to joints and calculate <em>Offset</em>.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> Start ()</div>
<div class="line">{</div>
<div class="line">     <span class="keywordflow">foreach</span> (SimpleJoint item <span class="keywordflow">in</span> joints)</div>
<div class="line">     {</div>
<div class="line">            HumanBodyBones unityBoneType = item.nuitrackJoint.ToUnityBones();</div>
<div class="line">            Transform bone = animator.GetBoneTransform(unityBoneType);</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">if</span> (bone == null)</div>
<div class="line">            {</div>
<div class="line">                Debug.LogError(<span class="stringliteral">&quot;The bone &quot;</span> + unityBoneType + <span class="stringliteral">&quot; is not found (check configuration of the humanoid in the Rig tab)&quot;</span>);</div>
<div class="line">                enabled = <span class="keyword">false</span>;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span></div>
<div class="line">            {</div>
<div class="line">                item.Bone = bone;</div>
<div class="line">                item.Offset = bone.rotation;</div>
<div class="line">            }</div>
<div class="line">     }</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">Due to the processing specificities of the animator, we use <em>LateUpdate</em> instead of <em>Update</em>. In <em>LateUpdate</em>, we process the skeleton joints (see our <a href="http://download.3divi.com/Nuitrack/doc/UnityAnimation_page.html">Animating the Avatar</a> tutorial).</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> LateUpdate()</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (CurrentUserTracker.CurrentSkeleton != null)</div>
<div class="line">    {</div>
<div class="line">        nuitrack.Skeleton skeleton = CurrentUserTracker.CurrentSkeleton;</div>
<div class="line">        transform.position = Quaternion.Euler(0f, 180f, 0f) * (0.001f * skeleton.GetJoint(nuitrack.JointType.Torso).ToVector3());</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">foreach</span> (SimpleJoint item <span class="keywordflow">in</span> joints)</div>
<div class="line">        {</div>
<div class="line">            nuitrack.Joint joint = skeleton.GetJoint(item.nuitrackJoint);</div>
<div class="line"> </div>
<div class="line">            Quaternion rotation = Quaternion.Inverse(CalibrationInfo.SensorOrientation) * joint.ToQuaternionMirrored() * item.Offset;</div>
<div class="line">            item.Bone.rotation = rotation;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">In the <em>GetHumanBodyBones</em> property, return the list of joints assigned in Unity, which are used to animate this object.</p>
<div class="fragment"><div class="line"><span class="keyword">public</span> HumanBodyBones[] GetHumanBodyBones</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">get</span></div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">return</span> joints.Select(x =&gt; x.nuitrackJoint.ToUnityBones()).ToArray();</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">The <em>GetAnimator</em> property returns the animator.</p>
<div class="fragment"><div class="line"><span class="keyword">public</span> Animator GetAnimator</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">get</span></div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">return</span> animator;</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
Check the operation of the <em>HumanoidRecorder</em> script: drag-and-drop the script to the model and assign the animator and Nuitrack joints that you'd like to animate. At this point, the avatar should move. </li>
<li>
<p class="startli">Create a new script named <em>HumanoidRecorder</em> and inherit it from the <em>IRecordable</em> interface. Create the <em>time</em> variable (current time). Declare the <a href="https://docs.unity3d.com/ScriptReference/HumanPose.html">HumanPose</a> object, which is used to store the model position. The <a href="https://docs.unity3d.com/ScriptReference/HumanPoseHandler.html">HumanPoseHandler</a> is the handler of <em>HumanPose</em> (requested from the animator). Create two dictionaries: one for muscles and one for the root object position. Create the <em>rootOffset</em> variable to correct the model position (because not a user but a sensor is located in the center).</p>
<div class="fragment"><div class="line"><span class="keyword">using</span> UnityEngine;</div>
<div class="line"><span class="keyword">using</span> System.Collections.Generic;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">public</span> <span class="keyword">class </span>HumanoidRecoder : IRecordable</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">float</span> time = 0;</div>
<div class="line"> </div>
<div class="line">    HumanPose humanPose = <span class="keyword">new</span> HumanPose();  </div>
<div class="line">    HumanPoseHandler humanPoseHandler;</div>
<div class="line">     </div>
<div class="line"> </div>
<div class="line">    Dictionary&lt;int, AnimationCurve&gt; muscleCurves = <span class="keyword">new</span> Dictionary&lt;int, AnimationCurve&gt;();</div>
<div class="line">    Dictionary&lt;string, AnimationCurve&gt; rootCurves = <span class="keyword">new</span> Dictionary&lt;string, AnimationCurve&gt;();</div>
<div class="line"> </div>
<div class="line">    Vector3 rootOffset;</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">In the <em>HumanoidRecorder</em> constructor, specify the <em>rootOffset</em> and initialize <em>humanPoseHandler</em> (pass the parameters <em>animator avatar</em> and <em>root transform</em>). Get information about the muscles that are used to animate the avatar: loop over the joints by the <em>dof</em> (“degree of freedom”) indices, request a muscle index for a given joint for each degree of freedom. Pass the muscles with indices to the dictionary. Pass the root object position to <em>rootCurves</em>.</p>
<div class="fragment"><div class="line"><span class="keyword">public</span> HumanoidRecoder(Animator animator, HumanBodyBones[] humanBodyBones)</div>
<div class="line">{</div>
<div class="line">    rootOffset = animator.transform.position;</div>
<div class="line">    humanPoseHandler = <span class="keyword">new</span> HumanPoseHandler(animator.avatar, animator.transform);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">foreach</span> (HumanBodyBones unityBoneType <span class="keywordflow">in</span> humanBodyBones)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> dofIndex = 0; dofIndex &lt; 3; dofIndex++)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordtype">int</span> muscle = HumanTrait.MuscleFromBone((<span class="keywordtype">int</span>)unityBoneType, dofIndex);</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">if</span> (muscle != -1)</div>
<div class="line">                muscleCurves.Add(muscle, <span class="keyword">new</span> AnimationCurve());</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    rootCurves.Add(<span class="stringliteral">&quot;RootT.x&quot;</span>, <span class="keyword">new</span> AnimationCurve());</div>
<div class="line">    rootCurves.Add(<span class="stringliteral">&quot;RootT.y&quot;</span>, <span class="keyword">new</span> AnimationCurve());</div>
<div class="line">    rootCurves.Add(<span class="stringliteral">&quot;RootT.z&quot;</span>, <span class="keyword">new</span> AnimationCurve());</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">In the <em>TakeSnapShot</em> method, take snaphots of the avatar and save to <em>humanPose</em>. Loop over the muscles and set the values to the curve. In the same method, save all the data for an animation clip. Pass the key to the animation curve. Save the root object position to move the model in the scene.</p>
<div class="fragment"><div class="line"><span class="keyword">public</span> <span class="keywordtype">void</span> TakeSnapshot(<span class="keywordtype">float</span> deltaTime)</div>
<div class="line">{</div>
<div class="line">    time += deltaTime;</div>
<div class="line"> </div>
<div class="line">    humanPoseHandler.GetHumanPose(ref humanPose);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">foreach</span> (KeyValuePair&lt;int, AnimationCurve&gt; data <span class="keywordflow">in</span> muscleCurves)</div>
<div class="line">    {</div>
<div class="line">        Keyframe key = <span class="keyword">new</span> Keyframe(time, humanPose.muscles[data.Key]);</div>
<div class="line">        data.Value.AddKey(key);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    Vector3 rootPosition = humanPose.bodyPosition - rootOffset;</div>
<div class="line"> </div>
<div class="line">    AddRootKey(<span class="stringliteral">&quot;RootT.x&quot;</span>, rootPosition.x);</div>
<div class="line">    AddRootKey(<span class="stringliteral">&quot;RootT.y&quot;</span>, rootPosition.y);</div>
<div class="line">    AddRootKey(<span class="stringliteral">&quot;RootT.z&quot;</span>, rootPosition.z);</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">In the <em>AddRootKey</em> method, get the property and values, create the <em>Keyframe</em> key and add to the <em>rootCurves</em> dictionary. Add RootKey (x, y, z).</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> AddRootKey(<span class="keywordtype">string</span> property, <span class="keywordtype">float</span> value)</div>
<div class="line">{</div>
<div class="line">    Keyframe key = <span class="keyword">new</span> Keyframe(time, value);</div>
<div class="line">    rootCurves[property].AddKey(key);</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">In the <em>GetClip</em>, create an animation clip. To do that, loop over the muscles and pass the curves to the clip. Do the same thing for <em>rootCurves</em>. Congrats, we've created a brand new clip with the humanoid animation!</p>
<div class="fragment"><div class="line"><span class="keyword">public</span> AnimationClip GetClip</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">get</span></div>
<div class="line">    {</div>
<div class="line">        AnimationClip clip = <span class="keyword">new</span> AnimationClip();</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">foreach</span> (KeyValuePair&lt;int, AnimationCurve&gt; data <span class="keywordflow">in</span> muscleCurves)</div>
<div class="line">        {</div>
<div class="line">            clip.SetCurve(null, typeof(Animator), HumanTrait.MuscleName[data.Key], data.Value);</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">foreach</span> (KeyValuePair&lt;string, AnimationCurve&gt; data <span class="keywordflow">in</span> rootCurves)</div>
<div class="line">        {</div>
<div class="line">            clip.SetCurve(null, typeof(Animator), data.Key, data.Value);</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">return</span> clip;</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">Go back to the <em>UnityAnimationRecorder</em> script and add the fields for this animation type. Add Humanoid Animation to the <em>Start</em> method.</p>
<div class="fragment"><div class="line">[Header(<span class="stringliteral">&quot;Humanoid Animations&quot;</span>)]</div>
<div class="line">[SerializeField] AnimatorAvatar animatorAvatar;</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> Start()</div>
<div class="line">{</div>
<div class="line">…</div>
<div class="line">        <span class="keywordflow">case</span> RecordMode.Humanoid:</div>
<div class="line">            recordable = <span class="keyword">new</span> HumanoidRecoder(animatorAvatar.GetAnimator, animatorAvatar.GetHumanBodyBones);</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">In Unity, set up the recording of avatar animation. Select the humanoid record mode (<b>Recorder → Record Mode → Humanoid</b>) and avatar (<b>Animator Avatar → Ethan (AnimatorAvatar)</b>), update the root object: <b>Root → Ethan</b> (new model).</p>
<div class="image">
<img src="Umc_14.png" alt="Umc_14.png"/>
</div>
 <p class="endli"></p>
</li>
<li>
Run the project. Now you can check the animation from the Inspector tab without adding it to the model. </li>
</ol>
<div class="image">
<img src="Umc_15.gif" alt="Umc_15.gif"/>
</div>
 <p>You can check the animation on any model with Humanoid animation type. Below you can see our recorded animation applied to a standard Unity model.</p>
<div class="image">
<img src="Umc_16.gif" alt="Umc_16.gif"/>
</div>
  </div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="UnityTutorials_page.html">Unity Tutorials</a></li>
    <li class="footer">Generated on Thu Aug 22 2019 12:41:46 for Nuitrack by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.6 </li>
  </ul>
</div>
</body>
</html>
