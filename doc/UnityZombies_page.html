<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>Nuitrack: Zombie Nightmare (Oculus Rift)</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen_html_style.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="nuitrack.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Nuitrack
   &#160;<span id="projectnumber">1.4.1</span>
   </div>
   <div id="projectbrief">3D Skeleton Tracking Middleware</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('UnityZombies_page.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Properties</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Events</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(11)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Zombie Nightmare (Oculus Rift) </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#zombies_settings">Setting Up the Project</a></li>
<li class="level1"><a href="#zombies_legs">Creating the Player's Legs</a></li>
<li class="level1"><a href="#zombies_logic">Determining the Game Logic</a></li>
<li class="level1"><a href="#zombies_player">Creating the Player and Zombies</a></li>
</ul>
</div>
<div class="textblock"><p>In this tutorial you'll learn how to create a super duper cool project using Oculus Rift and Nuitrack. We'll create a VR game called "Zombie Nightmare". The player's goal is to kill all zombies that randomly appear from everywhere. The player has a limited number of lives. If a zombie takes a bite of a player, the player's health slightly decreases and eventually he can die :( So what is that bewitching little detail of that seemingly trivial project? The point is that the player has to destroy zombies not with his hands... but with his <b>LEGS</b>! Have you ever used your legs when playing with Oculus Rift? We haven't! And now your wildest dreams come true thanks to Nuitrack!</p>
<div class="image">
<img src="Uzombies_10.gif" alt="Uzombies_10.gif"/>
</div>
 <p>You'll need just a couple of things for this project:</p>
<p>Hardware: </p>
<ul>
<li>
Powerful PC (check out <a href="https://support.oculus.com/170128916778795/">minimum system specifications</a>) </li>
<li>
Oculus Rift (headset + 2 sensors + Oculus Touches) </li>
<li>
Depth sensor (see the list of supported cameras at <a href="https://nuitrack.com/">our website</a>) </li>
</ul>
<p>Software: </p>
<ul>
<li>
Nuitrack (we used 0.23.1) </li>
<li>
Windows (we used Windows 10) </li>
<li>
<a href="https://assetstore.unity.com/packages/tools/integration/oculus-integration-82022">Oculus Integration</a> package from Unity Asset Store </li>
<li>
<a href="https://assetstore.unity.com/packages/templates/packs/nuitrack-skeleton-tracking-127675">Nuitrack Skeleton Tracking</a> package from Unity Asset Store </li>
<li>
Unity (2017.4 or higher) </li>
</ul>
<p>You can find the finished project in <b>Nuitrack SDK: Unity 3D → NuitrackSDK.unitypackage → Tutorials → Zombie Nightmare (RIFT)</b></p>
<h1><a class="anchor" id="zombies_settings"></a>
Setting Up the Project</h1>
<ol>
<li>
Create a new project and name it as you wish (for example, “Incredible Zombie Game with Nuitrack”). </li>
<li>
Download <a href="https://assetstore.unity.com/packages/templates/packs/nuitrack-skeleton-tracking-127675">Nuitrack Skeleton Tracking package</a> from Unity Asset Store and import it to the project: <b>Assets → Import Package → Custom Package</b>. </li>
<li>
<p class="startli">Open the scene <b>"City" (Nuitrack SDK → Tutorials → Zombie Nightmare (RIFT) → City)</b>. Our zombie apocalypse begins in a developed megalopolis (New York? Who knows...).</p>
<div class="image">
<img src="Uzombies_2.png" alt="Uzombies_2.png"/>
</div>
 <p class="endli"></p>
</li>
<li>
Download <a href="https://assetstore.unity.com/packages/tools/integration/oculus-integration-82022">Oculus Integration package</a> from Unity Asset Store, which provides Advanced Oculus Rift, Touch, and Gear VR support for rendering, audio, social, and avatars, and import it to the project. </li>
<li>
<p class="startli">Enable VR support in Unity settings: <b>Build Settings → Player Settings → XR Settings → Virtual Reality Supported</b>.</p>
<div class="image">
<img src="Uzombies_3.png" alt="Uzombies_3.png"/>
</div>
 <p class="endli"></p>
</li>
<li>
<p class="startli">Drag-and-drop the <b>OVRCameraRig</b> prefab to the scene: <b>Assets → Oculus → VR → Prefabs</b>. This is gonna be the player's head. Set its Position/Rotation/Scale to (0, 0, 0) so that the player is standing in the center of the scene (as he is the new hope of mankind in our game). Set <b>Tracking Origin Type</b> in settings of the <b>OVRCameraRig</b> prefab: <b>OVRManager → Tracking → Tracking Origin Type → Floor Level</b> so that the camera is located at the player's height level.</p>
<div class="image">
<img src="Uzombies_4.png" alt="Uzombies_4.png"/>
</div>
 <p class="endli"></p>
</li>
<li>
Drag-and-drop the <b>LocalAvatar</b> prefab to the scene: <b>Assets → Oculus → Avatar → Content → Prefabs</b>. This is gonna be the player's body. This body will mesmerize our zombies and they will run towards it. </li>
<li>
<p class="startli">Drag-and-drop the <b>NuitrackScripts</b> prefab to the scene: <b>Nuitrack SDK → Nuitrack → Prefabs</b>. Tick the required modules for user's skeleton tracking: <b>Skeleton Tracker Module On, User Tracker Module On</b>.</p>
<div class="image">
<img src="Uzombies_5.png" alt="Uzombies_5.png"/>
</div>
 <p class="endli"></p>
</li>
</ol>
<h1><a class="anchor" id="zombies_legs"></a>
Creating the Player's Legs</h1>
<ol>
<li>
Create a new script and name it <em>NuitrackLegs.cs</em>. In this script, we'll define the skeleton tracking and create the player's legs. </li>
<li>
<p class="startli">Add the necessary fields. An "offset" is a skeleton offset that is calculated based on the data received from Oculus Rift (head) and Nuitrack (the rest of the skeleton joints).</p>
<div class="fragment"><div class="line"><span class="keyword">public</span> <span class="keyword">class </span>NuitrackLegs : MonoBehaviour </div>
<div class="line">{</div>
<div class="line">    [SerializeField] Transform head;</div>
<div class="line">    [SerializeField] Rigidbody leftLeg, rightLeg;</div>
<div class="line">    [SerializeField] Transform floor; <span class="comment">// correct the position of user&#39;s legs </span></div>
<div class="line">    Vector3 offset;</div>
<div class="line">    Quaternion q180 = Quaternion.Euler(0f, 180f, 0f); <span class="comment">// mirror the joint position</span></div>
<div class="line">    Vector3 newPosLeft, newPosRight; <span class="comment">// position of the left leg and right leg</span></div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">In <em>Update</em>, process the user's skeleton if it is found.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> Update()</div>
<div class="line">{</div>
<div class="line">        <span class="comment">//If a skeleton is detected, process the model</span></div>
<div class="line">        <span class="keywordflow">if</span> (CurrentUserTracker.CurrentSkeleton != null) ProcessSkeleton(CurrentUserTracker.CurrentSkeleton);</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">In <em>ProcessSkeleton</em>, calculate the position of the left leg and right leg (see our <a href="http://download.3divi.com/Nuitrack/doc/UnityAnimation_page.html">Animating the Avatar using Skeleton</a> tutorial for more details), taking into account the offset. In case the user's legs are located below the floor level (in Unity) during the tracking (this may happen if the player sits down, for example), their position will be automatically corrected so that the user's legs won't go underground.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> ProcessSkeleton(nuitrack.Skeleton skeleton)</div>
<div class="line">{</div>
<div class="line">        newPosLeft = q180 * (CalibrationInfo.SensorOrientation * (0.001f * skeleton.GetJoint(nuitrack.JointType.LeftAnkle).ToVector3())) + offset;</div>
<div class="line"> </div>
<div class="line">        newPosRight = q180 * (CalibrationInfo.SensorOrientation * (0.001f * skeleton.GetJoint(nuitrack.JointType.RightAnkle).ToVector3())) + offset;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (newPosLeft.y &lt; floor.position.y)</div>
<div class="line">        {</div>
<div class="line">                 newPosLeft = <span class="keyword">new</span> Vector3(newPosLeft.x, floor.position.y, newPosLeft.z);</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (newPosRight.y &lt; floor.position.y)</div>
<div class="line">        {</div>
<div class="line">                 newPosRight = <span class="keyword">new</span> Vector3(newPosRight.x, floor.position.y, newPosRight.z);</div>
<div class="line">        }</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">Calculate the offset for the whole skeleton (head joint position detected by Nuitrack is subtracted from head position detected by Oculus Rift).</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> ProcessSkeleton(nuitrack.Skeleton skeleton)</div>
<div class="line">{</div>
<div class="line">...</div>
<div class="line">         offset = head.position - (q180 * (CalibrationInfo.SensorOrientation * (0.001f * skeleton.GetJoint(nuitrack.JointType.Head).ToVector3())));</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">In <em>FixedUpdate</em>, apply the coordinates to the user's legs. We use <em>FixedUpdate</em> instead of <em>Update</em> for that purpose because Unity physics is only processed in this method.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> FixedUpdate () </div>
<div class="line">{</div>
<div class="line">        leftLeg.MovePosition(newPosLeft);</div>
<div class="line">        rightLeg.MovePosition(newPosRight);</div>
<div class="line">}</div>
</div><!-- fragment --><dl class="section note"><dt>Note</dt><dd>Learn more about the <em>MovePosition</em> method at <a href="https://docs.unity3d.com/ScriptReference/Rigidbody.MovePosition.html">Unity website</a>.</dd></dl>
</li>
<li>
Drag-and-drop the script to the <b>LocalAvatar</b> prefab. </li>
<li>
<p class="startli">Set the fields in the prefab settings:</p>
<p><b>Head - CenterEyeAnchor</b> (from the <b>OVRCameraRig</b> prefab)<br/>
 <b>LeftLeg - leg Left</b> (from hierarchy)<br/>
 <b>RightLeg - leg Right</b> (from hierarchy)<br/>
 <b>Floor - FLOOR</b> (from hierarchy)<br/>
</p>
<div class="image">
<img src="Uzombies_6.png" alt="Uzombies_6.png"/>
</div>
 <p class="endli"></p>
</li>
<li>
<p class="startli">Run the project. You should see your feet displayed as nice blue sneakers. Movement is tracked by Nuitrack. You will also see the "screen" with the user's segment that helps to check FPS and understand whether the user's legs are in the frame or not.</p>
<div class="image">
<img src="Uzombies_1.gif" alt="Uzombies_1.gif"/>
</div>
 <dl class="section note"><dt>Note</dt><dd>You can use not only leg joints but also all other skeleton joints detected by Nuitrack (21 joints all in all) (see the complete list at <a href="http://download.3divi.com/Nuitrack/doc/group__SkeletonTracker__group.html#gabc259a32c94594974dd3325b7c72d28a">Nuitrack official website</a>). Don't forget to add the offset!</dd></dl>
</li>
</ol>
<h1><a class="anchor" id="zombies_logic"></a>
Determining the Game Logic</h1>
<ol>
<li>
Create a new script and name it <em>GameManager.cs</em>. In this script, we'll describe the end and restart of our game and when the zombies appear. </li>
<li>
<p class="startli">Add the necessary fields: maximum number of spawned zombies, an array with enemies, an array with spawn points for zombies, restart time after the player's death and counter for spawned zombies.</p>
<div class="fragment"><div class="line"><span class="keyword">public</span> <span class="keyword">class </span>GameManager: MonoBehaviour </div>
<div class="line">{</div>
<div class="line">    [SerializeField] <span class="keywordtype">int</span> maxEnemies = 100;</div>
<div class="line"> </div>
<div class="line">    [SerializeField] GameObject[] enemies;</div>
<div class="line">    [SerializeField] Transform[] spawnPoints;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">float</span> restartTime = 5;</div>
<div class="line">    <span class="keywordtype">int</span> enemiesCount = 0;</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">In <em>Start</em>, the constantly repeated method <em>SpawnEnemy</em> defines that the zombies spawn in 3 seconds after start every 0.2 seconds. If maximum number of spawned zombies is reached, the method is not executed anymore. Before spawning, the size of each zombie is a bit changed (so they don't look like a uniform bunch).</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> Start()</div>
<div class="line">{</div>
<div class="line">        InvokeRepeating(<span class="stringliteral">&quot;SpawnEnemy&quot;</span>, 3, 0.2f);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> SpawnEnemy()</div>
<div class="line">{</div>
<div class="line">        <span class="keywordflow">if</span> (enemiesCount &gt;= maxEnemies)</div>
<div class="line">            <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordtype">float</span> randomSize = Random.Range(0.2f, 0.3f); <span class="comment">// zombie size</span></div>
<div class="line"> </div>
<div class="line">        enemies[Random.Range(0, enemies.Length)].transform.localScale = Vector3.one * randomSize; <span class="comment">// set the zombie size</span></div>
<div class="line">        Instantiate(enemies[Random.Range(0, enemies.Length)], spawnPoints[Random.Range(0, spawnPoints.Length)].position, Quaternion.identity); <span class="comment">// spawn zombies </span></div>
<div class="line"> </div>
<div class="line">        enemiesCount++;</div>
<div class="line">}</div>
</div><!-- fragment --><dl class="section note"><dt>Note</dt><dd>The <a href="https://docs.unity3d.com/ScriptReference/MonoBehaviour.InvokeRepeating.html">InvokeRepeating</a> method cyclically calls the required method at regular time intervals.</dd></dl>
</li>
<li>
<p class="startli">The <em>GameOver</em> method initiates the execution of the <em>Restart</em> method, which restarts the game after a certain time and starts a new level.</p>
<div class="fragment"><div class="line"><span class="keyword">public</span> <span class="keywordtype">void</span> GameOver()</div>
<div class="line">{</div>
<div class="line">        StartCoroutine(Restart());</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">IEnumerator Restart()</div>
<div class="line">{</div>
<div class="line">        yield <span class="keywordflow">return</span> <span class="keyword">new</span> WaitForSeconds(restartTime);</div>
<div class="line">        Application.LoadLevel(Application.loadedLevel);</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
In Unity, create an <b>Empty Object</b> (<b>GameObject → Create Empty</b>) and name it <b>GameManager</b>. Drag-and-drop the script to this object. </li>
<li>
<p class="startli">In settings of the <b>GameManager</b> object, fill in the enemies field with zombies: <b>Tutorials → Zombie Nightmare (RIFT) → Prefabs</b> (<b>Parasite, Hulk, Zombie Police</b>).</p>
<div class="image">
<img src="Uzombies_8.png" alt="Uzombies_8.png"/>
</div>
 <p class="endli"></p>
</li>
<li>
<p class="startli">Set the spawn points for zombies as well: <b>Spawn Points → SpawnPoint(1)(Transform), SpawnPoint(2)(Transform)</b> (from hierarchy).</p>
<div class="image">
<img src="Uzombies_9.png" alt="Uzombies_9.png"/>
</div>
 <p class="endli"></p>
</li>
<li>
Run the project. The zombies will randomly appear on the scene (this looks pretty funny). </li>
</ol>
<div class="image">
<img src="Uzombies_7.gif" alt="Uzombies_7.gif"/>
</div>
 <h1><a class="anchor" id="zombies_player"></a>
Creating the Player and Zombies</h1>
<ol>
<li>
Time to create a savior of our little world! Create a new script and name it <em>Player.cs</em>. </li>
<li>
<p class="startli">Add the necessary fields: health score and healthbar.</p>
<div class="fragment"><div class="line"><span class="keyword">public</span> <span class="keyword">class </span>Player : MonoBehaviour </div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">float</span> health = 100;</div>
<div class="line">    [SerializeField] UnityEngine.UI.Image healthBar;</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">In the <em>GetDamage</em> method, set the damage from a zombie to the player. If the player has 0 lives, the remaining code is not executed. If the player has enough lives, he loses health when a zombie bites him (healthbar turns red) or, otherwise, dies (obviously). After the player's death (the <em>Death</em> method) the level restarts in 3 seconds.</p>
<div class="fragment"><div class="line"><span class="keyword">public</span> <span class="keywordtype">void</span> GetDamage(<span class="keywordtype">float</span> damage)</div>
<div class="line">{</div>
<div class="line">        <span class="keywordflow">if</span> (health &lt;= 0)</div>
<div class="line">                 <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">        health -= damage;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span>(health &lt;= 0)</div>
<div class="line">        {</div>
<div class="line">                 health = 0;</div>
<div class="line">                 FindObjectOfType&lt;GameManager&gt;().GameOver();</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        healthBar.fillAmount = health / 100;</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">Drag-and-drop the script to <b>localAvatar - base</b>, add <b>healthbar</b> from <b>Canvas</b>.</p>
<div class="image">
<img src="Uzombies_11.png" alt="Uzombies_11.png"/>
</div>
 <p class="endli"></p>
</li>
<li>
<p class="startli">Select <b>base</b>, add <b>Capsule Collider</b> and <b>Rigidbody</b>, tick <b>Is Kinematic</b> (so that the capsule doesn't fall) and set the settings as shown in the screenshot (zombies will encircle the player).</p>
<div class="image">
<img src="Uzombies_12.png" alt="Uzombies_12.png"/>
</div>
 <p class="endli"></p>
</li>
<li>
And now it's time to create a devil's brat, an evil itself – a zombie. Create a new script and name it <em>ZombieController.cs</em>. In this script, we'll describe the behavior of zombies in our game. </li>
<li>
<p class="startli">Add the necessary fields.</p>
<div class="fragment"><div class="line"><span class="keyword">public</span> <span class="keyword">class </span>ZombieController : MonoBehaviour</div>
<div class="line">{</div>
<div class="line">    [SerializeField] <span class="keywordtype">int</span> hp = 100; <span class="comment">// health of a zombie</span></div>
<div class="line">    [SerializeField] <span class="keywordtype">float</span> damage = 0.01f; <span class="comment">// damage from a zombie</span></div>
<div class="line">    [SerializeField] <span class="keywordtype">float</span> speed = 1; <span class="comment">// speed of a zombie</span></div>
<div class="line">    [SerializeField] Transform floorChecker; <span class="comment">// used to switch Ragdoll</span></div>
<div class="line">    [SerializeField] Animator animator; <span class="comment">// used to control the animation of zombies</span></div>
<div class="line">    [SerializeField] <span class="keywordtype">float</span> attackDistance = 0.7f; <span class="comment">// attacking distance of a zombie</span></div>
<div class="line">    [SerializeField] Transform modelTransform; <span class="comment">// used to process Ragdoll</span></div>
<div class="line">    <span class="keywordtype">float</span> standTime = 0, flyTime = 0; <span class="comment">// time on the ground and in flight</span></div>
<div class="line">    <span class="keywordtype">bool</span> isOnGround = <span class="keyword">false</span>; <span class="comment">// check whether the zombie is on the ground or not</span></div>
<div class="line">    <span class="keywordtype">bool</span> isFly = <span class="keyword">false</span>; <span class="comment">// check whether the zombie is in flight or not</span></div>
<div class="line">    <span class="keywordtype">bool</span> isRagdoll = <span class="keyword">true</span>; <span class="comment">// is Ragdoll on?</span></div>
<div class="line">    <span class="keywordtype">bool</span> canAttack = <span class="keyword">false</span>, prevCanAttack = <span class="keyword">false</span>; <span class="comment">// can a zombie attack?</span></div>
<div class="line"> </div>
<div class="line">    Player target; <span class="comment">// target for a zombie attack (player)</span></div>
<div class="line">    Rigidbody rb;</div>
<div class="line"> </div>
<div class="line">    Rigidbody[] rigidbodyRagdoll;</div>
<div class="line">    Collider[] colliderRagdoll;</div>
<div class="line"> </div>
<div class="line">    Vector3 localPosition; <span class="comment">// modelTransform position of a zombie </span></div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">In the <em>Awake</em> method, get <em>localPosition</em> and <em>modelTransform</em> from a zombie, save the start local coordinates of the zombie's child object, which will be ragdolled, so that we can return this child object to its original position when Ragdoll is finished.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> Awake()</div>
<div class="line">{</div>
<div class="line">        localPosition = modelTransform.localPosition;</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">In <em>Start</em>, get the references to <em>Rigidbody</em> and <em>Colliders</em> of zombie's body parts and zombie's main Rigidbody for later use in <em>Ragdoll</em> processing. Disable <em>Ragdoll</em> and find the target (player) for a zombie.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> Start()</div>
<div class="line">{</div>
<div class="line">        rigidbodyRagdoll = GetComponentsInChildren&lt;Rigidbody&gt;();</div>
<div class="line">        colliderRagdoll = GetComponentsInChildren&lt;Collider&gt;();</div>
<div class="line">        rb = GetComponent&lt;Rigidbody&gt;();</div>
<div class="line"> </div>
<div class="line">        SwitchRagdoll(<span class="keyword">false</span>); <span class="comment">// disable ragdoll</span></div>
<div class="line">        target = FindObjectOfType&lt;Player&gt;(); <span class="comment">// find the target for zombies</span></div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">Process the zombie Ragdoll switching in the <em>switchRagdoll</em> method. Ragdoll is enabled when we just gave a zombie a good kick and he flew away like a bird. We need to use Ragdoll so our zombies flies nice and good, otherwise he will just “walk on skies”. Ragdoll is disabled when the zombie has landed and lay on the ground for like 2 seconds.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> SwitchRagdoll(<span class="keywordtype">bool</span> ragdoll)</div>
<div class="line">{</div>
<div class="line">        <span class="keywordflow">if</span> (ragdoll != isRagdoll)</div>
<div class="line">        {</div>
<div class="line">                 <span class="keywordflow">if</span> (ragdoll) <span class="comment">// If ragdoll is off</span></div>
<div class="line">                 {</div>
<div class="line">                <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; rigidbodyRagdoll.Length; i++)</div>
<div class="line">                {</div>
<div class="line">                         rigidbodyRagdoll[i].isKinematic = <span class="keyword">false</span>; <span class="comment">// Physics is turned on</span></div>
<div class="line">                         rigidbodyRagdoll[i].velocity = rb.velocity; <span class="comment">// When ragdoll is on, the speed of the main Rigidbody component is passed to the child Rigidbody components so they continue to fly according to physics</span></div>
<div class="line">                 }</div>
<div class="line">                 }</div>
<div class="line">                 <span class="keywordflow">else</span> <span class="comment">// If ragdoll is off</span></div>
<div class="line">                 {</div>
<div class="line">                     <span class="comment">// Return position and rotation to original state when Ragdoll is over</span></div>
<div class="line">                     modelTransform.localRotation = Quaternion.identity;</div>
<div class="line">                     transform.position = modelTransform.position; <span class="comment">// When Ragdoll is over, the model base object is brought back to Ragdoll coordinates</span></div>
<div class="line">                     modelTransform.localPosition = localPosition; <span class="comment">// Move the child model to its original local coordinates</span></div>
<div class="line"> </div>
<div class="line">                     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; rigidbodyRagdoll.Length; i++)</div>
<div class="line">                     {</div>
<div class="line">                              rigidbodyRagdoll[i].isKinematic = <span class="keyword">true</span>;</div>
<div class="line">                     }</div>
<div class="line">                  }</div>
<div class="line"> </div>
<div class="line">                  rb.isKinematic = ragdoll; <span class="comment">// Switch the basic Ragdoll kinematics</span></div>
<div class="line"> </div>
<div class="line">                  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; colliderRagdoll.Length; i++)</div>
<div class="line">                  {</div>
<div class="line">                colliderRagdoll[i].enabled = ragdoll; <span class="comment">// Switch the Ragdoll colliders</span></div>
<div class="line">                  }</div>
<div class="line"> </div>
<div class="line">                  GetComponent&lt;Collider&gt;().enabled = !ragdoll; <span class="comment">// Switch the base collider</span></div>
<div class="line"> </div>
<div class="line">                  animator.enabled = !ragdoll; <span class="comment">// Switch the animator. When Ragdoll is turned on, еру animator is switched off.</span></div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        isRagdoll = ragdoll;</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">In the <em>IsOnGround</em> method, we check whether the zombie is on the ground or not. Each zombie has the <em>FloorChecker</em> object that helps to check zombie's position. This object is always downwards and can be treated as a point for casting the ray to check the floor position. Create a ray and set it up.</p>
<div class="fragment"><div class="line"><span class="keywordtype">bool</span> IsOnGround() <span class="comment">// Is the zombie on the ground?</span></div>
<div class="line">{</div>
<div class="line">        floorChecker.rotation = Quaternion.identity; <span class="comment">// Fix the object rotation</span></div>
<div class="line">        Vector3 direction = -floorChecker.up; <span class="comment">// Downward direction</span></div>
<div class="line">        <span class="keywordtype">float</span> maxDistance = 0.5f;</div>
<div class="line">        Ray ray = <span class="keyword">new</span> Ray(floorChecker.position, direction); <span class="comment">// Create a ray</span></div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">return</span> Physics.Raycast(ray, maxDistance); <span class="comment">// Return value from the ray</span></div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">In <em>Update</em>, determine the conditions when the zombie can attack and when the attack starts. Also, define the zombie's behavior depending on his state (on the ground, flew and fell on ground, flying). Fortunately, our zombies can fly only after our good kick.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> Update()</div>
<div class="line">{</div>
<div class="line">        <span class="keywordflow">if</span> (hp &lt;= 0)</div>
<div class="line">                 <span class="keywordflow">return</span>; <span class="comment">// If the zombie is dead, the code below is not executed</span></div>
<div class="line"> </div>
<div class="line">        isOnGround = IsOnGround();</div>
<div class="line"> </div>
<div class="line">        canAttack = isOnGround &amp;&amp; Vector3.Distance(transform.position, target.transform.position) &lt;= attackDistance &amp;&amp; hp &gt; 0; <span class="comment">// If the zombie is on the ground, the distance to the player is sufficient and he has enough lives, it&#39;s time to attack </span></div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (canAttack != prevCanAttack) <span class="comment">// Called just once</span></div>
<div class="line">        {</div>
<div class="line">                 prevCanAttack = canAttack;</div>
<div class="line">                 StartCoroutine(Attacking());</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        animator.SetBool(<span class="stringliteral">&quot;Attacking&quot;</span>, canAttack); <span class="comment">// Start &quot;attacking&quot; animation</span></div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (isOnGround)</div>
<div class="line">        {</div>
<div class="line">                 <span class="keywordflow">if</span> (standTime &gt; 2.0f) <span class="comment">// Zombie gets up in 2 seconds</span></div>
<div class="line">                 {</div>
<div class="line">                <span class="keywordflow">if</span>(isRagdoll) <span class="comment">// If Ragdoll was off, turn it on</span></div>
<div class="line">                         SwitchRagdoll(<span class="keyword">false</span>);</div>
<div class="line"> </div>
<div class="line">                transform.LookAt(target.transform); <span class="comment">// Zombie turns to the player</span></div>
<div class="line">                rb.AddForce(transform.forward * speed); <span class="comment">// And runs! </span></div>
<div class="line">                 }</div>
<div class="line"> </div>
<div class="line">                 standTime += Time.deltaTime;</div>
<div class="line"> </div>
<div class="line">                 <span class="keywordflow">if</span> (isFly) <span class="comment">// If the zombie has flown and fallen</span></div>
<div class="line">                 {</div>
<div class="line">                isFly = <span class="keyword">false</span>;</div>
<div class="line"> </div>
<div class="line">                GetDamage((<span class="keywordtype">int</span>)(flyTime * 10)); <span class="comment">// When the zombie falls, he gets damaged depending on the &quot;flight time&quot;</span></div>
<div class="line"> </div>
<div class="line">                flyTime = 0;</div>
<div class="line">                 }</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">        {</div>
<div class="line">                 standTime = 0;</div>
<div class="line">                 isFly = <span class="keyword">true</span>; <span class="comment">// If the zombie is flying</span></div>
<div class="line"> </div>
<div class="line">                 flyTime += Time.deltaTime;</div>
<div class="line"> </div>
<div class="line">                 <span class="keywordflow">if</span> (flyTime &gt;= .1f &amp;&amp; !isRagdoll) <span class="comment">// If the zombie flies for more than 0.1 sec, turn the ragdoll on</span></div>
<div class="line">                SwitchRagdoll(<span class="keyword">true</span>);</div>
<div class="line">        }</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">In <em>IEnumerator Attacking</em> wait for 1 sec and attack (zombie bites every second).</p>
<div class="fragment"><div class="line">IEnumerator Attacking()</div>
<div class="line">{</div>
<div class="line">        yield <span class="keywordflow">return</span> <span class="keyword">new</span> WaitForSeconds(1.0f);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (hp &gt; 0)</div>
<div class="line">        {</div>
<div class="line">                 target.GetDamage(damage);</div>
<div class="line"> </div>
<div class="line">                 <span class="keywordflow">if</span> (canAttack)</div>
<div class="line">                StartCoroutine(Attacking());</div>
<div class="line">        }</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">In the <em>GetDamage</em> method define the damage from the player and from the flight.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> GetDamage(<span class="keywordtype">int</span> damage)</div>
<div class="line">{</div>
<div class="line">        hp -= damage;</div>
<div class="line">        <span class="keywordflow">if</span> (hp &lt;= 0)</div>
<div class="line">                 Death();</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">In the <em>Death</em> method, define the events after the zombie's death. Each zombie has an array with <em>SkinnedMeshRenderers</em> (they're used to display the model). Loop over the array elements and paint the body parts red. Turn the <em>Ragdoll</em> on (so the zombie falls after his death). Destroy the zombie after 5 seconds.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> Death()</div>
<div class="line">{</div>
<div class="line">        SkinnedMeshRenderer[] bodyParts = GetComponentsInChildren&lt;SkinnedMeshRenderer&gt;(); <span class="comment">// Search for zombie parts in the array</span></div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; bodyParts.Length; i++)</div>
<div class="line">        {</div>
<div class="line">                 bodyParts[i].material.color = Color.red; <span class="comment">// Paint the body red  </span></div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        SwitchRagdoll(<span class="keyword">true</span>);</div>
<div class="line"> </div>
<div class="line">        Destroy(gameObject, 5);</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">In the <em>OnCollisionEnter</em> method, define the damage to zombies when the player crushes them with his feet (the player has a collider tagged as <b>Player</b> attached to the bottom of his sneakers - you can use this to smash the zombies).</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> OnCollisionEnter(Collision collision)</div>
<div class="line">{</div>
<div class="line">        <span class="keywordflow">if</span> (collision.transform.tag == <span class="stringliteral">&quot;Player&quot;</span>)</div>
<div class="line">        {</div>
<div class="line">                 GetDamage(10);</div>
<div class="line">        }</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">Select the prefabs <b>Hulk, Zombie Police, Parasite</b> from the <b>Prefabs</b> folder and add a component: <b>Add Component → Zombie Controller</b>.</p>
<div class="image">
<img src="Uzombies_13.png" alt="Uzombies_13.png"/>
</div>
 <dl class="section note"><dt>Note</dt><dd>You can easily create your own zombie if you'd like to:<ol type="1">
<li>Download a zombie model, for example, from <a href="https://www.mixamo.com">this website</a>.</li>
<li>Drag-and-drop it to the scene. Set the size to 0.2 along all axes.</li>
<li>Add <b>Rigidbody</b> and <b>Capsule Collider</b>. Set the size of <b>Capsule Collider</b> and apply the physical material “Bounce Phys Material”.</li>
<li>Open <b>GameObject/3D Object/Ragdoll...</b> In the popup window, fill in the necessary fields and click <b>Create</b>. The body and limbs of a zombie should now have colliders. Perhaps, you'll need to adjust their size manually. Also, we recommend you to tick <b>Enable Projection</b> on <b>CharacterJoint</b> components to prevent excessive movement of skeleton joints.</li>
<li>Select <b>Animator &gt; Controller</b> and apply <b>Controller “Zombie Anim”</b>.</li>
<li>Create an empty object, make it child to Hips (or any similar one) and name it <b>FloorChecker</b>.</li>
<li>Add <b>ZombieController</b>. Fill in the fields.</li>
<li>Save the prefab and delete it from the scene.</li>
</ol>
</dd></dl>
</li>
<li>
<p class="startli">In Unity, select the <b>ZombieController(Script)</b> object and set it up: add <b>Floor Checker</b> to <b>Floor Checker</b>, <b>Animator</b> to <b>Animator</b>, and a child object of a zombie to <b>Model Transform</b> (there is only one child object for each zombie). Drag-and-drop the zombie (prefab) to the scene and click <b>Apply</b> so that the settings take effect. If you want, you can set the damage from a zombie, his speed and lives in settings.</p>
<div class="image">
<img src="Uzombies_14.png" alt="Uzombies_14.png"/>
</div>
 <p class="endli"></p>
</li>
<li>
Run the project. Watch out, a bunch of zombies run toward you and bite you! Kick them off and crush them with your feet! </li>
</ol>
<div class="image">
<img src="Uzombies_10.gif" alt="Uzombies_10.gif"/>
</div>
 <p>You can use this project as a strong base and develop more sophisticated games with Oculus Rift and Nuitrack Skeleton Tracking middleware (though it will be hard to beat such a fascinating game as our “Zombie Nightmare”... just kidding). Have fun! </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="UnityTutorials_page.html">Unity Tutorials</a></li>
    <li class="footer">Generated on Thu Aug 22 2019 12:41:46 for Nuitrack by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.6 </li>
  </ul>
</div>
</body>
</html>
