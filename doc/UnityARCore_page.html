<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>Nuitrack: Creating an AR Football Game using Nuitrack and ARCore</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen_html_style.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="nuitrack.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Nuitrack
   &#160;<span id="projectnumber">1.4.1</span>
   </div>
   <div id="projectbrief">3D Skeleton Tracking Middleware</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('UnityARCore_page.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Properties</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Events</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(11)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Creating an AR Football Game using Nuitrack and ARCore </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#arcore_settings">Setting Up the Project</a></li>
<li class="level1"><a href="#arcore_integration">Integrating ARCore to the Project</a></li>
<li class="level1"><a href="#arcore_multiplayer">Creating a Multiplayer</a></li>
<li class="level1"><a href="#arcore_ball">Creating a Ball</a></li>
<li class="level1"><a href="#arcore_striker">Creating a Striker</a></li>
<li class="level1"><a href="#arcore_sync">Synchronizing the Server and Client</a></li>
</ul>
</div>
<div class="textblock"><p>In this tutorial you'll learn how to create an interesting multiplayer game using <b>ARCore</b> and <b>Nuitrack</b> - we are excited to present you <b>AR Football</b>! At least two players are needed for this game (the more the better). One player - "a striker" - points his Android device's camera at any surface and after that a grid appears on suitable surfaces that you can use to place an ARCore object, which is the goal with a goalkeeper. The striker's goal is to throw the ball and beat the goalkeeper. In turn, the other player - "the goalkeeper" - should catch the ball. The goalkeeper sees the goal on the TV screen or monitor. Several players can play as strikers. Nuitrack tracks the movement of players, the data is synchronized and sent via Wi-Fi network.</p>
<p>You can find the finished project in <b>Nuitrack SDK</b>: <b>Unity 3D → NuitrackSDK.unitypackage → Tutorials → AR Football</b></p>
<div class="image">
<img src="UARCore_1.gif" alt="UARCore_1.gif"/>
</div>
 <p>To create this game, you'll need a couple of things:</p>
<p>Hardware: </p>
<ul>
<li>
<b>TVico</b> (with the pre-installed Nuitrack.apk) or a desktop with a connected sensor from the <a href="https://nuitrack.com/">list of supported devices</a> </li>
<li>
<a href="https://developers.google.com/ar/discover/supported-devices"><b>ARCore compatible device</b></a> </li>
</ul>
<p>Software: </p>
<ul>
<li>
<b>ARCore Unity SDK</b> (we’ve built this project with v1.2.1) </li>
<li>
<b>Nuitrack SDK</b> (we’ve built this project with v1.3.3) </li>
<li>
<b>Unity</b> (2017.4 or higher) </li>
</ul>
<h1><a class="anchor" id="arcore_settings"></a>
Setting Up the Project</h1>
<ol>
<li>
To create an ARCore project, you need to download <a href="https://developers.google.com/ar/develop/downloads">ARCore SDK</a>. </li>
<li>
Create a new Unity project. </li>
<li>
<p class="startli">Select the <b>Android</b> platform in <b>File → Build Settings</b>.</p>
<div class="image">
<img src="UARCore_2.png" alt="UARCore_2.png"/>
</div>
 <p class="endli"></p>
</li>
<li>
<p class="startli">In <b>Player Settings</b>, fill in the <b>Company Name</b> and <b>Product Name</b>.</p>
<div class="image">
<img src="UARCore_3.png" alt="UARCore_3.png"/>
</div>
 <p class="endli"></p>
</li>
<li>
<p class="startli">Go to <b>XR Settings</b> and enable <b>ARCore support</b>.</p>
<div class="image">
<img src="UARCore_4.png" alt="UARCore_4.png"/>
</div>
 <p class="endli"></p>
</li>
<li>
<p class="startli">In <b>Other Settings</b>, select <b>Minimum API Level 7.0</b> (which is required by ARCore), disable <b>Multithreaded Rendering</b> (which is an ARCore requirement as well) and fill in the <b>Package Name</b> in the <b>Identification</b> section.</p>
<div class="image">
<img src="UARCore_5.png" alt="UARCore_5.png"/>
</div>
 <p class="endli"></p>
</li>
<li>
Import <b>Arcore SDK</b> and <b>NuitrackSDk.unitypackage</b> from Nuitrack SDK to your project: <b>Assets → Import Package → Custom Package</b>. </li>
</ol>
<h1><a class="anchor" id="arcore_integration"></a>
Integrating ARCore to the Project</h1>
<ol>
<li>
<p class="startli">This project is based on the <b>HelloAR</b> project, which is a simple example of using ARCore by Google. Create a new scene and name it, for example, <b>Striker</b>. Delete <b>Main Camera</b> and <b>Directional Light</b> from the scene as we’ll need other objects in this project. Copy all the objects from the HelloAR scene to this scene (<b>Google ARCore → Examples → HelloAR → Scenes → HelloAR</b>): </p>
<ul>
<li>
<b>ARCore Device</b> - an object that contains the camera. The camera moves according to the movement of an Android device; the image received from the camera of the Android device becomes the background of the project. </li>
<li>
<b>Canvas</b> - this object is used to display the "Searching for planes" message. </li>
<li>
<b>Example Controller</b> - an object that is responsible for user interaction with gaming ARCore planes. </li>
<li>
<b>Plane Generator</b> - well, you guessed it, this object creates planes. </li>
<li>
<b>Point Cloud</b> - used to visualize a point cloud for creating the planes. </li>
</ul>
<div class="image">
<img src="UARCore_6.png" alt="UARCore_6.png"/>
</div>
 <p class="endli"></p>
</li>
<li>
Drag-and-drop the <b>Environment</b> object from Nuitrack SDK to the scene. This object is very important because it represents a goal with a goalkeeper. </li>
<li>
<p class="startli">Create a new C# Script <em>Environment.cs</em>, in which we'll describe the behavior of this object. This script will contain a reference to the <b>Target</b> object (target for the ball) that's already attached to our prefab. Also, the size of the Environment object will be set at start.</p>
<div class="fragment"><div class="line"><span class="keyword">using</span> UnityEngine;</div>
<div class="line"><span class="keyword">using</span> UnityEngine.Networking;</div>
<div class="line"></div>
<div class="line"><span class="keyword">public</span> <span class="keyword">class </span>Environment : MonoBehaviour {</div>
<div class="line"></div>
<div class="line">    <span class="keyword">public</span> Transform aim;</div>
<div class="line">    [SerializeField] Vector3 clientSize;</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">void</span> Start()</div>
<div class="line">    {</div>
<div class="line">        transform.localScale = clientSize;</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --> </li>
<li>
<p class="startli">Drag-and-drop the <b>Target</b> object to the <b>aim</b> field. Set an appropriate size of the <b>Environment</b> object in the <b>Size</b> field, for example, (0.1,0.1,0.1).</p>
<div class="image">
<img src="UARCore_7.png" alt="UARCore_7.png"/>
</div>
 <p class="endli"></p>
</li>
<li>
Rename <b>Example Controller</b> to <b>Football Controller</b>, just for the sake of convenience. Delete the <em>HelloARController</em> script. Instead, let's create our own script <em>FootballARController.cs</em>: <b>Add Component → C# Script → FootballARController</b>. In this script, we’ll describe interaction of a user with AR. </li>
<li>
Add the <em>GoogleARCore</em> and <em>UnityEngine.Networking</em> namespaces to the script. </li>
<li>
<p class="startli">Add some necessary fields:</p>
<div class="fragment"><div class="line"><span class="comment">// After ARCore finds the anchor points in the real world, the camera starts to move around the scene.</span></div>
<div class="line"><span class="keyword">public</span> Camera mainCamera;</div>
<div class="line"></div>
<div class="line"><span class="comment">// A model to place when a raycast from a user touch hits a plane.</span></div>
<div class="line">GameObject environment;</div>
<div class="line"></div>
<div class="line"><span class="comment">// A gameobject parenting UI for displaying the &quot;searching for planes&quot; snackbar.</span></div>
<div class="line"><span class="comment">// Message &quot;Searching for surfaces&quot;. </span></div>
<div class="line"><span class="keyword">public</span> GameObject searchingForPlaneUI;</div>
<div class="line"></div>
<div class="line"><span class="comment">// The rotation in degrees need to apply to model when model is placed.</span></div>
<div class="line"><span class="keyword">private</span> <span class="keyword">const</span> <span class="keywordtype">float</span> modelRotation = 180.0f; <span class="comment">// Rotate the Environment to make it face the camera.</span></div>
<div class="line"></div>
<div class="line"><span class="comment">// A list to hold all planes ARCore is tracking in the current frame. </span></div>
<div class="line"><span class="comment">// This object is used across the application to avoid per-frame allocations.</span></div>
<div class="line"><span class="keyword">private</span> List&lt;DetectedPlane&gt; allPlanes = <span class="keyword">new</span> List&lt;DetectedPlane&gt;();</div>
<div class="line"></div>
<div class="line">[SerializeField] Transform aRCoreDevice; <span class="comment">// Must be the parent of the camera. </span></div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">Get found surfaces in <em>Update</em>. Create a variable to show / hide a surface. If at least one surface in tracked, the message "Searching for Surface" is hidden.</p>
<div class="fragment"><div class="line"><span class="keyword">public</span> <span class="keywordtype">void</span> Update()</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Hide snackbar when currently tracking at least one plane.</span></div>
<div class="line">    <span class="comment">// Get the list of found surfaces.</span></div>
<div class="line">    Session.GetTrackables&lt;DetectedPlane&gt;(allPlanes);</div>
<div class="line">    <span class="keywordtype">bool</span> showSearchingUI = <span class="keyword">true</span>;</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; allPlanes.Count; i++)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// If at least one surface is tracked, the searching stops.</span></div>
<div class="line">        <span class="keywordflow">if</span> (allPlanes[i].TrackingState == TrackingState.Tracking)</div>
<div class="line">        {</div>
<div class="line">            showSearchingUI = <span class="keyword">false</span>;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Hide or show the message &quot;Searching for Surfaces...&quot;</span></div>
<div class="line">    searchingForPlaneUI.SetActive(showSearchingUI);</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">In <em>Update</em>, check whether the "striker" user touches the screen or not.</p>
<div class="fragment"><div class="line"><span class="comment">// If the player has not touched the screen, we are done with this update.</span></div>
<div class="line">Touch touch;</div>
<div class="line"><span class="keywordflow">if</span> (Input.touchCount &lt; 1 || (touch = Input.GetTouch(0)).phase != TouchPhase.Began)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">In <em>Update</em>, create a variable to store the information about the ray (after the user touched the screen). It stores the coordinates of the place, from where the ray is cast. Add the filter that specifies the surfaces for collision with the ray.</p>
<div class="fragment"><div class="line"><span class="comment">// Raycast against the location the player touched to search for planes.</span></div>
<div class="line">TrackableHit hit;</div>
<div class="line">TrackableHitFlags raycastFilter = TrackableHitFlags.PlaneWithinPolygon |</div>
<div class="line">TrackableHitFlags.FeaturePointWithSurfaceNormal;</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">In <em>Update</em>, process the raycasting: we make sure that the surface is tracked and then cast the ray from the appropriate side (because it’s against the football rules to throw the ball in the back of the goalkeeper). Then we process the throwing of a ball. The goal should be placed on the way of the ball; if not, we place the goal with the goalkeeper (<b>Environment</b>) and turn it accordingly. In this project, we use two rays - one is an ARCore ray (detects the surfaces), and the other is a Unity ray (which detects the required Unity object, the goal).</p>
<div class="fragment"><div class="line">environment = FindObjectOfType&lt;Environment&gt;();</div>
<div class="line"></div>
<div class="line"><span class="comment">// Casting the ray to the surface found by ARCore.</span></div>
<div class="line"><span class="keywordflow">if</span> (Frame.Raycast(touch.position.x, touch.position.y, raycastFilter, out hit))</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Use hit pose and camera pose to check if hittest is from the</span></div>
<div class="line">    <span class="comment">// back of the plane, if it is, no need to create the anchor.</span></div>
<div class="line">    <span class="keywordflow">if</span> ((hit.Trackable is DetectedPlane) &amp;&amp;</div>
<div class="line">        Vector3.Dot(mainCamera.transform.position - hit.Pose.position,</div>
<div class="line">            hit.Pose.rotation * Vector3.up) &lt; 0)</div>
<div class="line">    {</div>
<div class="line">        Debug.Log(<span class="stringliteral">&quot;Hit at back of the current DetectedPlane&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// If the ball touched the correct (not reversed) side of the surface, check, whether there is the goal along the way  If the surface is &quot;empty&quot;, place the goal. If there is the goal, then kick the ball.</span></div>
<div class="line">        <span class="keywordflow">if</span> (KickBall() == <span class="keyword">false</span> &amp;&amp; environment)</div>
<div class="line">        {</div>
<div class="line">            environment.transform.position = hit.Pose.position;</div>
<div class="line">            environment.transform.rotation = hit.Pose.rotation;</div>
<div class="line">            environment.transform.Rotate(0, modelRotation, 0, Space.Self);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"><span class="keywordflow">else</span></div>
<div class="line">{</div>
<div class="line">    <span class="comment">// If there are no surfaces but the goal on the way of the ARCore ray, then kick the ball.</span></div>
<div class="line">    KickBall();</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">Check whether there is the goal on the way of the ball: if yes, kick the ball. Set up our ray, which is cast to the place defined by the user's touch. Put the target point if the ball touched anything. In the script, make the camera child to the <b>Environment</b> in order to find the local position (coordinates) of the camera in relation to the <b>Environment</b>. We need to do all that stuff to find the point from which the ball should be thrown. Create a ball on the scene, set its position, rotation and the child object (<b>Environment</b>) (the same settings as the camera). Set the target point. Return the camera to the original position above the <b>ARCoreDevice</b>. The return method returns true only if the ball hit some object (and there was the goal), otherwise false.</p>
<div class="fragment"><div class="line"><span class="comment">// If all conditions are satisfied, kick the ball and return true, otherwise, false.</span></div>
<div class="line"><span class="keywordtype">bool</span> KickBall()</div>
<div class="line">{</div>
<div class="line">    Ray ray = mainCamera.ScreenPointToRay(Input.mousePosition);</div>
<div class="line">    RaycastHit hitRay;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Cast a standard Unity ray.</span></div>
<div class="line">    <span class="keywordflow">if</span> (Physics.Raycast(ray, out hitRay, 100)  &amp;&amp; environment)</div>
<div class="line">    {</div>
<div class="line">        environment.aim.position = hitRay.point;</div>
<div class="line"></div>
<div class="line">        mainCamera.transform.parent = envirnoment.transform; <span class="comment">// Temporarily make the camera child to the Environment.</span></div>
<div class="line">        mainCamera.transform.parent = aRCoreDevice.transform; <span class="comment">// Return the camera.</span></div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">In Unity, set the fields in <b>FootballController</b> as shown in the picture below:</p>
<div class="image">
<img src="UARCore_8.png" alt="UARCore_8.png"/>
</div>
 <p class="endli"></p>
</li>
<li>
<p class="startli">Connect your Android device to the PC and run the project. When a user points the camera of the Android device at real surfaces (for example, a table), he will see a grid. As the user touches the grid, an ARCore goal with a goalkeeper are placed. By default, a user sees one goal with a goalkeeper, which is created automatically after the start of the project.</p>
<div class="image">
<img src="UARCore_9.gif" alt="UARCore_9.gif"/>
</div>
 <dl class="section note"><dt>Note</dt><dd>It's not necessary to build the project to test some ARCore functions - they're available from the Unity editor. You just need to connect your Android device via USB and run the project. If you don't need this function, you can easily disable it: untick <b>Edit/Project Settings/Arcore/Instant Preview enabled</b> </dd></dl>
</li>
</ol>
<h1><a class="anchor" id="arcore_multiplayer"></a>
Creating a Multiplayer</h1>
<p>Since several players can participate in our game (one goalkeeper and several strikers), we have to create a server and client for network play. The goalkeeper will be a server and strikers will connect to it as clients. All players should be in one Wi-Fi network. To connect to the server, a client will only need to press the <b>Connect</b> button.</p>
<ol>
<li>
We'll use <em>Network Manager.cs</em>, which is a standard Unity script for networking. Add a new object to the <b>Striker</b> scene: <b>Empty Object → Network Manager</b>, and add the <b>Network Manager(Script)</b> component. </li>
<li>
Save the <b>Environment</b> prefab and delete it from the scene. </li>
<li>
<p class="startli">Add the <b>Environment</b> prefab to <b>Network Manager</b> to make our system know that this object should be spawned: <b>Network Manager (Script) → Registered Spawnable Prefabs</b>.</p>
<div class="image">
<img src="UARCore_10.png" alt="UARCore_10.png"/>
</div>
 <p class="endli"></p>
</li>
<li>
<p class="startli">The <em>Network Discovery</em> script defines the searching of servers in the local network. This is a standard Unity script as well. We'll modify this script to make our game a little bit simpler for a user. By default, a user has to select the required server from the list of found servers. We'll make this project a bit more user-friendly: the connection to the server will be automatic. Create a new script <em>QuickConnectNetworkDiscovery.cs</em>. The <em>QuickConnectNetworkDiscovery</em> class must inherit from the standard <em>NetworkDiscovery</em> class.</p>
<div class="fragment"><div class="line"><span class="keyword">using</span> UnityEngine.Networking;</div>
<div class="line"></div>
<div class="line"><span class="keyword">public</span> <span class="keyword">class </span>QuickConnectNetworkDiscovery : NetworkDiscovery {</div>
<div class="line"></div>
<div class="line">    <span class="keyword">public</span> <span class="keyword">override</span> <span class="keywordtype">void</span> OnReceivedBroadcast(<span class="keywordtype">string</span> fromAddress, <span class="keywordtype">string</span> data)</div>
<div class="line">    {</div>
<div class="line">        base.OnReceivedBroadcast(fromAddress, data);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span>(NetworkManager.singleton.IsClientConnected()) </div>
<div class="line">            <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">        NetworkManager.singleton.networkAddress = fromAddress; <span class="comment">// Found server IP is added to Network Manager.</span></div>
<div class="line">        NetworkManager.singleton.StartClient(); <span class="comment">// Connection.</span></div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
Drag-and-drop the <em>QuickConnectNetworkDiscovery</em> script to <b>NetworkManager</b>. </li>
<li>
<p class="startli">In Unity, find <b>Network Manager</b>, select <b>QuickConnectNetworkDiscovery</b>, tick <b>Use Network Manager</b> and untick <b>Show GUI</b> to hide a debug menu.</p>
<div class="image">
<img src="UARCore_11.png" alt="UARCore_11.png"/>
</div>
 <p class="endli"></p>
</li>
<li>
Create a new script <em>NetworkController.cs</em>. In this script, we'll create a client and a server, and describe the actions of the server when the client is connected. </li>
<li>
Add the namespaces <em>UnityEngine.UI</em> and <em>UnityEngine.Networking</em>. </li>
<li>
<p class="startli">Add the fields for scores, client / server, text fields. Hide the scores field to prevent setting the scores from the Unity editor.</p>
<div class="fragment"><div class="line">[HideInInspector]<span class="keyword">public</span> <span class="keywordtype">int</span> score;</div>
<div class="line"><span class="keyword">public</span> <span class="keywordtype">bool</span> isClient; <span class="comment">// Select the client or server.</span></div>
<div class="line"></div>
<div class="line">[Header(<span class="stringliteral">&quot;Server&quot;</span>)]</div>
<div class="line">[SerializeField] Text scoreText; <span class="comment">// Scores text.</span></div>
<div class="line">[SerializeField] Text connectionsText; <span class="comment">// Text showing the number of connected clients.</span></div>
<div class="line">[SerializeField]  GameObject environmentPrefab;</div>
<div class="line"></div>
<div class="line">[Header(<span class="stringliteral">&quot;Client&quot;</span>)]</div>
<div class="line">[SerializeField] Text connectText; <span class="comment">// Text showing the connection state.</span></div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
If the <b>GoalKeeper</b> scene is run, the server is started. </li>
<li>
<p class="startli">In the <em>StartClient</em> method, the client is initialized and started. Similar, in the <em>StartServer</em> method the server, as well as the host, are initialized and started. The goalkeeper (as server) will see the scores, and the strikers (the client) will see the number of connected players. The <em>StartClient</em> method is bound to the <b>Connect</b> button.</p>
<div class="fragment"><div class="line"><span class="keyword">private</span> <span class="keywordtype">void</span> Start()</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// If it&#39;s not a client, create a server.</span></div>
<div class="line">    <span class="keywordflow">if</span> (isClient == <span class="keyword">false</span>)</div>
<div class="line">    {</div>
<div class="line">        StartServer();</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">public</span> <span class="keywordtype">void</span> StartClient()</div>
<div class="line">{</div>
<div class="line">    FindObjectOfType&lt;NetworkDiscovery&gt;().Initialize();</div>
<div class="line">    FindObjectOfType&lt;NetworkDiscovery&gt;().StartAsClient();</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> StartServer()</div>
<div class="line">{</div>
<div class="line">    FindObjectOfType&lt;NetworkDiscovery&gt;().Initialize();</div>
<div class="line">    FindObjectOfType&lt;NetworkDiscovery&gt;().StartAsServer();</div>
<div class="line">    NetworkManager.singleton.StartHost();</div>
<div class="line"></div>
<div class="line">    GameObject environment = (GameObject)Instantiate(environmentPrefab);</div>
<div class="line">    NetworkServer.Spawn(environment);</div>
<div class="line">}</div>
</div><!-- fragment --><dl class="section note"><dt>Note</dt><dd>You can learn more about clients and servers in Unity <a href="https://docs.unity3d.com/Manual/UNetDiscovery.html">here</a>.</dd></dl>
</li>
<li>
<p class="startli">In <em>Update</em>, update the text with the scores and number of connected players. Also, we'll add the button showing the text with the connection state (<b>Connect</b> or <b>Connected</b>).</p>
<div class="fragment"><div class="line"><span class="keyword">private</span> <span class="keywordtype">void</span> Update()</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (isClient == <span class="keyword">false</span>)</div>
<div class="line">    {</div>
<div class="line">        scoreText.text = “Scores: ” + score.ToString(); <span class="comment">// Update the scores counter.</span></div>
<div class="line">        connectionsText.text = <span class="stringliteral">&quot;connected: &quot;</span> + NetworkManager.singleton.numPlayers; <span class="comment">//  Number of connected clients.</span></div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">if</span>(NetworkManager.singleton.IsClientConnected())</div>
<div class="line">            connectText.text = <span class="stringliteral">&quot;Connected&quot;</span>;</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">            connectText.text = <span class="stringliteral">&quot;Connect&quot;</span>;</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">Drag-and-drop the <em>NetworkController.cs</em> script to the <b>Network Manager</b>. Tick <b>Is Client</b> (as this script describes the client's behavior).</p>
<div class="image">
<img src="UARCore_12.png" alt="UARCore_12.png"/>
</div>
 <p class="endli"></p>
</li>
<li>
Create a <b>Canvas</b> that will be used to display the <b>Connect</b> button: <b>Create → UI → Canvas</b>. Create a button on it: <b>UI → Button</b> (the <b>Connect</b> button). </li>
<li>
<p class="startli">Select the button and add the object from the scene: <b>Button → OnClick + NetworkManager</b>, then select <b>Function → NetworkController → StartClient()</b> (when we press the button, the <em>StartClient</em> method is called).</p>
<div class="image">
<img src="UARCore_13.png" alt="UARCore_13.png"/>
</div>
 <p class="endli"></p>
</li>
<li>
<p class="startli">Drag-and-drop the text from the <b>Button</b> to the <b>Connect Text</b> field in <b>Network Controller</b>.</p>
<div class="image">
<img src="UARCore_14.png" alt="UARCore_14.png"/>
</div>
 <p class="endli"></p>
</li>
<li>
Create a new scene and name it, for example, <b>GoalKeeper</b>. </li>
<li>
<p class="startli">Set the camera position to (0, 1, -5) so that the goal with the goalkeeper are displayed correctly.</p>
<div class="image">
<img src="UARCore_15.png" alt="UARCore_15.png"/>
</div>
 <p class="endli"></p>
</li>
<li>
<p class="startli">Add the <b>NuitrackScripts</b> prefab from <b>NuitrackSDK.unitypackage</b> to the scene. Tick <b>Skeleton Module On</b> for skeleton tracking.</p>
<div class="image">
<img src="UARCore_16.png" alt="UARCore_16.png"/>
</div>
 <p class="endli"></p>
</li>
<li>
Create a <b>Canvas</b> on this scene and create two text fields - <b>ScoreText</b> and <b>ConnectedText</b> - for displaying the scores and connection text. Place the text fields on the <b>Canvas</b> the way you want. </li>
</ol>
<h1><a class="anchor" id="arcore_ball"></a>
Creating a Ball</h1>
<ol>
<li>
Time to create a ball on the <b>Striker</b> scene! We have to create two objects for the ball: the first object <b>Ball</b> always stays in one place and becomes child to the <b>Environment</b> when a user kicks the ball; the second object <b>Ball Model</b> is child to the <b>Ball</b> and moves when a user kicks the ball. Only the <b>Ball Model</b> object is synchronized. Create <b>Empty → Ball</b> and then add a standard script <b>Network Transform</b>, which synchronizes the movement and rotation of GameObjects across the network. </li>
<li>
<p class="startli">In <b>Network Transform</b>, set <b>Network Send Rate - 0</b> (as we don't synchronize the parent object), the other settings remain the same.</p>
<div class="image">
<img src="UARCore_17.png" alt="UARCore_17.png"/>
</div>
 <p class="endli"></p>
</li>
<li>
<p class="startli">Add one more component to the <b>Ball</b> - <b>Network Transform Child</b> - and set its <b>Network Send Rate</b> to <b>20</b> (20 packages / 1 sec, this will make our ball move smoothly).</p>
<div class="image">
<img src="UARCore_18.png" alt="UARCore_18.png"/>
</div>
 <p class="endli"></p>
</li>
<li>
<p class="startli">Create a child sphere on the <b>Ball</b>: <b>Create 3D → Object → Sphere</b> and call it, for example, <b>Ball Model</b>. Set up the <b>Ball Model</b>: Scale (0.3, 0.3, 0.3), Position (0, 0, 0), Rotation (0, 0, 0).</p>
<div class="image">
<img src="UARCore_19.png" alt="UARCore_19.png"/>
</div>
 <p class="endli"></p>
</li>
<li>
<p class="startli">Add the <b>RigidBody</b> component and untick <b>Use Gravity</b>.</p>
<div class="image">
<img src="UARCore_20.png" alt="UARCore_20.png"/>
</div>
 <p class="endli"></p>
</li>
<li>
<p class="startli">In the <b>Ball</b> object, select <b>Network Transform Child → Target: Ball Model</b> (so that the position of the child object is synchronized between the server and client).</p>
<div class="image">
<img src="UARCore_21.png" alt="UARCore_21.png"/>
</div>
 <p class="endli"></p>
</li>
<li>
<p class="startli">Create a script <em>BallController.cs</em>, in which we'll describe the behaviour of our ball. Add the field <em>startPosition</em> for the initial position of our ball and <em>networkController</em> that we'll use to differentiate the client from server, set its local coordinates and position.</p>
<div class="fragment"><div class="line">[SerializeField]</div>
<div class="line">GameObject ball;</div>
<div class="line">Vector3 startPosition;</div>
<div class="line">Vector3 endPosition;</div>
<div class="line"><span class="keywordtype">float</span> ballSpeed = 3;</div>
<div class="line">Rigidbody rb;</div>
<div class="line"><span class="keywordtype">bool</span> inGame = <span class="keyword">true</span>;</div>
<div class="line">NetworkController networkController;</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> Start()</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Get a reference to the RigidBody component.</span></div>
<div class="line">    rb = GetComponentInChildren&lt;Rigidbody&gt;();</div>
<div class="line">    <span class="comment">// Destroy the ball in 7 seconds after Start.</span></div>
<div class="line">    Destroy(gameObject, 7.0f);</div>
<div class="line">    transform.parent = FindObjectOfType&lt;Environment&gt;().transform;</div>
<div class="line"></div>
<div class="line">    transform.localScale = Vector3.one;</div>
<div class="line">    transform.localPosition = Vector3.zero;</div>
<div class="line">    transform.localEulerAngles = Vector3.zero;</div>
<div class="line"></div>
<div class="line">    ball.transform.localPosition = startPosition;</div>
<div class="line"></div>
<div class="line">    networkController = FindObjectOfType&lt;NetworkController&gt;();</div>
<div class="line">}</div>
</div><!-- fragment --> </li>
<li>
<p class="startli">In <em>Update</em>, define the movement of our ball if it's in play. When the ball is in game, it moves to a specified point. The movement of the ball according to the script and Unity physics is processed on the server. The clients only receives the position of the ball.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> Update () {</div>
<div class="line">    <span class="keywordflow">if</span> (inGame &amp;&amp; networkController.isClient == <span class="keyword">false</span>) </div>
<div class="line">    {</div>
<div class="line">        ball.transform.localPosition = Vector3.MoveTowards(ball.transform.localPosition, endPosition, ballSpeed * Time.deltaTime); <span class="comment">// Current position, end position, speed.</span></div>
<div class="line">        ball.transform.Rotate(Vector3.one * ballSpeed); <span class="comment">// Rotating the ball when it moves (just for fun).</span></div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><dl class="section note"><dt>Note</dt><dd>You can learn more about Vector3.MoveTowards in Unity <a href="https://docs.unity3d.com/ScriptReference/Vector3.MoveTowards.html">here</a>.</dd></dl>
</li>
<li>
<p class="startli">In the <em>Setup</em> method, set the start and end positions of the ball.</p>
<div class="fragment"><div class="line"><span class="keyword">public</span> <span class="keywordtype">void</span> Setup(Vector3 startPos, Vector3 endPos)</div>
<div class="line">{</div>
<div class="line">    endPosition = endPos;</div>
<div class="line">    startPosition = startPos;</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">When the ball touches other objects, the physics is enabled. If the ball touches the hand, one point is added.</p>
<div class="fragment"><div class="line"><span class="keyword">public</span> <span class="keywordtype">void</span> OnCollide(Collision collision)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// If the ball touched something, the inGame variable changes its status to false so that collisions are no longer processed.</span></div>
<div class="line">    <span class="keywordflow">if</span> (inGame &amp;&amp; networkController.isClient == <span class="keyword">false</span>) </div>
<div class="line">    {</div>
<div class="line">        Debug.Log(<span class="stringliteral">&quot;Ball collide&quot;</span>);</div>
<div class="line">        <span class="comment">// If the ball touched the hand, add one point.</span></div>
<div class="line">        <span class="keywordflow">if</span> (collision.transform.tag == <span class="stringliteral">&quot;Hand&quot;</span>)</div>
<div class="line">            FindObjectOfType&lt;NetworkController&gt;().score++;</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Enable gravity to make our ball fall.</span></div>
<div class="line">        rb.useGravity = <span class="keyword">true</span>;</div>
<div class="line">        inGame = <span class="keyword">false</span>;</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">The <b>Ball Model</b> object, which is a child to the <b>Ball</b>, includes colliders, unlike its parent. Let's create a new script <em>CollideChecker.cs</em>, in which we'll describe the behavior of our ball when it collides with other objects.</p>
<div class="fragment"><div class="line"><span class="keyword">using</span> UnityEngine;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">public</span> <span class="keyword">class </span>CollideChecker : MonoBehaviour </div>
<div class="line">{</div>
<div class="line">    <span class="keyword">private</span> <span class="keywordtype">void</span> OnCollisionEnter(Collision collision)</div>
<div class="line">    {</div>
<div class="line">        GetComponentInParent&lt;BallController&gt;().OnCollide(collision); <span class="comment">// If the ball touched any object, send this information to BallController, which is attached to a parenting object.</span></div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
Drag-and-drop the script to the <b>Ball Model</b>. </li>
<li>
<p class="startli">Drag-and-drop the <em>BallController.cs</em> script to the <b>Ball</b> and put the <b>Ball Model</b> to the <b>Ball</b> field.</p>
<div class="image">
<img src="UARCore_22.png" alt="UARCore_22.png"/>
</div>
 <p class="endli"></p>
</li>
<li>
Save the <b>Ball</b> as a prefab and delete it from the scene. After that define that the <b>Ball</b> will be automatically spawned on the server and on the client: <b>Network Manager - Network Manager (Script) → Spawn Info → Registered Spawnable Prefabs → Ball - Ball</b>. </li>
</ol>
<div class="image">
<img src="UARCore_23.png" alt="UARCore_23.png"/>
</div>
 <h1><a class="anchor" id="arcore_striker"></a>
Creating a Striker</h1>
<ol>
<li>
In Unity, let's create one more important player for our game - a striker: <b>Empty Object → Player</b>. </li>
<li>
<p class="startli">Create a new script called <em>PlayerController.cs</em>, in which we'll describe the actions of the striker. Add the <em>Networking</em> namespace to the script. Inherit the class from <em>NetworkBehaviour</em> so that it can send and receive the messages from the server. Create a field for the <em>ballPrefab</em>. Create a new method <em>Kick</em>, in which we'll set the start and end positions of the ball. This method is called on the server. To call the method on the server, add the <em>[Command]</em> attribute and the <em>Cmd</em> method prefix.</p>
<div class="fragment"><div class="line"><span class="keyword">using</span> UnityEngine;</div>
<div class="line"><span class="keyword">using</span> UnityEngine.Networking;</div>
<div class="line"></div>
<div class="line"><span class="keyword">public</span> <span class="keyword">class </span>PlayerController : NetworkBehaviour {</div>
<div class="line"></div>
<div class="line">    [SerializeField] GameObject ballPrefab;</div>
<div class="line"></div>
<div class="line">    [Command] </div>
<div class="line">    <span class="keywordtype">void</span> CmdKick(Vector3 startPos, Vector3 endPos)</div>
<div class="line">    {</div>
<div class="line">        GameObject ball = (GameObject)Instantiate(ballPrefab);</div>
<div class="line">        ball.GetComponent&lt;BallController&gt;().Setup(startPos, endPos);</div>
<div class="line">        NetworkServer.Spawn(ball);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keyword">public</span> <span class="keywordtype">void</span> Kick(Vector3 startPos, Vector3 endPos)</div>
<div class="line">    {</div>
<div class="line">        CmdKick(startPos, endPos);</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
Drag-and-drop <em>PlayerController.cs</em> to the <b>Player Controller</b> object and drag-and-drop the <b>Ball</b> to the <b>Ball Prefab</b> field. Save the <b>Player</b> object as a prefab and delete it from the scene. </li>
<li>
<p class="startli">Add the sending of a message on the ball kick to the server.</p>
<div class="fragment"><div class="line"><span class="keywordtype">bool</span> KickBall()</div>
<div class="line">{</div>
<div class="line">...</div>
<div class="line">    <span class="keywordflow">if</span> (Physics.Raycast(ray, out hitRay, 100) &amp;&amp; environment)</div>
<div class="line">    {</div>
<div class="line">...</div>
<div class="line"></div>
<div class="line">        FindObjectOfType&lt;PlayerController&gt;().Kick(mainCamera.transform.localPosition, environment.aim.transform.localPosition);</div>
<div class="line">...</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">Then select <b>NetworkManager → Network Manager (Script) → Spawn Info</b> and drag-and-drop <b>Player</b> to <b>Player Prefab</b> (please note that the <b>Player</b> prefab should have the <b>Network Identity</b> component).</p>
<div class="image">
<img src="UARCore_24.png" alt="UARCore_24.png"/>
</div>
 <p class="endli"></p>
</li>
<li>
Copy the <b>NetworkManager</b> object to the <b>GoalKeeper</b> scene. </li>
<li>
<p class="startli">On the <b>GoalKeeper</b> scene, untick <b>AutoCreatePlayer</b> in <b>Network Manager</b> so that a new player is not created in this scene - we need only one goalkeeper.</p>
<div class="image">
<img src="UARCore_25.png" alt="UARCore_25.png"/>
</div>
 <p class="endli"></p>
</li>
<li>
<p class="startli">Untick <b>Is Client</b> on the server.</p>
<div class="image">
<img src="UARCore_26.png" alt="UARCore_26.png"/>
</div>
 <p class="endli"></p>
</li>
<li>
<p class="startli">In <b>Network Manager</b>, select <b>Server</b> and set the fields for the scores and connection texts: <b>ScoreText - ScoreText (Text)</b>, <b>Connection Text - Connection Text (Text)</b>.</p>
<div class="image">
<img src="UARCore_27.png" alt="UARCore_27.png"/>
</div>
 <p class="endli"></p>
</li>
<li>
<p class="startli">Put the <b>Environment</b> prefab to the <b>Environment Prefab</b> field.</p>
<div class="image">
<img src="UARCore_28.png" alt="UARCore_28.png"/>
</div>
 <p class="endli"></p>
</li>
<li>
<p class="startli">To keep the size of the <b>Environment</b> on the server, add the following code to the <em>Start</em> method of the <em>Environment.cs</em> script:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> Start()</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span>(FindObjectOfType&lt;NetworkIdentity&gt;().isServer == <span class="keyword">false</span>)</div>
<div class="line">        transform.localScale = clientSize;</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">In <b>Build Settings</b>, untick <b>GoalKeeper</b> (as we don’t need it on the Android device)</p>
<div class="image">
<img src="UARCore_29.png" alt="UARCore_29.png"/>
</div>
 <p class="endli"></p>
</li>
<li>
<p class="startli">Go to <b>Player Settings → XR Settings</b> and untick <b>ARCore</b> (as it's not needed on TVico).</p>
<div class="image">
<img src="UARCore_30.png" alt="UARCore_30.png"/>
</div>
 <p class="endli"></p>
</li>
<li>
<p class="startli">Select the <b>Android version</b> as on TVico: <b>Other Settings → Android</b> (our version on TVico is 5.1.1).</p>
<div class="image">
<img src="UARCore_31.png" alt="UARCore_31.png"/>
</div>
 <p class="endli"></p>
</li>
<li>
Connect your TVico to your PC via USB, click <b>Build and Run</b> or just connect a compatible sensor to the desktop. </li>
<li>
Build the project in two stages: <ol>
<li>
First of all, build the <b>Striker</b> scene with ARCore on the Android device. </li>
<li>
Then, build the <b>GoalKeeper</b> scene without ARCore on the TVico or PC with a sensor. </li>
</ol>
</li>
</ol>
<p>Our project is almost ready: a "striker" user places the goal and goalkeeper on the grid and throws the ball. In his turn, the "goalkeeper" user tries to catch the ball using the TV screen / desktop.</p>
<div class="image">
<img src="UARCore_32.gif" alt="UARCore_32.gif"/>
</div>
 <p>However, at this stage the "striker" can notice that the goalkeeper's avatar does not move but somehow catches the ball. To eliminate this issue, we have to synchronize the server and client.</p>
<h1><a class="anchor" id="arcore_sync"></a>
Synchronizing the Server and Client</h1>
<ol>
<li>
<p class="startli">All right, it's time to write some more code to synchronize the movement of avatars. Create a new script, let's call it <em>AvatarSync.cs</em>.</p>
<dl class="section note"><dt>Note</dt><dd>As an alternative, you can synchronize the server and client without writing the script: just use 11 components (10 bones and the Avatar) of the Network Transform Child. We've synchronized the Ball using this way.</dd></dl>
</li>
<li>
<p class="startli">Add the <em>Networking</em> namespace and inherit the <em>AvatarSync</em> class from <em>NetworkBehaviour</em>. Add an array with bones and avatar transform that will be synchronized. When the rotation of bones and position of the avatar are changed, the server sends messages.</p>
<div class="fragment"><div class="line"><span class="keyword">using</span> System.Collections.Generic;</div>
<div class="line"><span class="keyword">using</span> UnityEngine;</div>
<div class="line"><span class="keyword">using</span> UnityEngine.Networking;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">public</span> <span class="keyword">class </span>AvatarSync : NetworkBehaviour </div>
<div class="line">{</div>
<div class="line">    [SerializeField] Transform[] syncBones;  </div>
<div class="line">    [SerializeField] Transform avatar;  </div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">[ClientRpc] <span class="comment">// Server sends a message to all clients.</span></div>
<div class="line"><span class="keyword">public</span> <span class="keywordtype">void</span> RpcOnBonesTransformUpdate(BonesInfoMessage boneMsg)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; boneMsg.bonesRot.Length; i++)</div>
<div class="line">    {</div>
<div class="line">        syncBones[i].localRotation = boneMsg.bonesRot[i];</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">    avatar.localPosition = boneMsg.avatarPos;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">public</span> <span class="keyword">class </span>BonesInfoMessage : MessageBase</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">public</span> Quaternion[] bonesRot;  <span class="comment">// Rotations of bones.</span></div>
<div class="line">    <span class="keyword">public</span> Vector3 avatarPos;  <span class="comment">// Avatar position.</span></div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">Check whether it is the server or not in the <em>FixedUpdate</em> method.</p>
<div class="fragment"><div class="line"><span class="keyword">private</span> <span class="keywordtype">void</span> FixedUpdate()</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (isServer)</div>
<div class="line">    {</div>
<div class="line">        BoneUpdate(syncBones);</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">Update the information about the bones and avatar and send a message.</p>
<div class="fragment"><div class="line"><span class="keyword">public</span> <span class="keywordtype">void</span> BoneUpdate(Transform[] bones)</div>
<div class="line">{</div>
<div class="line">    List&lt;Quaternion&gt; rotations = <span class="keyword">new</span> List&lt;Quaternion&gt;();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; bones.Length; i++)</div>
<div class="line">        rotations.Add(bones[i].localRotation);</div>
<div class="line"> </div>
<div class="line">    BonesInfoMessage msg = <span class="keyword">new</span> BonesInfoMessage</div>
<div class="line">    {</div>
<div class="line">        bonesRot = rotations.ToArray(), <span class="comment">// Rotations of bones.</span></div>
<div class="line">        avatarPos = avatar.position,</div>
<div class="line">    };</div>
<div class="line"> </div>
<div class="line">    RpcOnBonesTransformUpdate(msg); <span class="comment">// Sending the message. </span></div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
Drag-and-drop the script to the <b>Environment</b> prefab. </li>
<li>
<p class="startli">Put the <b>RiggedAvatar</b> object to the <b>Avatar</b> field. Fill in the <b>Sync Bones</b> array with the bones: you can find the bones on the <b>Rigged Avatar</b> object in the <b>Rigged Avatar</b> array: <b>Rigged Model → Model Joints</b> (all in all, you have to select 10 bones).</p>
<div class="image">
<img src="UARCore_33.png" alt="UARCore_33.png"/>
</div>
 <p class="endli"></p>
</li>
<li>
Run the project. Now everything is ready for play: the server and client are synchronized, avatars are moving and you're ready to have fun with your friends! </li>
</ol>
<div class="image">
<img src="UARCore_34.gif" alt="UARCore_34.gif"/>
</div>
  </div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="UnityTutorials_page.html">Unity Tutorials</a></li>
    <li class="footer">Generated on Thu Aug 22 2019 12:41:46 for Nuitrack by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.6 </li>
  </ul>
</div>
</body>
</html>
