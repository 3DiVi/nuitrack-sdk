<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>Nuitrack: Animating the Avatar using Skeleton</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen_html_style.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="nuitrack.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Nuitrack
   &#160;<span id="projectnumber">1.4.1</span>
   </div>
   <div id="projectbrief">3D Skeleton Tracking Middleware</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('UnityAnimation_page.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Properties</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Events</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(11)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Animating the Avatar using Skeleton </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#indirect_mapping">Indirect Mapping</a></li>
<li class="level1"><a href="#direct_mapping">Direct Mapping</a></li>
</ul>
</div>
<div class="textblock"><p>In this tutorial, you'll learn how to animate an avatar in Unity, employing the user's skeleton data. To do this, you need <b>Nuitrack SDK</b> and any supported sensor, as well as a mobile device (optional).<br/>
</p>
<p>You can animate an avatar by mapping the user's skeleton and model skeleton. There are two mapping types: direct and indirect.<br/>
</p>
<p>Using indirect mapping, you can animate both anthropomorphic and zoomorphic models. However, indirect mapping doesn't provide a sufficient depth of immersion in the game, as the user doesn't get the impression that the virtual body belongs to him. It's like you're running an avatar that just repeats your movements.<br/>
</p>
<p>Direct mapping is better suited for animating anthropomorphic models. This type of mapping ensures a greater depth of immersion in the game, since the proportions of the model are exactly the same as the user's proportions, and hence the movements are completely identical. However, direct mapping has one significant disadvantage, which is a possible deformation of the model, in case the proportions of the model and the user are significantly different.<br/>
</p>
<p>Let’s formulate the difference between direct and indirect mapping in a nutshell:<br/>
 </p>
<ul>
<li>
indirect mapping = orientation of joints </li>
<li>
direct mapping = orientation of joints + position of joints + scale of joints </li>
</ul>
<p>We’ll start with indirect mapping, as it’s a more simple way to animate your avatar, and proceed to the direct mapping, in case you want to achieve greater immersion in the game.</p>
<p>To create this project, you'll need just a couple of things: </p>
<ul>
<li>
Nuitrack Runtime and Nuitrack SDK </li>
<li>
Any supported sensor (see the complete list at <a href="https://nuitrack.com/">Nuitrack website</a>) </li>
<li>
Unity 2017.4 and higher </li>
</ul>
<p>You can find the finished project in <b>Nuitrack SDK</b>: <b>Unity 3D → NuitrackSDK.unitypackage → Tutorials → Avatar Animation</b></p>
<div class="image">
<img src="Uanim_image4.gif" alt="Uanim_image4.gif"/>
</div>
 <h1><a class="anchor" id="indirect_mapping"></a>
Indirect Mapping</h1>
<ol>
<li>
<p class="startli">In this example, we'll consider an anthropomorphic model, since the maximum number of joints in the Nuitrack is 19, which means that a model with a more complex skeleton would more difficult to adjust. Download the humanoid model from the Unity Asset Store (for example, <a href="https://assetstore.unity.com/packages/3d/characters/unity-chan-model-18705">Unity Chan Model</a>) and import it to the project. Put the model in T-pose for the correct matching of joints.</p>
<dl class="section note"><dt>Note</dt><dd>Import the <b>Plugins</b> and <b>Nuitrack</b> folders from the <b>Nuitrack SDK</b> to work with the sensor and retrieve information about users that have been identified by the sensor. Drag-and-drop the NuitrackScripts prefab to the scene.</dd></dl>
</li>
<li>
<p class="startli">Create an empty C# script and drag-and-drop it to the model.<br/>
 First of all, let's check the presence of the user in front of the sensor:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> Update()</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">if</span> (CurrentUserTracker.CurrentSkeleton != null) ProcessSkeleton(CurrentUserTracker.CurrentSkeleton);</div>
<div class="line">    }</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">If the user is identified, we move the the calculation of the model position. In indirect mapping, the position of the whole model is calculated using the torso joint position. The position is then rotated 180 degrees along the y axis, otherwise, the model will move in the opposite direction.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> ProcessSkeleton(nuitrack.Skeleton skeleton)    </div>
<div class="line">{    </div>
<div class="line">    Vector3 torsoPos = Quaternion.Euler(0f, 180f, 0f) * (0.001f * skeleton.GetJoint(nuitrack.JointType.Torso).ToVector3());</div>
<div class="line">    transform.position = torsoPos;</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">Build the project. (See the <b>Creating your First Unity Project using Nuitrack SDK (Android Only)</b> tutorial, <b>Setting up the Build</b> section). If everything was done correctly, the model will move according to the user's movements. At this point, the limbs of the model are not yet rotating.</p>
<div class="image">
<img src="Uanim_image1.gif" alt="Uanim_image1.gif"/>
</div>
 <p class="endli"></p>
</li>
<li>
<p class="startli">Create another empty C# script (<em>ModelJoint.cs</em>), in which we'll describe the ModelJoint class, which we'll use to process the model bones. Mark it as <em>[System.Serializable]</em> do that it is displayed in the Inspector.</p>
<div class="fragment"><div class="line"><span class="keyword">using</span> UnityEngine;</div>
<div class="line"></div>
<div class="line">[System.Serializable]</div>
<div class="line"><span class="keyword">class </span>ModelJoint</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">public</span> Transform bone;</div>
<div class="line">    <span class="keyword">public</span> nuitrack.JointType jointType;</div>
<div class="line">    [HideInInspector] <span class="keyword">public</span> Quaternion baseRotOffset;</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">In the script, create the list of joints. In the Inspector, check the required joints (to animate the model using Nuitrack and indirect mapping, we'll need 11 joints).</p>
<div class="fragment"><div class="line"><span class="keyword">using</span> UnityEngine;</div>
<div class="line"><span class="keyword">using</span> System.Collections.Generic;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">public</span> <span class="keyword">class </span>RiggedAvatar : MonoBehaviour</div>
<div class="line">{</div>
<div class="line">    [Header(<span class="stringliteral">&quot;Rigged model&quot;</span>)]</div>
<div class="line">    [SerializeField]</div>
<div class="line">    ModelJoint[] modelJoints;</div>
<div class="line">}</div>
</div><!-- fragment --><div class="image">
<img src="Uanim_image2.png" alt="Uanim_image2.png"/>
</div>
 <dl class="section note"><dt>Note</dt><dd>The skeleton of the model usually has two collarbones, just like a human. There are also two types of collarbones in the <em>JointType (LeftCollar, RightCollar)</em>. However, it should be noted that the skeleton retrieved from the sensor has only one "collarbone", which is located in the middle (as shown in the picture below).</dd></dl>
<div class="image">
<img src="Uanim_image3.jpg" alt="Uanim_image3.jpg"/>
</div>
 <p class="endli"></p>
</li>
<li>
<p class="startli">For convenience, create a dictionary and fill in the joints:</p>
<div class="fragment"><div class="line">Dictionary&lt;nuitrack.JointType, ModelJoint&gt; jointsRigged = <span class="keyword">new</span> Dictionary&lt;nuitrack.JointType, ModelJoint&gt;();</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">Then we loop over the joints from the modelJoints array and record the basic rotation of the model's bone. The joints of the model and their type (<em>jointType</em>) are added to the <em>jointsRigged</em> dictionary.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> Start()</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; modelJoints.Length; i++)</div>
<div class="line">    {</div>
<div class="line">        modelJoints[i].baseRotOffset = modelJoints[i].bone.rotation;</div>
<div class="line">        jointsRigged.Add(modelJoints[i].jointType, modelJoints[i]);</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">Then we get information about each joint from the Nuitrack. Calculate the rotation of the model bone: take the 'mirrored' joint orientation, add the base rotation of the model bone.</p>
<div class="fragment"><div class="line"><span class="keywordflow">foreach</span> (var riggedJoint <span class="keywordflow">in</span> jointsRigged)</div>
<div class="line">{</div>
<div class="line">    nuitrack.Joint joint = skeleton.GetJoint(riggedJoint.Key);</div>
<div class="line"></div>
<div class="line">    ModelJoint modelJoint = riggedJoint.Value;</div>
<div class="line"></div>
<div class="line">    Quaternion jointOrient = Quaternion.Inverse(CalibrationInfo.SensorOrientation) * (joint.ToQuaternionMirrored()) * modelJoint.baseRotOffset;</div>
<div class="line">    modelJoint.bone.rotation = jointOrient;</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">Check the movement of the whole model and rotation of its joints.</p>
<div class="image">
<img src="Uanim_image4.gif" alt="Uanim_image4.gif"/>
</div>
 <p class="endli"></p>
</li>
</ol>
<dl class="section note"><dt>Note</dt><dd>By default, the avatar directly repeats the user's movements (for example, when the user raises the right hand, the avatar raises its right hand, too). If you want to mirror the movements of the avatar, download the <a href="http://bit.ly/2Hxpuiv">MirrorFlipCamera script</a>, drag-and-drop it to the Unity camera, and put the <b>flipHorizontal</b> tick in the <b>Mirror Flip Camera (Script)</b> section in the <b>Inspector</b>.</dd></dl>
<h1><a class="anchor" id="direct_mapping"></a>
Direct Mapping</h1>
<ol>
<li>
<p class="startli">Since in direct mapping we consider the distance between the parent and the child joint, we need to change the <em>ModelJoint.cs</em> script by adding in the <em>ModelJoint</em> class the lines defining the type and transform of the parent joint and the distance between the parent and the child joint.</p>
<div class="fragment"><div class="line">...</div>
<div class="line">    <span class="keyword">public</span> nuitrack.JointType parentJointType;</div>
<div class="line">    [HideInInspector] <span class="keyword">public</span> Transform parentBone;</div>
<div class="line">    [HideInInspector] <span class="keyword">public</span> <span class="keywordtype">float</span> baseDistanceToParent;</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">Let's add some new information to the <b>RiggedAvatar.cs</b> script as well. Check the required joints in the Inspector. To animate the model using Nuitrack and direct mapping, we'll need 17 joints. As you can see, in direct mapping we use greater number of joints than in indirect mapping. The point is, in indirect mapping some joints were dependent on others and moved according to the hierarchy. In direct mapping, all the joints are independent, i.e. we have to specify the movement of each joint. Note: for direct mapping, we have to specify not only the types of joints that we need but also the 'parent' - 'child' relationship between all the joints.</p>
<div class="image">
<img src="Uanim_image5.jpg" alt="Uanim_image5.jpg"/>
</div>
 <p class="endli"></p>
</li>
<li>
<p class="startli">Since in direct mapping we need to know not only the position of the torso but also the positions of all other joints, we have to delete the lines defining the position of the torso, namely:</p>
<div class="fragment"><div class="line">Vector3 torsoPos = Quaternion.Euler(0f, 180f, 0f) * (0.001f * skeleton.GetJoint(nuitrack.JointType.Torso).ToVector3());</div>
<div class="line">transform.position = torsoPos;</div>
</div><!-- fragment --><p>After that, we need to add the lines, which define the position of each joint, to the foreach (var riggedJoint in jointsRigged) loop of the <em>void ProcessSkeleton(<a class="el" href="classnuitrack_1_1Skeleton.html" title="Stores the skeleton data. ">nuitrack.Skeleton</a> skeleton)</em> function:</p>
<div class="fragment"><div class="line">Vector3 newPos = Quaternion.Euler(0f, 180f, 0f) * (0.001f * joint.ToVector3());</div>
<div class="line">modelJoint.bone.position = newPos;</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">If you build the project at this point, the model's limbs may look disproportionate. To rectify this situation, let's define the basic distances between the child bone and its parent bone by using the AddBoneScale function, which should be located in the <em>void Start ()</em>.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> AddBoneScale(nuitrack.JointType targetJoint, nuitrack.JointType parentJoint)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// take the position of the model bone</span></div>
<div class="line">        Vector3 targetBonePos = jointsRigged[targetJoint].bone.position;</div>
<div class="line">        <span class="comment">// take the position of the model parent bone</span></div>
<div class="line">        Vector3 parentBonePos = jointsRigged[parentJoint].bone.position;</div>
<div class="line">        jointsRigged[targetJoint].baseDistanceToParent = Vector3.Distance(parentBonePos, targetBonePos);</div>
<div class="line">        <span class="comment">// record the Transform of the model parent bone</span></div>
<div class="line">        jointsRigged[targetJoint].parentBone = jointsRigged[parentJoint].bone;</div>
<div class="line">        <span class="comment">// extract the parent bone from the hierarchy to make it independent</span></div>
<div class="line">        jointsRigged[targetJoint].parentBone.parent = transform.root;</div>
<div class="line">    }</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">Then, let's perform bone scaling. By default, the bone scale is equal to (1,1,1). It changes dynamically in accordance with the user's proportions. Add the <em>void ProcessSkeleton(<a class="el" href="classnuitrack_1_1Skeleton.html" title="Stores the skeleton data. ">nuitrack.Skeleton</a> skeleton)</em> function:</p>
<div class="fragment"><div class="line"><span class="keywordflow">if</span> (modelJoint.parentBone != null)</div>
<div class="line">            {</div>
<div class="line">                <span class="comment">// take the Transform of the parent bone</span></div>
<div class="line">                Transform parentBone = modelJoint.parentBone;</div>
<div class="line">                <span class="comment">// calculate how many times the distance between the child bone and its parent bone has changed compared to the base distance (which was recorded at the start)</span></div>
<div class="line">                <span class="keywordtype">float</span> scaleDif = modelJoint.baseDistanceToParent / Vector3.Distance(newPos, parentBone.position);</div>
<div class="line">                <span class="comment">// change the size of the bone to the resulting value</span></div>
<div class="line">                parentBone.localScale = Vector3.one / scaleDif;</div>
<div class="line">            }</div>
</div><!-- fragment --><dl class="section note"><dt>Note</dt><dd>The deformation of the model may be greater than expected. To avoid this, make sure that the proportions of the model are close to the user's proportions.</dd></dl>
</li>
<li>
Build the project. The model should look proportionally and move. </li>
</ol>
<div class="image">
<img src="Uanim_image6.gif" alt="Uanim_image6.gif"/>
</div>
 <dl class="section note"><dt>Note</dt><dd>For testing, a mobile device is not necessary. You can test the project even if there is only a computer and a sensor. The app will run in the Unity. </dd></dl>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="UnityTutorials_page.html">Unity Tutorials</a></li>
    <li class="footer">Generated on Thu Aug 22 2019 12:41:45 for Nuitrack by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.6 </li>
  </ul>
</div>
</body>
</html>
